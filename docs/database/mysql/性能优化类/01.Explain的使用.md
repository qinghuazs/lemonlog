---
title: explain用法
date: 2025-09-02
permalink: /mysql/explain.html
tags: ['MySQL']
categories:
 - MySQL
--- 

## EXPLAIN 是什么

EXPLAIN 是 MySQL 提供的一个强大的查询分析工具，用于显示 MySQL 如何执行 SELECT 语句。它可以帮助开发者了解查询的执行计划，包括表的读取顺序、使用的索引、连接类型等关键信息。

EXPLAIN 本质上是一个查询优化器的输出，它展示了 MySQL 优化器选择的最佳执行路径。通过分析 EXPLAIN 的输出结果，我们可以识别查询性能瓶颈，优化 SQL 语句和数据库结构。

## 如何使用 EXPLAIN

### 基本语法

```sql
EXPLAIN [EXTENDED | PARTITIONS | FORMAT = {TRADITIONAL | JSON | TREE}] 
SELECT statement;
```

### 使用示例

#### 基本用法
```sql
explain
select * from gps_data where vehicle_id = 'V0002';
```

#### 分析 JOIN 查询
```sql
explain
select * from gps_data g
join vehicle_info v on g.vehicle_id = v.vehicle_id
where g.vehicle_id = 'V0002' and v.driver_name = '李四';
```

#### 使用 JSON 格式输出
```sql
explain FORMAT = JSON
select * from gps_data where vehicle_id = 'V0002' order by gps_time desc;
```

#### 分析子查询
```sql
explain
select * from gps_data
where vehicle_id in (
    select vehicle_id from vehicle_info where driver_name like '李%'
);
```

### EXPLAIN 输出内容

EXPLAIN 的输出包含以下主要字段：

![](https://i.imgur.com/BefmAHe.png)

## select_type

`select_type` 字段表示查询的类型，帮助理解查询的复杂度和执行方式。

![](https://i.imgur.com/B84L76H.png)

## type

`type` 字段表示 MySQL 访问表的方式，是性能分析的关键指标。按性能从好到差排序：

![](https://i.imgur.com/vzIfk1o.png)

index 和 all 都是需要优化的，其他的 type 看情况进行优化。

## key_len 字段详解

`key_len` 表示 MySQL 使用索引的字节长度。这个值帮助判断：

- 复合索引使用了多少个字段
- 索引的使用效率
- 是否存在索引浪费

> 这个字段一般可以不关注

### key_len 的计算规则

#### MySQL 数据类型字节长度对照表

| 数据类型 | 类别 | 字节长度 |
|---------|------|----------|
| `TINYINT` | 数值类型 | 1 字节 |
| `SMALLINT` | 数值类型 | 2 字节 |
| `MEDIUMINT` | 数值类型 | 3 字节 |
| `INT` | 数值类型 | 4 字节 |
| `BIGINT` | 数值类型 | 8 字节 |
| `FLOAT` | 数值类型 | 4 字节 |
| `DOUBLE` | 数值类型 | 8 字节 |
| `DECIMAL(M,D)` | 数值类型 | M+2 字节 |
| `CHAR(n)` | 字符串类型 | n * 字符集字节数 |
| `VARCHAR(n)` | 字符串类型 | n * 字符集字节数 + 2（长度信息） |
| `TEXT` | 字符串类型 | 变长，取决于实际长度 |
| `DATE` | 时间类型 | 3 字节 |
| `TIME` | 时间类型 | 3 字节 |
| `DATETIME` | 时间类型 | 8 字节 |
| `TIMESTAMP` | 时间类型 | 4 字节 |
| `YEAR` | 时间类型 | 1 字节 |

#### NULL 值处理
如果字段允许 NULL，需要额外 1 字节存储 NULL 标识。

### key_len 分析示例

```sql
-- 假设有复合索引 (name, age, city)
-- name VARCHAR(50), age INT, city VARCHAR(30)
-- 字符集为 utf8mb4 (4字节/字符)

-- 查询1：只使用 name
EXPLAIN SELECT * FROM users WHERE name = 'John';
-- key_len = 50 * 4 + 2 + 1 = 203 (VARCHAR + 长度 + NULL标识)

-- 查询2：使用 name 和 age
EXPLAIN SELECT * FROM users WHERE name = 'John' AND age = 25;
-- key_len = 203 + 4 + 1 = 208 (name + age + age的NULL标识)

-- 查询3：使用全部字段
EXPLAIN SELECT * FROM users WHERE name = 'John' AND age = 25 AND city = 'Beijing';
-- key_len = 203 + 5 + 30 * 4 + 2 + 1 = 331
```

## ref

`ref` 字段显示哪些列或常量被用于查找索引列上的值。它帮助理解索引的引用方式和连接条件。

![](https://i.imgur.com/N6nlQtI.png)


### ref 分析示例

```sql
-- 示例表结构
CREATE TABLE users (id INT PRIMARY KEY, name VARCHAR(50), dept_id INT);
CREATE TABLE departments (id INT PRIMARY KEY, name VARCHAR(50));

-- 查询1：常量引用
EXPLAIN SELECT * FROM users WHERE id = 100;
-- ref: const

-- 查询2：表连接
EXPLAIN SELECT u.name, d.name 
FROM users u 
JOIN departments d ON u.dept_id = d.id;
-- ref: database.users.dept_id (在 departments 表的访问中)

-- 查询3：函数引用
EXPLAIN SELECT * FROM users WHERE id = LAST_INSERT_ID();
-- ref: func
```

### ref 优化建议

常量引用性能最好，在使用 JOIN 条件时，确保 JOIN 条件使用索引；另外注意函数引用，可能影响性能。

NULL 可能表示没有有效的索引使用，需要进行优化。

## Extra

`Extra` 字段提供了查询执行的额外信息，是性能优化的重要参考。它可能包含多个值，用分号分隔。

![](https://i.imgur.com/MBIddmD.png)

Extra 包含 Using temporary 或 Using filesort 时，优先进行优化。


