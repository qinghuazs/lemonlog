---
title: Docker安装Redis
date: 2025-07-23
permalink: /docker/redis
---

## 基本安装步骤

### 1. 拉取Redis镜像

```bash
# 拉取最新版本的Redis镜像
docker pull redis:latest

# 或者拉取指定版本
docker pull redis:7.2
```

### 2. 运行Redis容器

#### 简单运行（默认配置）

```bash
# 基本运行命令
docker run --name my-redis -d redis:latest

# 带端口映射的运行
docker run --name my-redis -p 6379:6379 -d redis:latest
```

#### 带密码保护的运行

```bash
# 设置Redis密码
docker run --name my-redis -p 6379:6379 -d redis:latest redis-server --requirepass "your_password"
```

#### 持久化数据运行

```bash
# 创建数据卷
docker volume create redis-data

# 运行带数据持久化的Redis
docker run --name my-redis \
  -p 6379:6379 \
  -v redis-data:/data \
  -d redis:latest redis-server --appendonly yes
```

### 3. 使用自定义配置文件

#### 创建Redis配置文件

```bash
# 创建配置目录
mkdir -p /path/to/redis/conf

# 创建redis.conf文件
cat > /path/to/redis/conf/redis.conf << EOF
# Redis配置文件
bind 0.0.0.0
port 6379
requirepass your_password
appendonly yes
appendfsync everysec
maxmemory 256mb
maxmemory-policy allkeys-lru
EOF
```

#### 使用配置文件运行

```bash
docker run --name my-redis \
  -p 6379:6379 \
  -v /path/to/redis/conf/redis.conf:/usr/local/etc/redis/redis.conf \
  -v redis-data:/data \
  -d redis:latest redis-server /usr/local/etc/redis/redis.conf
```

## Docker Compose方式部署

### 创建docker-compose.yml文件

```yaml
version: '3.8'

services:
  redis:
    image: redis:7.2
    container_name: my-redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
      - ./redis.conf:/usr/local/etc/redis/redis.conf
    command: redis-server /usr/local/etc/redis/redis.conf
    environment:
      - REDIS_PASSWORD=your_password
    networks:
      - redis-network

volumes:
  redis-data:
    driver: local

networks:
  redis-network:
    driver: bridge
```

### 启动服务

```bash
# 启动Redis服务
docker-compose up -d

# 查看服务状态
docker-compose ps

# 查看日志
docker-compose logs redis
```

## 连接和测试Redis

### 使用Redis CLI连接

```bash
# 进入Redis容器
docker exec -it my-redis redis-cli

# 如果设置了密码
docker exec -it my-redis redis-cli -a your_password

# 测试连接
redis-cli> ping
PONG

# 设置和获取数据
redis-cli> set test "Hello Redis"
OK
redis-cli> get test
"Hello Redis"
```

### 从外部连接

```bash
# 使用本地Redis CLI连接
redis-cli -h localhost -p 6379 -a your_password

# 或者使用Docker运行临时Redis CLI
docker run -it --rm redis:latest redis-cli -h host.docker.internal -p 6379 -a your_password
```

## 常见问题与解决方案

### 1. 端口占用问题

**问题描述：** 启动容器时提示端口6379已被占用

**解决方案：**
```bash
# 查看端口占用情况
lsof -i :6379
netstat -tulpn | grep 6379

# 停止占用端口的进程
sudo kill -9 <PID>

# 或者使用不同的端口
docker run --name my-redis -p 6380:6379 -d redis:latest
```

### 2. 数据持久化问题

**问题描述：** 容器重启后数据丢失

**解决方案：**
```bash
# 确保使用数据卷
docker run --name my-redis \
  -p 6379:6379 \
  -v redis-data:/data \
  -d redis:latest redis-server --appendonly yes

# 检查数据卷
docker volume ls
docker volume inspect redis-data
```

### 3. 内存不足问题

**问题描述：** Redis容器因内存不足被杀死

**解决方案：**
```bash
# 设置内存限制
docker run --name my-redis \
  -p 6379:6379 \
  -m 512m \
  -d redis:latest redis-server --maxmemory 256mb --maxmemory-policy allkeys-lru

# 在redis.conf中配置
maxmemory 256mb
maxmemory-policy allkeys-lru
```

### 4. 连接被拒绝问题

**问题描述：** 无法连接到Redis服务

**解决方案：**
```bash
# 检查容器状态
docker ps -a
docker logs my-redis

# 检查网络连接
docker exec -it my-redis netstat -tulpn

# 确保bind配置正确
# 在redis.conf中设置
bind 0.0.0.0
# 或者
bind 127.0.0.1 0.0.0.0
```

### 5. 权限问题

**问题描述：** 配置文件或数据目录权限不足

**解决方案：**
```bash
# 修改文件权限
sudo chown -R 999:999 /path/to/redis/data
sudo chmod -R 755 /path/to/redis/conf

# 或者在运行时指定用户
docker run --name my-redis \
  --user 999:999 \
  -p 6379:6379 \
  -v redis-data:/data \
  -d redis:latest
```

### 6. 配置文件加载失败

**问题描述：** 自定义配置文件无法加载

**解决方案：**
```bash
# 检查配置文件路径和格式
docker exec -it my-redis cat /usr/local/etc/redis/redis.conf

# 验证配置文件语法
redis-server /path/to/redis.conf --test-config

# 确保配置文件挂载正确
docker inspect my-redis | grep -A 10 "Mounts"
```

### 7. 性能优化问题

**问题描述：** Redis性能不佳

**解决方案：**
```bash
# 优化配置参数
# 在redis.conf中添加
tcp-keepalive 300
timeout 0
tcp-backlog 511

# 禁用透明大页
echo never > /sys/kernel/mm/transparent_hugepage/enabled

# 调整系统参数
echo 'vm.overcommit_memory = 1' >> /etc/sysctl.conf
sysctl vm.overcommit_memory=1
```

## 监控和维护

### 查看Redis信息

```bash
# 查看Redis服务器信息
docker exec -it my-redis redis-cli info

# 查看内存使用情况
docker exec -it my-redis redis-cli info memory

# 查看连接数
docker exec -it my-redis redis-cli info clients
```

### 备份和恢复

```bash
# 创建备份
docker exec my-redis redis-cli BGSAVE

# 复制备份文件
docker cp my-redis:/data/dump.rdb ./backup/

# 恢复数据（停止容器后替换数据文件）
docker stop my-redis
docker cp ./backup/dump.rdb my-redis:/data/
docker start my-redis
```

### 日志管理

```bash
# 查看容器日志
docker logs my-redis

# 实时查看日志
docker logs -f my-redis

# 限制日志大小
docker run --name my-redis \
  --log-driver json-file \
  --log-opt max-size=10m \
  --log-opt max-file=3 \
  -p 6379:6379 \
  -d redis:latest
```

## 安全建议

1. **设置强密码**：使用复杂的密码保护Redis实例
2. **网络隔离**：使用Docker网络限制访问
3. **禁用危险命令**：在配置文件中禁用FLUSHDB、FLUSHALL等命令
4. **定期备份**：建立定期备份机制
5. **监控访问**：监控异常访问和操作

```bash
# 禁用危险命令示例
rename-command FLUSHDB ""
rename-command FLUSHALL ""
rename-command KEYS ""
rename-command CONFIG "CONFIG_9a90f2b4c2d3e5f6"
```