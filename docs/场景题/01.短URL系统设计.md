# çŸ­URLç³»ç»Ÿè®¾è®¡æ–‡æ¡£

## 1. äº§å“æ¦‚è¿°

çŸ­URLç³»ç»Ÿæ˜¯ä¸€ä¸ªå°†é•¿URLè½¬æ¢ä¸ºçŸ­URLçš„åœ¨çº¿æœåŠ¡ï¼Œç”¨æˆ·å¯ä»¥é€šè¿‡çŸ­URLå¿«é€Ÿè®¿é—®åŸå§‹é•¿URLï¼ŒåŒæ—¶æä¾›è®¿é—®ç»Ÿè®¡å’Œç®¡ç†åŠŸèƒ½ã€‚
- è§£å†³é•¿URLåœ¨ç¤¾äº¤åª’ä½“ã€çŸ­ä¿¡ç­‰åœºæ™¯ä¸­ä¸ä¾¿åˆ†äº«çš„é—®é¢˜ï¼Œä¸ºä¸ªäººç”¨æˆ·ã€ä¼ä¸šè¥é”€äººå‘˜å’Œå¼€å‘è€…æä¾›ä¾¿æ·çš„é“¾æ¥ç®¡ç†æœåŠ¡ã€‚
- ç›®æ ‡æˆä¸ºç±»ä¼¼bit.lyã€tinyurlç­‰ä¸»æµçŸ­é“¾æœåŠ¡çš„ç«äº‰äº§å“ï¼ŒæœåŠ¡ç™¾ä¸‡çº§ç”¨æˆ·çš„é“¾æ¥ç¼©çŸ­éœ€æ±‚ã€‚

## 2. æ ¸å¿ƒåŠŸèƒ½

### 2.1 ç”¨æˆ·è§’è‰²

| è§’è‰² | æ³¨å†Œæ–¹å¼ | æ ¸å¿ƒæƒé™ |
|------|----------|----------|
| æ¸¸å®¢ç”¨æˆ· | æ— éœ€æ³¨å†Œ | å¯åˆ›å»ºä¸´æ—¶çŸ­é“¾ï¼Œæœ‰æ•ˆæœŸ7å¤©ï¼Œæ— ç»Ÿè®¡åŠŸèƒ½ |
| æ³¨å†Œç”¨æˆ· | é‚®ç®±æ³¨å†Œ | å¯åˆ›å»ºæ°¸ä¹…çŸ­é“¾ï¼ŒæŸ¥çœ‹è®¿é—®ç»Ÿè®¡ï¼Œç®¡ç†é“¾æ¥ |
| é«˜çº§ç”¨æˆ· | ä»˜è´¹å‡çº§ | è‡ªå®šä¹‰çŸ­é“¾åç¼€ï¼Œé«˜çº§ç»Ÿè®¡åˆ†æï¼Œæ‰¹é‡æ“ä½œ |

### 2.2 åŠŸèƒ½æ¨¡å—

æˆ‘ä»¬çš„çŸ­URLç³»ç»ŸåŒ…å«ä»¥ä¸‹ä¸»è¦é¡µé¢ï¼š
1. **é¦–é¡µ**ï¼šURLè¾“å…¥æ¡†ã€çŸ­é“¾ç”Ÿæˆã€åŠŸèƒ½ä»‹ç»
2. **é“¾æ¥ç®¡ç†é¡µ**ï¼šé“¾æ¥åˆ—è¡¨ã€ç¼–è¾‘åˆ é™¤ã€æ‰¹é‡æ“ä½œ
3. **ç»Ÿè®¡åˆ†æé¡µ**ï¼šè®¿é—®æ•°æ®ã€å›¾è¡¨å±•ç¤ºã€å¯¼å‡ºåŠŸèƒ½
4. **ç”¨æˆ·ä¸­å¿ƒé¡µ**ï¼šè´¦æˆ·ä¿¡æ¯ã€å¥—é¤ç®¡ç†ã€APIå¯†é’¥
5. **çŸ­é“¾é‡å®šå‘é¡µ**ï¼šURLè§£æã€è®¿é—®è®°å½•ã€è·³è½¬å¤„ç†

### 2.3 é¡µé¢è¯¦æƒ…

| é¡µé¢åç§° | æ¨¡å—åç§° | åŠŸèƒ½æè¿° |
|----------|----------|----------|
| é¦–é¡µ | URLè¾“å…¥æ¨¡å— | è¾“å…¥é•¿URLï¼ŒéªŒè¯URLæ ¼å¼ï¼Œç”ŸæˆçŸ­é“¾æ¥ |
| é¦–é¡µ | çŸ­é“¾å±•ç¤ºæ¨¡å— | æ˜¾ç¤ºç”Ÿæˆçš„çŸ­é“¾ï¼Œæä¾›å¤åˆ¶åŠŸèƒ½ï¼Œæ˜¾ç¤ºäºŒç»´ç  |
| é¦–é¡µ | åŠŸèƒ½ä»‹ç»æ¨¡å— | å±•ç¤ºäº§å“ç‰¹æ€§ï¼Œç”¨æˆ·æ³¨å†Œå¼•å¯¼ï¼Œä»·æ ¼æ–¹æ¡ˆ |
| é“¾æ¥ç®¡ç†é¡µ | é“¾æ¥åˆ—è¡¨æ¨¡å— | æ˜¾ç¤ºç”¨æˆ·åˆ›å»ºçš„æ‰€æœ‰çŸ­é“¾ï¼Œæ”¯æŒæœç´¢å’Œç­›é€‰ |
| é“¾æ¥ç®¡ç†é¡µ | é“¾æ¥æ“ä½œæ¨¡å— | ç¼–è¾‘é“¾æ¥æ ‡é¢˜ï¼Œåˆ é™¤é“¾æ¥ï¼Œæ‰¹é‡ç®¡ç†æ“ä½œ |
| é“¾æ¥ç®¡ç†é¡µ | è‡ªå®šä¹‰çŸ­é“¾æ¨¡å— | è®¾ç½®è‡ªå®šä¹‰åç¼€ï¼Œæ£€æŸ¥å¯ç”¨æ€§ï¼Œä¿å­˜è®¾ç½® |
| ç»Ÿè®¡åˆ†æé¡µ | æ•°æ®æ¦‚è§ˆæ¨¡å— | æ˜¾ç¤ºæ€»ç‚¹å‡»æ•°ï¼Œä»Šæ—¥è®¿é—®ï¼Œçƒ­é—¨é“¾æ¥æ’è¡Œ |
| ç»Ÿè®¡åˆ†æé¡µ | å›¾è¡¨åˆ†ææ¨¡å— | è®¿é—®è¶‹åŠ¿å›¾ï¼Œåœ°ç†åˆ†å¸ƒï¼Œè®¾å¤‡ç»Ÿè®¡ï¼Œæ¥æºåˆ†æ |
| ç»Ÿè®¡åˆ†æé¡µ | æ•°æ®å¯¼å‡ºæ¨¡å— | é€‰æ‹©æ—¶é—´èŒƒå›´ï¼Œå¯¼å‡ºCSV/Excelæ ¼å¼æ•°æ® |
| ç”¨æˆ·ä¸­å¿ƒé¡µ | è´¦æˆ·ä¿¡æ¯æ¨¡å— | ä¿®æ”¹ä¸ªäººä¿¡æ¯ï¼Œæ›´æ”¹å¯†ç ï¼Œè´¦æˆ·å®‰å…¨è®¾ç½® |
| ç”¨æˆ·ä¸­å¿ƒé¡µ | å¥—é¤ç®¡ç†æ¨¡å— | æŸ¥çœ‹å½“å‰å¥—é¤ï¼Œå‡çº§ä»˜è´¹ç‰ˆï¼Œä½¿ç”¨é‡ç»Ÿè®¡ |
| ç”¨æˆ·ä¸­å¿ƒé¡µ | APIç®¡ç†æ¨¡å— | ç”ŸæˆAPIå¯†é’¥ï¼ŒæŸ¥çœ‹APIæ–‡æ¡£ï¼Œè°ƒç”¨æ¬¡æ•°ç»Ÿè®¡ |
| çŸ­é“¾é‡å®šå‘é¡µ | URLè§£ææ¨¡å— | æ ¹æ®çŸ­é“¾æŸ¥æ‰¾åŸå§‹URLï¼ŒéªŒè¯é“¾æ¥æœ‰æ•ˆæ€§ |
| çŸ­é“¾é‡å®šå‘é¡µ | è®¿é—®è®°å½•æ¨¡å— | è®°å½•è®¿é—®æ—¶é—´ï¼ŒIPåœ°å€ï¼Œç”¨æˆ·ä»£ç†ï¼Œæ¥æºé¡µé¢ |
| çŸ­é“¾é‡å®šå‘é¡µ | è·³è½¬å¤„ç†æ¨¡å— | æ‰§è¡Œ302é‡å®šå‘ï¼Œå¤„ç†å¤±æ•ˆé“¾æ¥ï¼Œæ˜¾ç¤ºé”™è¯¯é¡µé¢ |

## 3. æ ¸å¿ƒæµç¨‹

**æ¸¸å®¢ç”¨æˆ·æµç¨‹ï¼š**
ç”¨æˆ·è®¿é—®é¦–é¡µ â†’ è¾“å…¥é•¿URL â†’ ç³»ç»Ÿç”ŸæˆçŸ­é“¾ â†’ ç”¨æˆ·å¤åˆ¶ä½¿ç”¨çŸ­é“¾ â†’ è®¿é—®è€…ç‚¹å‡»çŸ­é“¾ â†’ ç³»ç»Ÿé‡å®šå‘åˆ°åŸå§‹URL

**æ³¨å†Œç”¨æˆ·æµç¨‹ï¼š**
ç”¨æˆ·æ³¨å†Œç™»å½• â†’ åˆ›å»ºçŸ­é“¾ â†’ ç®¡ç†é“¾æ¥åˆ—è¡¨ â†’ æŸ¥çœ‹è®¿é—®ç»Ÿè®¡ â†’ è‡ªå®šä¹‰çŸ­é“¾åç¼€ â†’ å¯¼å‡ºç»Ÿè®¡æ•°æ®

**é«˜çº§ç”¨æˆ·æµç¨‹ï¼š**
ä»˜è´¹ç”¨æˆ·ç™»å½• â†’ æ‰¹é‡åˆ›å»ºçŸ­é“¾ â†’ è®¾ç½®è‡ªå®šä¹‰åŸŸå â†’ æŸ¥çœ‹é«˜çº§ç»Ÿè®¡ â†’ ä½¿ç”¨APIæ¥å£ â†’ ç®¡ç†å›¢é˜Ÿæƒé™

```mermaid
graph TD
    A[é¦–é¡µ] --> B[é“¾æ¥ç®¡ç†é¡µ]
    A --> C[ç”¨æˆ·ä¸­å¿ƒé¡µ]
    B --> D[ç»Ÿè®¡åˆ†æé¡µ]
    C --> D
    A --> E[çŸ­é“¾é‡å®šå‘é¡µ]
    B --> E
```

## 4. ç”¨æˆ·ç•Œé¢è®¾è®¡

### 4.1 è®¾è®¡é£æ ¼

- **ä¸»è‰²è°ƒ**ï¼šè“è‰²(#2563EB)ä½œä¸ºä¸»è‰²ï¼Œç™½è‰²(#FFFFFF)ä½œä¸ºèƒŒæ™¯è‰²
- **è¾…åŠ©è‰²**ï¼šç°è‰²(#6B7280)ç”¨äºæ¬¡è¦æ–‡æœ¬ï¼Œç»¿è‰²(#10B981)ç”¨äºæˆåŠŸçŠ¶æ€
- **æŒ‰é’®æ ·å¼**ï¼šåœ†è§’çŸ©å½¢æŒ‰é’®ï¼Œæ‚¬åœæ—¶æœ‰é˜´å½±æ•ˆæœ
- **å­—ä½“**ï¼šä¸­æ–‡ä½¿ç”¨è‹¹æ–¹/å¾®è½¯é›…é»‘ï¼Œè‹±æ–‡ä½¿ç”¨Inter/Robotoï¼Œä¸»è¦å­—å·16px
- **å¸ƒå±€é£æ ¼**ï¼šå¡ç‰‡å¼è®¾è®¡ï¼Œé¡¶éƒ¨å¯¼èˆªæ ï¼Œå“åº”å¼ç½‘æ ¼å¸ƒå±€
- **å›¾æ ‡é£æ ¼**ï¼šçº¿æ€§å›¾æ ‡é£æ ¼ï¼Œç»Ÿä¸€ä½¿ç”¨Heroiconså›¾æ ‡åº“

### 4.2 é¡µé¢è®¾è®¡æ¦‚è§ˆ

| é¡µé¢åç§° | æ¨¡å—åç§° | UIå…ƒç´  |
|----------|----------|--------|
| é¦–é¡µ | URLè¾“å…¥æ¨¡å— | å¤§å°ºå¯¸è¾“å…¥æ¡†ï¼Œè“è‰²æ¸å˜èƒŒæ™¯ï¼Œå±…ä¸­å¸ƒå±€ï¼Œ"ç”ŸæˆçŸ­é“¾"æŒ‰é’® |
| é¦–é¡µ | çŸ­é“¾å±•ç¤ºæ¨¡å— | å¡ç‰‡å®¹å™¨ï¼ŒçŸ­é“¾æ–‡æœ¬æ¡†ï¼Œå¤åˆ¶æŒ‰é’®ï¼ŒäºŒç»´ç å›¾æ ‡ï¼Œåˆ†äº«æŒ‰é’®ç»„ |
| é“¾æ¥ç®¡ç†é¡µ | é“¾æ¥åˆ—è¡¨æ¨¡å— | è¡¨æ ¼å¸ƒå±€ï¼Œåˆ†é¡µç»„ä»¶ï¼Œæœç´¢æ¡†ï¼Œç­›é€‰ä¸‹æ‹‰èœå•ï¼Œæ“ä½œæŒ‰é’®ç»„ |
| ç»Ÿè®¡åˆ†æé¡µ | å›¾è¡¨åˆ†ææ¨¡å— | Chart.jså›¾è¡¨ï¼Œæ•°æ®å¡ç‰‡ï¼Œæ—¶é—´é€‰æ‹©å™¨ï¼Œé¢œè‰²ç¼–ç å›¾ä¾‹ |
| ç”¨æˆ·ä¸­å¿ƒé¡µ | è´¦æˆ·ä¿¡æ¯æ¨¡å— | è¡¨å•å¸ƒå±€ï¼Œå¤´åƒä¸Šä¼ ï¼Œè¾“å…¥éªŒè¯ï¼Œä¿å­˜æŒ‰é’®ï¼Œå®‰å…¨å¾½ç«  |
| çŸ­é“¾é‡å®šå‘é¡µ | è·³è½¬å¤„ç†æ¨¡å— | åŠ è½½åŠ¨ç”»ï¼Œå€’è®¡æ—¶æ˜¾ç¤ºï¼Œé”™è¯¯æç¤ºé¡µé¢ï¼Œé‡è¯•æŒ‰é’® |

### 4.3 å“åº”å¼è®¾è®¡

ç³»ç»Ÿé‡‡ç”¨ç§»åŠ¨ä¼˜å…ˆçš„å“åº”å¼è®¾è®¡ï¼Œæ”¯æŒæ¡Œé¢ç«¯ã€å¹³æ¿å’Œæ‰‹æœºç«¯è®¿é—®ï¼Œé’ˆå¯¹è§¦å±è®¾å¤‡ä¼˜åŒ–æŒ‰é’®å¤§å°å’Œäº¤äº’ä½“éªŒã€‚

## 5. åŠŸèƒ½æ€§éœ€æ±‚è¯¦ç»†åˆ†æ

### 5.1 URLç¼©çŸ­åŠŸèƒ½
- **è¾“å…¥éªŒè¯**ï¼šæ”¯æŒHTTP/HTTPSåè®®ï¼ŒéªŒè¯URLæ ¼å¼åˆæ³•æ€§ï¼Œæ£€æµ‹æ¶æ„é“¾æ¥
- **çŸ­é“¾ç”Ÿæˆ**ï¼šä½¿ç”¨Base62ç¼–ç ç®—æ³•ï¼Œç”Ÿæˆ6-8ä½çŸ­é“¾æ ‡è¯†ç¬¦
- **é‡å¤å¤„ç†**ï¼šç›¸åŒURLç”Ÿæˆç›¸åŒçŸ­é“¾ï¼Œé¿å…é‡å¤å­˜å‚¨
- **è‡ªå®šä¹‰çŸ­é“¾**ï¼šé«˜çº§ç”¨æˆ·å¯è‡ªå®šä¹‰çŸ­é“¾åç¼€ï¼Œæ£€æŸ¥å”¯ä¸€æ€§
- **æœ‰æ•ˆæœŸç®¡ç†**ï¼šæ”¯æŒè®¾ç½®é“¾æ¥è¿‡æœŸæ—¶é—´ï¼Œè‡ªåŠ¨æ£€æµ‹å’Œå¤„ç†è¿‡æœŸé“¾æ¥

## 5.3 é“¾æ¥æœ‰æ•ˆæœŸç®¡ç†ç³»ç»Ÿ

### 5.3.1 åŠŸèƒ½æ¦‚è¿°

é“¾æ¥æœ‰æ•ˆæœŸç®¡ç†æ˜¯çŸ­URLç³»ç»Ÿçš„é‡è¦ç»„æˆéƒ¨åˆ†ï¼Œä¸»è¦åŒ…æ‹¬ï¼š
- **è¿‡æœŸæ—¶é—´è®¾ç½®**ï¼šæ”¯æŒæ°¸ä¹…ã€è‡ªå®šä¹‰æ—¶é—´ã€ç›¸å¯¹æ—¶é—´ç­‰å¤šç§è¿‡æœŸç­–ç•¥
- **å®æ—¶è¿‡æœŸæ£€æµ‹**ï¼šè®¿é—®æ—¶å®æ—¶æ£€æŸ¥é“¾æ¥æ˜¯å¦è¿‡æœŸ
- **å®šæ—¶æ¸…ç†ä»»åŠ¡**ï¼šæ‰¹é‡å¤„ç†è¿‡æœŸé“¾æ¥ï¼Œé‡Šæ”¾å­˜å‚¨ç©ºé—´
- **å‹å¥½é”™è¯¯é¡µé¢**ï¼šä¸ºè¿‡æœŸé“¾æ¥æä¾›ç¾è§‚ã€æœ‰ç”¨çš„é”™è¯¯æç¤ºé¡µé¢
- **è¿‡æœŸé€šçŸ¥æœºåˆ¶**ï¼šæå‰é€šçŸ¥ç”¨æˆ·é“¾æ¥å³å°†è¿‡æœŸ

### 5.3.2 æ•°æ®åº“è®¾è®¡æ‰©å±•

```sql
-- URLæ˜ å°„è¡¨æ·»åŠ è¿‡æœŸç›¸å…³å­—æ®µ
ALTER TABLE url_mapping ADD COLUMN (
    expire_time DATETIME NULL COMMENT 'è¿‡æœŸæ—¶é—´ï¼ŒNULLè¡¨ç¤ºæ°¸ä¸è¿‡æœŸ',
    expire_type ENUM('NEVER', 'ABSOLUTE', 'RELATIVE') DEFAULT 'NEVER' COMMENT 'è¿‡æœŸç±»å‹',
    expire_duration INT NULL COMMENT 'ç›¸å¯¹è¿‡æœŸæ—¶é•¿ï¼ˆç§’ï¼‰',
    status ENUM('ACTIVE', 'EXPIRED', 'DISABLED') DEFAULT 'ACTIVE' COMMENT 'é“¾æ¥çŠ¶æ€',
    expire_notification_sent BOOLEAN DEFAULT FALSE COMMENT 'æ˜¯å¦å·²å‘é€è¿‡æœŸé€šçŸ¥',
    last_access_time DATETIME NULL COMMENT 'æœ€åè®¿é—®æ—¶é—´'
);

-- è¿‡æœŸé“¾æ¥å†å²è¡¨
CREATE TABLE expired_url_history (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    original_short_code VARCHAR(20) NOT NULL COMMENT 'åŸçŸ­é“¾ä»£ç ',
    original_url TEXT NOT NULL COMMENT 'åŸå§‹URL',
    user_id BIGINT COMMENT 'ç”¨æˆ·ID',
    created_time DATETIME NOT NULL COMMENT 'åˆ›å»ºæ—¶é—´',
    expired_time DATETIME NOT NULL COMMENT 'è¿‡æœŸæ—¶é—´',
    total_clicks INT DEFAULT 0 COMMENT 'æ€»ç‚¹å‡»æ¬¡æ•°',
    archived_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT 'å½’æ¡£æ—¶é—´',
    INDEX idx_user_expired (user_id, expired_time),
    INDEX idx_expired_time (expired_time)
) COMMENT 'è¿‡æœŸé“¾æ¥å†å²è¡¨';
```

### 5.3.3 è¿‡æœŸç­–ç•¥é…ç½®

```java
/**
 * è¿‡æœŸç­–ç•¥é…ç½®
 */
@Configuration
@ConfigurationProperties(prefix = "shorturl.expiration")
@Data
public class ExpirationConfig {
    
    /**
     * é»˜è®¤è¿‡æœŸç±»å‹
     */
    private ExpireType defaultExpireType = ExpireType.NEVER;
    
    /**
     * é»˜è®¤è¿‡æœŸæ—¶é•¿ï¼ˆå¤©ï¼‰
     */
    private int defaultExpireDays = 365;
    
    /**
     * æœ€å¤§è¿‡æœŸæ—¶é•¿ï¼ˆå¤©ï¼‰
     */
    private int maxExpireDays = 3650;
    
    /**
     * è¿‡æœŸæ£€æŸ¥é—´éš”ï¼ˆåˆ†é’Ÿï¼‰
     */
    private int checkIntervalMinutes = 60;
    
    /**
     * æ‰¹é‡å¤„ç†å¤§å°
     */
    private int batchSize = 1000;
    
    /**
     * æ˜¯å¦å¯ç”¨è¿‡æœŸé€šçŸ¥
     */
    private boolean enableNotification = true;
    
    /**
     * è¿‡æœŸå‰é€šçŸ¥å¤©æ•°
     */
    private int notificationDaysBefore = 7;
    
    /**
     * æ˜¯å¦è‡ªåŠ¨æ¸…ç†è¿‡æœŸé“¾æ¥
     */
    private boolean autoCleanup = true;
    
    /**
     * è¿‡æœŸåä¿ç•™å¤©æ•°
     */
    private int retentionDaysAfterExpiry = 30;
    
    /**
     * é”™è¯¯é¡µé¢æ¨¡æ¿è·¯å¾„
     */
    private String errorPageTemplate = "error/expired";
}

/**
 * è¿‡æœŸç±»å‹æšä¸¾
 */
public enum ExpireType {
    /**
     * æ°¸ä¸è¿‡æœŸ
     */
    NEVER("æ°¸ä¸è¿‡æœŸ"),
    
    /**
     * ç»å¯¹æ—¶é—´è¿‡æœŸ
     */
    ABSOLUTE("ç»å¯¹æ—¶é—´"),
    
    /**
     * ç›¸å¯¹æ—¶é—´è¿‡æœŸï¼ˆä»åˆ›å»ºæ—¶é—´å¼€å§‹è®¡ç®—ï¼‰
     */
    RELATIVE("ç›¸å¯¹æ—¶é—´");
    
    private final String description;
    
    ExpireType(String description) {
        this.description = description;
    }
    
    public String getDescription() {
        return description;
    }
}
```

### 5.3.4 è¿‡æœŸæ£€æµ‹æœåŠ¡

```java
/**
 * é“¾æ¥è¿‡æœŸæ£€æµ‹æœåŠ¡
 */
@Service
@Slf4j
public class ExpirationService {
    
    @Autowired
    private UrlMappingRepository urlMappingRepository;
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    @Autowired
    private ExpirationConfig expirationConfig;
    
    @Autowired
    private ExpirationNotificationService notificationService;
    
    private static final String EXPIRY_CHECK_CACHE_KEY = "expiry_check:";
    
    /**
     * æ£€æŸ¥å•ä¸ªé“¾æ¥æ˜¯å¦è¿‡æœŸ
     */
    public ExpirationResult checkExpiration(String shortCode) {
        try {
            // 1. ä»ç¼“å­˜æ£€æŸ¥
            ExpirationResult cachedResult = getCachedExpirationResult(shortCode);
            if (cachedResult != null) {
                return cachedResult;
            }
            
            // 2. ä»æ•°æ®åº“æŸ¥è¯¢
            UrlMappingEntity mapping = urlMappingRepository.findByShortCode(shortCode);
            if (mapping == null) {
                return ExpirationResult.notFound();
            }
            
            // 3. æ£€æŸ¥è¿‡æœŸçŠ¶æ€
            ExpirationResult result = determineExpirationStatus(mapping);
            
            // 4. ç¼“å­˜ç»“æœ
            cacheExpirationResult(shortCode, result);
            
            // 5. å¦‚æœè¿‡æœŸï¼Œæ›´æ–°æ•°æ®åº“çŠ¶æ€
            if (result.isExpired() && mapping.getStatus() == UrlStatus.ACTIVE) {
                updateExpiredStatus(mapping);
            }
            
            return result;
            
        } catch (Exception e) {
            log.error("æ£€æŸ¥é“¾æ¥è¿‡æœŸçŠ¶æ€å¤±è´¥: shortCode={}", shortCode, e);
            return ExpirationResult.error();
        }
    }
    
    /**
     * ç¡®å®šè¿‡æœŸçŠ¶æ€
     */
    private ExpirationResult determineExpirationStatus(UrlMappingEntity mapping) {
        // 1. æ£€æŸ¥æ˜¯å¦å·²æ ‡è®°ä¸ºè¿‡æœŸ
        if (mapping.getStatus() == UrlStatus.EXPIRED) {
            return ExpirationResult.expired(mapping.getExpireTime());
        }
        
        // 2. æ£€æŸ¥è¿‡æœŸæ—¶é—´
        LocalDateTime expireTime = mapping.getExpireTime();
        if (expireTime == null) {
            return ExpirationResult.active(); // æ°¸ä¸è¿‡æœŸ
        }
        
        LocalDateTime now = LocalDateTime.now();
        if (now.isAfter(expireTime)) {
            return ExpirationResult.expired(expireTime);
        }
        
        // 3. æ£€æŸ¥æ˜¯å¦å³å°†è¿‡æœŸ
        LocalDateTime notificationTime = expireTime.minusDays(expirationConfig.getNotificationDaysBefore());
        if (now.isAfter(notificationTime)) {
            return ExpirationResult.expiringSoon(expireTime);
        }
        
        return ExpirationResult.active();
    }
    
    /**
     * æ›´æ–°è¿‡æœŸçŠ¶æ€
     */
    private void updateExpiredStatus(UrlMappingEntity mapping) {
        try {
            mapping.setStatus(UrlStatus.EXPIRED);
            urlMappingRepository.save(mapping);
            
            // æ¸…é™¤ç›¸å…³ç¼“å­˜
            clearRelatedCache(mapping.getShortCode());
            
            log.info("é“¾æ¥å·²æ ‡è®°ä¸ºè¿‡æœŸ: shortCode={}", mapping.getShortCode());
            
        } catch (Exception e) {
            log.error("æ›´æ–°è¿‡æœŸçŠ¶æ€å¤±è´¥: shortCode={}", mapping.getShortCode(), e);
        }
    }
    
    /**
     * ç¼“å­˜è¿‡æœŸæ£€æŸ¥ç»“æœ
     */
    private void cacheExpirationResult(String shortCode, ExpirationResult result) {
        String cacheKey = EXPIRY_CHECK_CACHE_KEY + shortCode;
        int ttl = result.isExpired() ? 3600 : 300; // è¿‡æœŸçš„ç¼“å­˜æ›´ä¹…
        redisTemplate.opsForValue().set(cacheKey, result, Duration.ofSeconds(ttl));
    }
    
    /**
     * è·å–ç¼“å­˜çš„è¿‡æœŸæ£€æŸ¥ç»“æœ
     */
    private ExpirationResult getCachedExpirationResult(String shortCode) {
        String cacheKey = EXPIRY_CHECK_CACHE_KEY + shortCode;
        return (ExpirationResult) redisTemplate.opsForValue().get(cacheKey);
    }
    
    /**
     * æ¸…é™¤ç›¸å…³ç¼“å­˜
     */
    private void clearRelatedCache(String shortCode) {
        redisTemplate.delete(EXPIRY_CHECK_CACHE_KEY + shortCode);
        redisTemplate.delete("mapping:" + shortCode);
    }
}

/**
 * è¿‡æœŸæ£€æŸ¥ç»“æœ
 */
@Data
@Builder
public class ExpirationResult {
    private boolean expired;
    private boolean expiringSoon;
    private boolean found;
    private LocalDateTime expireTime;
    private String message;
    private ExpirationErrorType errorType;
    
    public static ExpirationResult active() {
        return ExpirationResult.builder()
                .expired(false)
                .expiringSoon(false)
                .found(true)
                .message("é“¾æ¥æœ‰æ•ˆ")
                .build();
    }
    
    public static ExpirationResult expired(LocalDateTime expireTime) {
        return ExpirationResult.builder()
                .expired(true)
                .expiringSoon(false)
                .found(true)
                .expireTime(expireTime)
                .message("é“¾æ¥å·²è¿‡æœŸ")
                .errorType(ExpirationErrorType.EXPIRED)
                .build();
    }
    
    public static ExpirationResult expiringSoon(LocalDateTime expireTime) {
        return ExpirationResult.builder()
                .expired(false)
                .expiringSoon(true)
                .found(true)
                .expireTime(expireTime)
                .message("é“¾æ¥å³å°†è¿‡æœŸ")
                .build();
    }
    
    public static ExpirationResult notFound() {
        return ExpirationResult.builder()
                .expired(false)
                .expiringSoon(false)
                .found(false)
                .message("é“¾æ¥ä¸å­˜åœ¨")
                .errorType(ExpirationErrorType.NOT_FOUND)
                .build();
    }
    
    public static ExpirationResult error() {
        return ExpirationResult.builder()
                .expired(false)
                .expiringSoon(false)
                .found(false)
                .message("ç³»ç»Ÿé”™è¯¯")
                .errorType(ExpirationErrorType.SYSTEM_ERROR)
                .build();
    }
}

/**
 * è¿‡æœŸé”™è¯¯ç±»å‹
 */
public enum ExpirationErrorType {
    EXPIRED("é“¾æ¥å·²è¿‡æœŸ"),
    NOT_FOUND("é“¾æ¥ä¸å­˜åœ¨"),
    SYSTEM_ERROR("ç³»ç»Ÿé”™è¯¯");
    
    private final String description;
    
    ExpirationErrorType(String description) {
        this.description = description;
    }
    
    public String getDescription() {
        return description;
    }
}
```

### 5.3.5 å®šæ—¶æ¸…ç†ä»»åŠ¡

```java
/**
 * è¿‡æœŸé“¾æ¥å®šæ—¶æ¸…ç†ä»»åŠ¡
 */
@Component
@Slf4j
public class ExpirationScheduler {
    
    @Autowired
    private UrlMappingRepository urlMappingRepository;
    
    @Autowired
    private ExpiredUrlHistoryRepository expiredUrlHistoryRepository;
    
    @Autowired
    private ExpirationConfig expirationConfig;
    
    @Autowired
    private ExpirationNotificationService notificationService;
    
    /**
     * å®šæ—¶æ£€æŸ¥è¿‡æœŸé“¾æ¥
     */
    @Scheduled(fixedDelayString = "#{@expirationConfig.checkIntervalMinutes * 60 * 1000}")
    public void checkExpiredUrls() {
        if (!expirationConfig.isAutoCleanup()) {
            return;
        }
        
        log.info("å¼€å§‹æ‰§è¡Œè¿‡æœŸé“¾æ¥æ£€æŸ¥ä»»åŠ¡");
        
        try {
            // 1. æŸ¥æ‰¾è¿‡æœŸé“¾æ¥
            List<UrlMappingEntity> expiredUrls = findExpiredUrls();
            
            if (expiredUrls.isEmpty()) {
                log.info("æ²¡æœ‰å‘ç°è¿‡æœŸé“¾æ¥");
                return;
            }
            
            log.info("å‘ç° {} ä¸ªè¿‡æœŸé“¾æ¥", expiredUrls.size());
            
            // 2. æ‰¹é‡å¤„ç†è¿‡æœŸé“¾æ¥
            processExpiredUrls(expiredUrls);
            
            // 3. æ£€æŸ¥å³å°†è¿‡æœŸçš„é“¾æ¥
            checkExpiringSoonUrls();
            
        } catch (Exception e) {
            log.error("è¿‡æœŸé“¾æ¥æ£€æŸ¥ä»»åŠ¡æ‰§è¡Œå¤±è´¥", e);
        }
    }
    
    /**
     * æŸ¥æ‰¾è¿‡æœŸé“¾æ¥
     */
    private List<UrlMappingEntity> findExpiredUrls() {
        LocalDateTime now = LocalDateTime.now();
        return urlMappingRepository.findExpiredUrls(now, expirationConfig.getBatchSize());
    }
    
    /**
     * å¤„ç†è¿‡æœŸé“¾æ¥
     */
    private void processExpiredUrls(List<UrlMappingEntity> expiredUrls) {
        for (UrlMappingEntity url : expiredUrls) {
            try {
                // 1. å½’æ¡£åˆ°å†å²è¡¨
                archiveExpiredUrl(url);
                
                // 2. æ›´æ–°çŠ¶æ€ä¸ºè¿‡æœŸ
                url.setStatus(UrlStatus.EXPIRED);
                urlMappingRepository.save(url);
                
                // 3. æ¸…é™¤ç¼“å­˜
                clearUrlCache(url.getShortCode());
                
                log.debug("å¤„ç†è¿‡æœŸé“¾æ¥å®Œæˆ: shortCode={}", url.getShortCode());
                
            } catch (Exception e) {
                log.error("å¤„ç†è¿‡æœŸé“¾æ¥å¤±è´¥: shortCode={}", url.getShortCode(), e);
            }
        }
    }
    
    /**
     * å½’æ¡£è¿‡æœŸé“¾æ¥
     */
    private void archiveExpiredUrl(UrlMappingEntity url) {
        ExpiredUrlHistory history = ExpiredUrlHistory.builder()
                .originalShortCode(url.getShortCode())
                .originalUrl(url.getOriginalUrl())
                .userId(url.getUserId())
                .createdTime(url.getCreatedTime())
                .expiredTime(url.getExpireTime())
                .totalClicks(url.getClickCount())
                .archivedTime(LocalDateTime.now())
                .build();
        
        expiredUrlHistoryRepository.save(history);
    }
    
    /**
     * æ£€æŸ¥å³å°†è¿‡æœŸçš„é“¾æ¥
     */
    private void checkExpiringSoonUrls() {
        if (!expirationConfig.isEnableNotification()) {
            return;
        }
        
        LocalDateTime notificationTime = LocalDateTime.now()
                .plusDays(expirationConfig.getNotificationDaysBefore());
        
        List<UrlMappingEntity> expiringSoonUrls = urlMappingRepository
                .findExpiringSoonUrls(notificationTime, expirationConfig.getBatchSize());
        
        for (UrlMappingEntity url : expiringSoonUrls) {
            if (!url.isExpireNotificationSent()) {
                notificationService.sendExpirationNotification(url);
                url.setExpireNotificationSent(true);
                urlMappingRepository.save(url);
            }
        }
    }
    
    /**
     * æ¸…ç†è¿‡æœŸæ•°æ®
     */
    @Scheduled(cron = "0 0 2 * * ?") // æ¯å¤©å‡Œæ™¨2ç‚¹æ‰§è¡Œ
    public void cleanupExpiredData() {
        if (!expirationConfig.isAutoCleanup()) {
            return;
        }
        
        log.info("å¼€å§‹æ‰§è¡Œè¿‡æœŸæ•°æ®æ¸…ç†ä»»åŠ¡");
        
        try {
            LocalDateTime cutoffTime = LocalDateTime.now()
                    .minusDays(expirationConfig.getRetentionDaysAfterExpiry());
            
            // 1. åˆ é™¤è¿‡æœŸçš„URLæ˜ å°„
            int deletedMappings = urlMappingRepository.deleteExpiredUrls(cutoffTime);
            
            // 2. æ¸…ç†è¿‡æœŸçš„å†å²è®°å½•ï¼ˆå¯é€‰ï¼‰
            int deletedHistory = expiredUrlHistoryRepository.deleteOldHistory(
                    cutoffTime.minusDays(365)); // ä¿ç•™1å¹´å†å²
            
            log.info("è¿‡æœŸæ•°æ®æ¸…ç†å®Œæˆ: åˆ é™¤æ˜ å°„={}, åˆ é™¤å†å²={}", deletedMappings, deletedHistory);
            
        } catch (Exception e) {
            log.error("è¿‡æœŸæ•°æ®æ¸…ç†ä»»åŠ¡æ‰§è¡Œå¤±è´¥", e);
        }
    }
    
    /**
     * æ¸…é™¤URLç¼“å­˜
     */
    private void clearUrlCache(String shortCode) {
        // å®ç°ç¼“å­˜æ¸…ç†é€»è¾‘
    }
}
```

### 5.3.6 å‹å¥½é”™è¯¯é¡µé¢å®ç°

#### 5.3.6.1 é”™è¯¯é¡µé¢æ§åˆ¶å™¨

```java
/**
 * é”™è¯¯é¡µé¢æ§åˆ¶å™¨
 */
@Controller
@Slf4j
public class ErrorPageController {
    
    @Autowired
    private ExpirationService expirationService;
    
    @Autowired
    private UrlMappingRepository urlMappingRepository;
    
    /**
     * å¤„ç†è¿‡æœŸé“¾æ¥è®¿é—®
     */
    @GetMapping("/error/expired/{shortCode}")
    public String expiredPage(@PathVariable String shortCode, 
                             Model model, 
                             HttpServletRequest request) {
        
        try {
            // 1. è·å–é“¾æ¥ä¿¡æ¯
            UrlMappingEntity mapping = urlMappingRepository.findByShortCode(shortCode);
            
            // 2. æ„å»ºé”™è¯¯é¡µé¢æ•°æ®
            ErrorPageData errorData = buildErrorPageData(shortCode, mapping, request);
            model.addAttribute("errorData", errorData);
            
            // 3. è®°å½•è®¿é—®æ—¥å¿—
            logExpiredAccess(shortCode, request);
            
            return "error/expired";
            
        } catch (Exception e) {
            log.error("å¤„ç†è¿‡æœŸé¡µé¢å¤±è´¥: shortCode={}", shortCode, e);
            return "error/general";
        }
    }
    
    /**
     * æ„å»ºé”™è¯¯é¡µé¢æ•°æ®
     */
    private ErrorPageData buildErrorPageData(String shortCode, 
                                           UrlMappingEntity mapping, 
                                           HttpServletRequest request) {
        
        ErrorPageData.ErrorPageDataBuilder builder = ErrorPageData.builder()
                .shortCode(shortCode)
                .timestamp(LocalDateTime.now())
                .userAgent(request.getHeader("User-Agent"))
                .isMobile(isMobileDevice(request));
        
        if (mapping != null) {
            builder.originalUrl(mapping.getOriginalUrl())
                   .expiredTime(mapping.getExpireTime())
                   .createdTime(mapping.getCreatedTime())
                   .domain(extractDomain(mapping.getOriginalUrl()));
        }
        
        return builder.build();
    }
    
    /**
     * æ£€æµ‹æ˜¯å¦ä¸ºç§»åŠ¨è®¾å¤‡
     */
    private boolean isMobileDevice(HttpServletRequest request) {
        String userAgent = request.getHeader("User-Agent");
        if (userAgent == null) {
            return false;
        }
        
        return userAgent.toLowerCase().contains("mobile") ||
               userAgent.toLowerCase().contains("android") ||
               userAgent.toLowerCase().contains("iphone");
    }
    
    /**
     * æå–åŸŸå
     */
    private String extractDomain(String url) {
        try {
            return new URL(url).getHost();
        } catch (Exception e) {
            return "";
        }
    }
    
    /**
     * è®°å½•è¿‡æœŸè®¿é—®æ—¥å¿—
     */
    private void logExpiredAccess(String shortCode, HttpServletRequest request) {
        String ip = getClientIp(request);
        String userAgent = request.getHeader("User-Agent");
        
        log.info("è¿‡æœŸé“¾æ¥è®¿é—®: shortCode={}, ip={}, userAgent={}", 
                shortCode, ip, userAgent);
    }
    
    private String getClientIp(HttpServletRequest request) {
        String ip = request.getHeader("X-Forwarded-For");
        if (StringUtils.isBlank(ip) || "unknown".equalsIgnoreCase(ip)) {
            ip = request.getHeader("X-Real-IP");
        }
        if (StringUtils.isBlank(ip) || "unknown".equalsIgnoreCase(ip)) {
            ip = request.getRemoteAddr();
        }
        return ip;
    }
}

/**
 * é”™è¯¯é¡µé¢æ•°æ®æ¨¡å‹
 */
@Data
@Builder
public class ErrorPageData {
    private String shortCode;
    private String originalUrl;
    private String domain;
    private LocalDateTime expiredTime;
    private LocalDateTime createdTime;
    private LocalDateTime timestamp;
    private String userAgent;
    private boolean isMobile;
}
```

#### 5.3.6.2 é”™è¯¯é¡µé¢æ¨¡æ¿

```html
<!-- templates/error/expired.html -->
<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é“¾æ¥å·²è¿‡æœŸ - çŸ­é“¾æœåŠ¡</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #333;
        }
        
        .error-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            padding: 40px;
            max-width: 500px;
            width: 90%;
            text-align: center;
            animation: slideUp 0.6s ease-out;
        }
        
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .error-icon {
            width: 80px;
            height: 80px;
            margin: 0 auto 20px;
            background: #ff6b6b;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            color: white;
        }
        
        .error-title {
            font-size: 28px;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .error-subtitle {
            font-size: 16px;
            color: #7f8c8d;
            margin-bottom: 30px;
        }
        
        .error-details {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
            text-align: left;
        }
        
        .detail-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 14px;
        }
        
        .detail-label {
            font-weight: 600;
            color: #495057;
        }
        
        .detail-value {
            color: #6c757d;
            word-break: break-all;
        }
        
        .action-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            text-decoration: none;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5a6fd8;
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background: #e9ecef;
            color: #495057;
        }
        
        .btn-secondary:hover {
            background: #dee2e6;
            transform: translateY(-2px);
        }
        
        .footer-text {
            margin-top: 30px;
            font-size: 12px;
            color: #adb5bd;
        }
        
        /* ç§»åŠ¨ç«¯é€‚é… */
        @media (max-width: 480px) {
            .error-container {
                padding: 30px 20px;
            }
            
            .error-title {
                font-size: 24px;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="error-container">
        <!-- é”™è¯¯å›¾æ ‡ -->
        <div class="error-icon">
            â°
        </div>
        
        <!-- é”™è¯¯æ ‡é¢˜ -->
        <h1 class="error-title">é“¾æ¥å·²è¿‡æœŸ</h1>
        <p class="error-subtitle">æŠ±æ­‰ï¼Œæ‚¨è®¿é—®çš„çŸ­é“¾æ¥å·²ç»è¿‡æœŸï¼Œæ— æ³•ç»§ç»­ä½¿ç”¨</p>
        
        <!-- é”™è¯¯è¯¦æƒ… -->
        <div class="error-details" th:if="${errorData.originalUrl}">
            <div class="detail-item">
                <span class="detail-label">çŸ­é“¾ä»£ç :</span>
                <span class="detail-value" th:text="${errorData.shortCode}"></span>
            </div>
            <div class="detail-item" th:if="${errorData.domain}">
                <span class="detail-label">ç›®æ ‡åŸŸå:</span>
                <span class="detail-value" th:text="${errorData.domain}"></span>
            </div>
            <div class="detail-item" th:if="${errorData.expiredTime}">
                <span class="detail-label">è¿‡æœŸæ—¶é—´:</span>
                <span class="detail-value" th:text="${#temporals.format(errorData.expiredTime, 'yyyy-MM-dd HH:mm')}"></span>
            </div>
            <div class="detail-item" th:if="${errorData.createdTime}">
                <span class="detail-label">åˆ›å»ºæ—¶é—´:</span>
                <span class="detail-value" th:text="${#temporals.format(errorData.createdTime, 'yyyy-MM-dd HH:mm')}"></span>
            </div>
        </div>
        
        <!-- æ“ä½œæŒ‰é’® -->
        <div class="action-buttons">
            <a href="/" class="btn btn-primary">
                ğŸ  è¿”å›é¦–é¡µ
            </a>
            <a href="/create" class="btn btn-secondary">
                â• åˆ›å»ºæ–°é“¾æ¥
            </a>
            <button class="btn btn-secondary" onclick="copyToClipboard()">
                ğŸ“‹ å¤åˆ¶çŸ­é“¾
            </button>
        </div>
        
        <!-- é¡µè„šæ–‡å­— -->
        <p class="footer-text">
            å¦‚æœ‰ç–‘é—®ï¼Œè¯·è”ç³»å®¢æœæˆ–é‡æ–°åˆ›å»ºçŸ­é“¾æ¥
        </p>
    </div>
    
    <script>
        function copyToClipboard() {
            const shortCode = '[[${errorData.shortCode}]]';
            const fullUrl = window.location.origin + '/' + shortCode;
            
            if (navigator.clipboard) {
                navigator.clipboard.writeText(fullUrl).then(() => {
                    showToast('çŸ­é“¾å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
                });
            } else {
                // å…¼å®¹æ—§æµè§ˆå™¨
                const textArea = document.createElement('textarea');
                textArea.value = fullUrl;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showToast('çŸ­é“¾å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
            }
        }
        
        function showToast(message) {
            const toast = document.createElement('div');
            toast.textContent = message;
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #28a745;
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                font-size: 14px;
                z-index: 1000;
                animation: slideIn 0.3s ease-out;
            `;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }
    </script>
</body>
</html>
```

### 5.3.7 è¿‡æœŸé€šçŸ¥æœåŠ¡

```java
/**
 * è¿‡æœŸé€šçŸ¥æœåŠ¡
 */
@Service
@Slf4j
public class ExpirationNotificationService {
    
    @Autowired
    private UserRepository userRepository;
    
    @Autowired
    private EmailService emailService;
    
    @Autowired
    private SmsService smsService;
    
    @Autowired
    private ExpirationConfig expirationConfig;
    
    /**
     * å‘é€è¿‡æœŸé€šçŸ¥
     */
    public void sendExpirationNotification(UrlMappingEntity mapping) {
        try {
            if (mapping.getUserId() == null) {
                return; // åŒ¿åç”¨æˆ·ä¸å‘é€é€šçŸ¥
            }
            
            UserEntity user = userRepository.findById(mapping.getUserId()).orElse(null);
            if (user == null) {
                return;
            }
            
            // æ„å»ºé€šçŸ¥å†…å®¹
            NotificationContent content = buildNotificationContent(mapping, user);
            
            // å‘é€é‚®ä»¶é€šçŸ¥
            if (StringUtils.isNotBlank(user.getEmail())) {
                sendEmailNotification(user.getEmail(), content);
            }
            
            // å‘é€çŸ­ä¿¡é€šçŸ¥ï¼ˆå¯é€‰ï¼‰
            if (StringUtils.isNotBlank(user.getPhone()) && user.isSmsNotificationEnabled()) {
                sendSmsNotification(user.getPhone(), content);
            }
            
            log.info("è¿‡æœŸé€šçŸ¥å‘é€æˆåŠŸ: userId={}, shortCode={}", 
                    user.getId(), mapping.getShortCode());
            
        } catch (Exception e) {
            log.error("å‘é€è¿‡æœŸé€šçŸ¥å¤±è´¥: shortCode={}", mapping.getShortCode(), e);
        }
    }
    
    /**
     * æ„å»ºé€šçŸ¥å†…å®¹
     */
    private NotificationContent buildNotificationContent(UrlMappingEntity mapping, UserEntity user) {
        return NotificationContent.builder()
                .userName(user.getUsername())
                .shortCode(mapping.getShortCode())
                .originalUrl(mapping.getOriginalUrl())
                .expireTime(mapping.getExpireTime())
                .daysUntilExpiry(calculateDaysUntilExpiry(mapping.getExpireTime()))
                .build();
    }
    
    /**
     * è®¡ç®—è·ç¦»è¿‡æœŸçš„å¤©æ•°
     */
    private long calculateDaysUntilExpiry(LocalDateTime expireTime) {
        return ChronoUnit.DAYS.between(LocalDateTime.now(), expireTime);
    }
    
    /**
     * å‘é€é‚®ä»¶é€šçŸ¥
     */
    private void sendEmailNotification(String email, NotificationContent content) {
        // å®ç°é‚®ä»¶å‘é€é€»è¾‘
        emailService.sendExpirationNotification(email, content);
    }
    
    /**
     * å‘é€çŸ­ä¿¡é€šçŸ¥
     */
    private void sendSmsNotification(String phone, NotificationContent content) {
        // å®ç°çŸ­ä¿¡å‘é€é€»è¾‘
        smsService.sendExpirationNotification(phone, content);
    }
}

/**
 * é€šçŸ¥å†…å®¹
 */
@Data
@Builder
public class NotificationContent {
    private String userName;
    private String shortCode;
    private String originalUrl;
    private LocalDateTime expireTime;
    private long daysUntilExpiry;
}
```

### 5.3.8 é…ç½®ç¤ºä¾‹

```yaml
# application.yml
shorturl:
  expiration:
    # é»˜è®¤è¿‡æœŸç±»å‹ï¼šNEVER, ABSOLUTE, RELATIVE
    default-expire-type: RELATIVE
    # é»˜è®¤è¿‡æœŸæ—¶é•¿ï¼ˆå¤©ï¼‰
    default-expire-days: 365
    # æœ€å¤§è¿‡æœŸæ—¶é•¿ï¼ˆå¤©ï¼‰
    max-expire-days: 3650
    # è¿‡æœŸæ£€æŸ¥é—´éš”ï¼ˆåˆ†é’Ÿï¼‰
    check-interval-minutes: 60
    # æ‰¹é‡å¤„ç†å¤§å°
    batch-size: 1000
    # æ˜¯å¦å¯ç”¨è¿‡æœŸé€šçŸ¥
    enable-notification: true
    # è¿‡æœŸå‰é€šçŸ¥å¤©æ•°
    notification-days-before: 7
    # æ˜¯å¦è‡ªåŠ¨æ¸…ç†è¿‡æœŸé“¾æ¥
    auto-cleanup: true
    # è¿‡æœŸåä¿ç•™å¤©æ•°
    retention-days-after-expiry: 30
    # é”™è¯¯é¡µé¢æ¨¡æ¿è·¯å¾„
    error-page-template: "error/expired"
```

### 5.3.9 ç›‘æ§å’ŒæŒ‡æ ‡

```java
/**
 * è¿‡æœŸç›‘æ§æœåŠ¡
 */
@Component
@Slf4j
public class ExpirationMonitor {
    
    private final MeterRegistry meterRegistry;
    private final Counter expirationCheckCounter;
    private final Timer expirationCheckTimer;
    private final Gauge activeUrlsGauge;
    private final Gauge expiredUrlsGauge;
    
    @Autowired
    private UrlMappingRepository urlMappingRepository;
    
    public ExpirationMonitor(MeterRegistry meterRegistry) {
        this.meterRegistry = meterRegistry;
        this.expirationCheckCounter = Counter.builder("expiration.check.count")
                .description("è¿‡æœŸæ£€æŸ¥æ¬¡æ•°")
                .register(meterRegistry);
        this.expirationCheckTimer = Timer.builder("expiration.check.duration")
                .description("è¿‡æœŸæ£€æŸ¥è€—æ—¶")
                .register(meterRegistry);
        this.activeUrlsGauge = Gauge.builder("urls.active.count")
                .description("æ´»è·ƒé“¾æ¥æ•°é‡")
                .register(meterRegistry, this, ExpirationMonitor::getActiveUrlCount);
        this.expiredUrlsGauge = Gauge.builder("urls.expired.count")
                .description("è¿‡æœŸé“¾æ¥æ•°é‡")
                .register(meterRegistry, this, ExpirationMonitor::getExpiredUrlCount);
    }
    
    /**
     * è®°å½•è¿‡æœŸæ£€æŸ¥æŒ‡æ ‡
     */
    public void recordExpirationCheck(boolean found, boolean expired, Duration duration) {
        expirationCheckCounter.increment(
                Tags.of(
                        "found", String.valueOf(found),
                        "expired", String.valueOf(expired)
                )
        );
        expirationCheckTimer.record(duration);
    }
    
    /**
     * è·å–æ´»è·ƒé“¾æ¥æ•°é‡
     */
    private double getActiveUrlCount() {
        return urlMappingRepository.countByStatus(UrlStatus.ACTIVE);
    }
    
    /**
     * è·å–è¿‡æœŸé“¾æ¥æ•°é‡
     */
    private double getExpiredUrlCount() {
        return urlMappingRepository.countByStatus(UrlStatus.EXPIRED);
    }
}
```

### 5.3.10 æœ€ä½³å®è·µæ€»ç»“

#### 5.3.10.1 æ€§èƒ½ä¼˜åŒ–
1. **å¤šçº§ç¼“å­˜**ï¼šRedisç¼“å­˜ + æœ¬åœ°ç¼“å­˜
2. **æ‰¹é‡å¤„ç†**ï¼šå®šæ—¶ä»»åŠ¡æ‰¹é‡å¤„ç†è¿‡æœŸé“¾æ¥
3. **å¼‚æ­¥é€šçŸ¥**ï¼šè¿‡æœŸé€šçŸ¥å¼‚æ­¥å‘é€
4. **ç´¢å¼•ä¼˜åŒ–**ï¼šè¿‡æœŸæ—¶é—´å­—æ®µå»ºç«‹ç´¢å¼•

#### 5.3.10.2 ç”¨æˆ·ä½“éªŒ
1. **å‹å¥½é”™è¯¯é¡µé¢**ï¼šç¾è§‚ã€ä¿¡æ¯ä¸°å¯Œçš„é”™è¯¯æç¤º
2. **ç§»åŠ¨ç«¯é€‚é…**ï¼šå“åº”å¼è®¾è®¡æ”¯æŒå„ç§è®¾å¤‡
3. **æ“ä½œå¼•å¯¼**ï¼šæä¾›æ˜ç¡®çš„åç»­æ“ä½œå»ºè®®
4. **å¤šè¯­è¨€æ”¯æŒ**ï¼šæ”¯æŒå›½é™…åŒ–

#### 5.3.10.3 è¿ç»´ç›‘æ§
1. **æŒ‡æ ‡ç›‘æ§**ï¼šè¿‡æœŸæ£€æŸ¥æ¬¡æ•°ã€è€—æ—¶ã€é“¾æ¥çŠ¶æ€ç»Ÿè®¡
2. **å‘Šè­¦æœºåˆ¶**ï¼šè¿‡æœŸå¤„ç†å¤±è´¥ã€ç³»ç»Ÿå¼‚å¸¸å‘Šè­¦
3. **æ—¥å¿—è®°å½•**ï¼šè¯¦ç»†çš„æ“ä½œæ—¥å¿—å’Œé”™è¯¯æ—¥å¿—
4. **æ•°æ®å¤‡ä»½**ï¼šè¿‡æœŸæ•°æ®å½’æ¡£å’Œå¤‡ä»½ç­–ç•¥

#### 5.1.7 çŸ­URLç”Ÿæˆç®—æ³•å®ç°

Base62ç¼–ç ç®—æ³•

ä½¿ç”¨62ä¸ªå­—ç¬¦ï¼ˆ0-9, a-z, A-Zï¼‰è¿›è¡Œç¼–ç ï¼Œå°†é•¿æ•´å‹IDå‹ç¼©ä¸ºçŸ­å­—ç¬¦ä¸²ï¼Œæ”¯æŒç¼–ç /è§£ç å’ŒæŒ‡å®šé•¿åº¦è¡¥é›¶åŠŸèƒ½ï¼Œ6ä½Base62å¯è¡¨ç¤ºçº¦568äº¿ä¸ªä¸åŒçš„çŸ­é“¾

**Base62ç¼–ç ç®—æ³•**
```java
@Component
public class Base62Encoder {
    
    private static final String BASE62_CHARS = "0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ";
    private static final int BASE = 62;
    
    /**
     * å°†æ•°å­—IDç¼–ç ä¸ºBase62å­—ç¬¦ä¸²
     */
    public String encode(long id) {
        if (id == 0) {
            return "0";
        }
        
        StringBuilder sb = new StringBuilder();
        while (id > 0) {
            sb.append(BASE62_CHARS.charAt((int) (id % BASE)));
            id /= BASE;
        }
        
        return sb.reverse().toString();
    }
    
    /**
     * å°†Base62å­—ç¬¦ä¸²è§£ç ä¸ºæ•°å­—ID
     */
    public long decode(String shortUrl) {
        long result = 0;
        long power = 1;
        
        for (int i = shortUrl.length() - 1; i >= 0; i--) {
            char c = shortUrl.charAt(i);
            int index = BASE62_CHARS.indexOf(c);
            if (index == -1) {
                throw new IllegalArgumentException("æ— æ•ˆçš„Base62å­—ç¬¦: " + c);
            }
            result += index * power;
            power *= BASE;
        }
        
        return result;
    }
    
    /**
     * ç”ŸæˆæŒ‡å®šé•¿åº¦çš„çŸ­é“¾ï¼ˆè¡¥é›¶ï¼‰
     */
    public String encodeWithPadding(long id, int minLength) {
        String encoded = encode(id);
        if (encoded.length() >= minLength) {
            return encoded;
        }
        
        StringBuilder sb = new StringBuilder();
        for (int i = 0; i < minLength - encoded.length(); i++) {
            sb.append('0');
        }
        sb.append(encoded);
        
        return sb.toString();
    }
}
```

**Snowflakeåˆ†å¸ƒå¼IDç”Ÿæˆå™¨**

64ä½IDç»“æ„ï¼š1ä½ç¬¦å·ä½ + 41ä½æ—¶é—´æˆ³ + 10ä½æœºå™¨ID + 12ä½åºåˆ—å·ï¼Œæ”¯æŒ1024å°æœºå™¨ï¼Œæ¯æ¯«ç§’å¯ç”Ÿæˆ4096ä¸ªID

åŒ…å«æ—¶é’Ÿå›æ‹¨æ£€æµ‹å’Œå¤„ç†æœºåˆ¶

ä¿è¯åˆ†å¸ƒå¼ç¯å¢ƒä¸‹IDçš„å…¨å±€å”¯ä¸€æ€§


```java
@Component
public class SnowflakeIdGenerator {
    
    // èµ·å§‹æ—¶é—´æˆ³ (2024-01-01)
    private static final long START_TIMESTAMP = 1704067200000L;
    
    // å„éƒ¨åˆ†ä½æ•°
    private static final long SEQUENCE_BITS = 12;
    private static final long MACHINE_BITS = 10;
    private static final long TIMESTAMP_BITS = 41;
    
    // æœ€å¤§å€¼
    private static final long MAX_SEQUENCE = (1L << SEQUENCE_BITS) - 1;
    private static final long MAX_MACHINE_ID = (1L << MACHINE_BITS) - 1;
    
    // ä½ç§»
    private static final long MACHINE_SHIFT = SEQUENCE_BITS;
    private static final long TIMESTAMP_SHIFT = SEQUENCE_BITS + MACHINE_BITS;
    
    private final long machineId;
    private long sequence = 0L;
    private long lastTimestamp = -1L;
    
    public SnowflakeIdGenerator(@Value("${app.machine-id:1}") long machineId) {
        if (machineId > MAX_MACHINE_ID || machineId < 0) {
            throw new IllegalArgumentException("æœºå™¨IDè¶…å‡ºèŒƒå›´: " + machineId);
        }
        this.machineId = machineId;
    }
    
    /**
     * ç”Ÿæˆå”¯ä¸€ID
     */
    public synchronized long nextId() {
        long timestamp = getCurrentTimestamp();
        
        // æ—¶é’Ÿå›æ‹¨æ£€æŸ¥
        if (timestamp < lastTimestamp) {
            throw new RuntimeException("æ—¶é’Ÿå›æ‹¨ï¼Œæ‹’ç»ç”ŸæˆID");
        }
        
        // åŒä¸€æ¯«ç§’å†…åºåˆ—å·é€’å¢
        if (timestamp == lastTimestamp) {
            sequence = (sequence + 1) & MAX_SEQUENCE;
            if (sequence == 0) {
                // åºåˆ—å·æº¢å‡ºï¼Œç­‰å¾…ä¸‹ä¸€æ¯«ç§’
                timestamp = waitNextMillis(lastTimestamp);
            }
        } else {
            sequence = 0L;
        }
        
        lastTimestamp = timestamp;
        
        // ç»„è£…ID
        return ((timestamp - START_TIMESTAMP) << TIMESTAMP_SHIFT)
                | (machineId << MACHINE_SHIFT)
                | sequence;
    }
    
    private long getCurrentTimestamp() {
        return System.currentTimeMillis();
    }
    
    private long waitNextMillis(long lastTimestamp) {
        long timestamp = getCurrentTimestamp();
        while (timestamp <= lastTimestamp) {
            timestamp = getCurrentTimestamp();
        }
        return timestamp;
    }
}
```

**çŸ­é“¾ç”ŸæˆæœåŠ¡**

é‡å¤URLå¤„ç† ï¼šä½¿ç”¨MD5å“ˆå¸Œæ£€æµ‹é‡å¤ï¼Œç›¸åŒURLè¿”å›ç›¸åŒçŸ­é“¾

å¤šå±‚æ£€æŸ¥æœºåˆ¶ ï¼šå¸ƒéš†è¿‡æ»¤å™¨ â†’ ç¼“å­˜ â†’ æ•°æ®åº“

å†²çªå¤„ç† ï¼šæ”¯æŒé‡è¯•æœºåˆ¶ï¼Œæœ€å¤šé‡è¯•3æ¬¡

è‡ªå®šä¹‰çŸ­é“¾ ï¼šæ”¯æŒç”¨æˆ·è‡ªå®šä¹‰ï¼ŒåŒ…å«æ ¼å¼éªŒè¯å’Œä¿ç•™å­—æ£€æŸ¥

```java
@Service
@Slf4j
public class ShortUrlGeneratorService {
    
    @Autowired
    private Base62Encoder base62Encoder;
    
    @Autowired
    private SnowflakeIdGenerator snowflakeIdGenerator;
    
    @Autowired
    private UrlMappingRepository urlMappingRepository;
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    @Autowired
    private BloomFilter<String> urlBloomFilter;
    
    private static final String URL_HASH_PREFIX = "url_hash:";
    private static final String SHORT_URL_PREFIX = "short_url:";
    private static final int DEFAULT_SHORT_URL_LENGTH = 6;
    private static final int MAX_RETRY_COUNT = 3;
    
    /**
     * ç”ŸæˆçŸ­é“¾
     */
    @Transactional
    public ShortUrlResult generateShortUrl(String originalUrl, String customShortUrl, Long userId) {
        try {
            // 1. URLæ ‡å‡†åŒ–
            String normalizedUrl = normalizeUrl(originalUrl);
            
            // 2. æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
            String urlHash = DigestUtils.md5Hex(normalizedUrl);
            UrlMappingEntity existingMapping = checkExistingUrl(urlHash);
            if (existingMapping != null) {
                return ShortUrlResult.success(existingMapping.getShortUrl(), false);
            }
            
            // 3. ç”ŸæˆçŸ­é“¾
            String shortUrl;
            if (StringUtils.isNotBlank(customShortUrl)) {
                // è‡ªå®šä¹‰çŸ­é“¾
                shortUrl = generateCustomShortUrl(customShortUrl);
            } else {
                // ç³»ç»Ÿç”ŸæˆçŸ­é“¾
                shortUrl = generateSystemShortUrl();
            }
            
            // 4. ä¿å­˜æ˜ å°„å…³ç³»
            UrlMappingEntity mapping = new UrlMappingEntity();
            mapping.setShortUrl(shortUrl);
            mapping.setOriginalUrl(normalizedUrl);
            mapping.setUrlHash(urlHash);
            mapping.setUserId(userId);
            mapping.setCreatedAt(new Date());
            mapping.setExpiresAt(calculateExpiryDate());
            mapping.setClickCount(0L);
            mapping.setStatus(UrlStatus.ACTIVE);
            
            urlMappingRepository.save(mapping);
            
            // 5. æ›´æ–°ç¼“å­˜å’Œå¸ƒéš†è¿‡æ»¤å™¨
            updateCache(shortUrl, normalizedUrl);
            urlBloomFilter.put(normalizedUrl);
            
            log.info("çŸ­é“¾ç”ŸæˆæˆåŠŸ: {} -> {}", normalizedUrl, shortUrl);
            return ShortUrlResult.success(shortUrl, true);
            
        } catch (Exception e) {
            log.error("çŸ­é“¾ç”Ÿæˆå¤±è´¥: {}", e.getMessage(), e);
            return ShortUrlResult.failure("çŸ­é“¾ç”Ÿæˆå¤±è´¥: " + e.getMessage());
        }
    }
    
    /**
     * æ£€æŸ¥URLæ˜¯å¦å·²å­˜åœ¨
     */
    private UrlMappingEntity checkExistingUrl(String urlHash) {
        // 1. å¸ƒéš†è¿‡æ»¤å™¨å¿«é€Ÿæ£€æŸ¥
        if (!urlBloomFilter.mightContain(urlHash)) {
            return null;
        }
        
        // 2. ç¼“å­˜æ£€æŸ¥
        String cacheKey = URL_HASH_PREFIX + urlHash;
        String cachedShortUrl = (String) redisTemplate.opsForValue().get(cacheKey);
        if (StringUtils.isNotBlank(cachedShortUrl)) {
            return urlMappingRepository.findByShortUrl(cachedShortUrl);
        }
        
        // 3. æ•°æ®åº“æŸ¥è¯¢
        return urlMappingRepository.findByUrlHash(urlHash);
    }
    
    /**
     * ç”Ÿæˆç³»ç»ŸçŸ­é“¾
     */
    private String generateSystemShortUrl() {
        for (int retry = 0; retry < MAX_RETRY_COUNT; retry++) {
            try {
                // ä½¿ç”¨Snowflakeç”Ÿæˆå”¯ä¸€ID
                long id = snowflakeIdGenerator.nextId();
                
                // Base62ç¼–ç 
                String shortUrl = base62Encoder.encodeWithPadding(id, DEFAULT_SHORT_URL_LENGTH);
                
                // æ£€æŸ¥å†²çª
                if (!urlMappingRepository.existsByShortUrl(shortUrl)) {
                    return shortUrl;
                }
                
                log.warn("çŸ­é“¾å†²çªï¼Œé‡è¯•: {}", shortUrl);
                
            } catch (Exception e) {
                log.error("ç”ŸæˆçŸ­é“¾å¼‚å¸¸ï¼Œé‡è¯•: {}", e.getMessage());
            }
        }
        
        throw new RuntimeException("çŸ­é“¾ç”Ÿæˆå¤±è´¥ï¼Œè¶…è¿‡æœ€å¤§é‡è¯•æ¬¡æ•°");
    }
    
    /**
     * ç”Ÿæˆè‡ªå®šä¹‰çŸ­é“¾
     */
    private String generateCustomShortUrl(String customShortUrl) {
        // 1. éªŒè¯è‡ªå®šä¹‰çŸ­é“¾æ ¼å¼
        if (!isValidCustomShortUrl(customShortUrl)) {
            throw new IllegalArgumentException("è‡ªå®šä¹‰çŸ­é“¾æ ¼å¼ä¸æ­£ç¡®");
        }
        
        // 2. æ£€æŸ¥æ˜¯å¦å·²è¢«ä½¿ç”¨
        if (urlMappingRepository.existsByShortUrl(customShortUrl)) {
            throw new IllegalArgumentException("è‡ªå®šä¹‰çŸ­é“¾å·²è¢«ä½¿ç”¨");
        }
        
        // 3. æ£€æŸ¥æ˜¯å¦ä¸ºä¿ç•™å­—
        if (isReservedShortUrl(customShortUrl)) {
            throw new IllegalArgumentException("è‡ªå®šä¹‰çŸ­é“¾ä¸ºç³»ç»Ÿä¿ç•™å­—");
        }
        
        return customShortUrl;
    }
    
    /**
     * éªŒè¯è‡ªå®šä¹‰çŸ­é“¾æ ¼å¼
     */
    private boolean isValidCustomShortUrl(String shortUrl) {
        if (StringUtils.isBlank(shortUrl)) {
            return false;
        }
        
        // é•¿åº¦é™åˆ¶
        if (shortUrl.length() < 3 || shortUrl.length() > 20) {
            return false;
        }
        
        // å­—ç¬¦é™åˆ¶ï¼šåªå…è®¸å­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿ã€è¿å­—ç¬¦
        return shortUrl.matches("^[a-zA-Z0-9_-]+$");
    }
    
    /**
     * æ£€æŸ¥æ˜¯å¦ä¸ºä¿ç•™å­—
     */
    private boolean isReservedShortUrl(String shortUrl) {
        Set<String> reservedWords = Set.of(
            "api", "admin", "www", "app", "mobile", "web",
            "help", "about", "contact", "privacy", "terms",
            "login", "register", "dashboard", "profile"
        );
        
        return reservedWords.contains(shortUrl.toLowerCase());
    }
    
    /**
     * URLæ ‡å‡†åŒ–
     */
    private String normalizeUrl(String url) {
        try {
            URL urlObj = new URL(url);
            
            // ç§»é™¤fragment
            String normalizedUrl = urlObj.getProtocol() + "://" + 
                                 urlObj.getHost() + 
                                 (urlObj.getPort() != -1 ? ":" + urlObj.getPort() : "") +
                                 urlObj.getPath() +
                                 (StringUtils.isNotBlank(urlObj.getQuery()) ? "?" + urlObj.getQuery() : "");
            
            // ç§»é™¤æœ«å°¾æ–œæ 
            if (normalizedUrl.endsWith("/") && normalizedUrl.length() > 1) {
                normalizedUrl = normalizedUrl.substring(0, normalizedUrl.length() - 1);
            }
            
            return normalizedUrl;
            
        } catch (MalformedURLException e) {
            throw new IllegalArgumentException("URLæ ¼å¼é”™è¯¯: " + url);
        }
    }
    
    /**
     * è®¡ç®—è¿‡æœŸæ—¶é—´
     */
    private Date calculateExpiryDate() {
        // é»˜è®¤1å¹´è¿‡æœŸ
        Calendar calendar = Calendar.getInstance();
        calendar.add(Calendar.YEAR, 1);
        return calendar.getTime();
    }
    
    /**
     * æ›´æ–°ç¼“å­˜
     */
    private void updateCache(String shortUrl, String originalUrl) {
        try {
            // çŸ­é“¾ -> åŸå§‹URL
            String shortUrlKey = SHORT_URL_PREFIX + shortUrl;
            redisTemplate.opsForValue().set(shortUrlKey, originalUrl, 24, TimeUnit.HOURS);
            
            // URLå“ˆå¸Œ -> çŸ­é“¾
            String urlHash = DigestUtils.md5Hex(originalUrl);
            String urlHashKey = URL_HASH_PREFIX + urlHash;
            redisTemplate.opsForValue().set(urlHashKey, shortUrl, 24, TimeUnit.HOURS);
            
        } catch (Exception e) {
            log.error("ç¼“å­˜æ›´æ–°å¤±è´¥: {}", e.getMessage());
        }
    }
}

/**
 * çŸ­é“¾ç”Ÿæˆç»“æœ
 */
@Data
@AllArgsConstructor
public class ShortUrlResult {
    private boolean success;
    private String shortUrl;
    private boolean isNew;
    private String message;
    
    public static ShortUrlResult success(String shortUrl, boolean isNew) {
        return new ShortUrlResult(true, shortUrl, isNew, "ç”ŸæˆæˆåŠŸ");
    }
    
    public static ShortUrlResult failure(String message) {
        return new ShortUrlResult(false, null, false, message);
    }
}

/**
 * URLçŠ¶æ€æšä¸¾
 */
public enum UrlStatus {
    ACTIVE,     // æ´»è·ƒ
    EXPIRED,    // å·²è¿‡æœŸ
    DISABLED,   // å·²ç¦ç”¨
    DELETED     // å·²åˆ é™¤
}
```

#### 5.1.8 å¸ƒéš†è¿‡æ»¤å™¨é…ç½®

**å¸ƒéš†è¿‡æ»¤å™¨é…ç½®**
```java
@Configuration
public class BloomFilterConfig {
    
    @Bean
    public BloomFilter<String> urlBloomFilter() {
        // é¢„æœŸæ’å…¥100ä¸‡ä¸ªURLï¼Œè¯¯åˆ¤ç‡0.01%
        return BloomFilter.create(
            Funnels.stringFunnel(Charset.defaultCharset()),
            1_000_000,
            0.0001
        );
    }
}
```

#### 5.1.9 æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

**æ‰¹é‡çŸ­é“¾ç”Ÿæˆ**
```java
@Service
public class BatchShortUrlService {
    
    @Autowired
    private ShortUrlGeneratorService shortUrlGeneratorService;
    
    /**
     * æ‰¹é‡ç”ŸæˆçŸ­é“¾
     */
    @Async
    public CompletableFuture<List<ShortUrlResult>> batchGenerateShortUrls(
            List<String> urls, Long userId) {
        
        List<ShortUrlResult> results = new ArrayList<>();
        
        // å¹¶è¡Œå¤„ç†
        List<CompletableFuture<ShortUrlResult>> futures = urls.stream()
            .map(url -> CompletableFuture.supplyAsync(() -> 
                shortUrlGeneratorService.generateShortUrl(url, null, userId)))
            .collect(Collectors.toList());
        
        // ç­‰å¾…æ‰€æœ‰ä»»åŠ¡å®Œæˆ
        CompletableFuture.allOf(futures.toArray(new CompletableFuture[0]))
            .join();
        
        // æ”¶é›†ç»“æœ
        for (CompletableFuture<ShortUrlResult> future : futures) {
            try {
                results.add(future.get());
            } catch (Exception e) {
                results.add(ShortUrlResult.failure("æ‰¹é‡å¤„ç†å¼‚å¸¸: " + e.getMessage()));
            }
        }
        
        return CompletableFuture.completedFuture(results);
    }
}
```

#### 5.1.10 å•å…ƒæµ‹è¯•

```java
@SpringBootTest
class ShortUrlGeneratorServiceTest {
    
    @Autowired
    private ShortUrlGeneratorService shortUrlGeneratorService;
    
    @Autowired
    private Base62Encoder base62Encoder;
    
    @Test
    void testBase62Encoding() {
        long id = 123456789L;
        String encoded = base62Encoder.encode(id);
        long decoded = base62Encoder.decode(encoded);
        
        assertEquals(id, decoded);
        assertTrue(encoded.length() <= 8);
    }
    
    @Test
    void testShortUrlGeneration() {
        String originalUrl = "https://www.example.com/very/long/path?param=value";
        
        ShortUrlResult result = shortUrlGeneratorService.generateShortUrl(
            originalUrl, null, 1L);
        
        assertTrue(result.isSuccess());
        assertNotNull(result.getShortUrl());
        assertTrue(result.getShortUrl().length() >= 6);
    }
    
    @Test
    void testDuplicateUrlHandling() {
        String originalUrl = "https://www.example.com/test";
        
        // ç¬¬ä¸€æ¬¡ç”Ÿæˆ
        ShortUrlResult result1 = shortUrlGeneratorService.generateShortUrl(
            originalUrl, null, 1L);
        
        // ç¬¬äºŒæ¬¡ç”Ÿæˆç›¸åŒURL
        ShortUrlResult result2 = shortUrlGeneratorService.generateShortUrl(
            originalUrl, null, 1L);
        
        assertTrue(result1.isSuccess());
        assertTrue(result2.isSuccess());
        assertEquals(result1.getShortUrl(), result2.getShortUrl());
        assertTrue(result1.isNew());
        assertFalse(result2.isNew());
    }
    
    @Test
    void testCustomShortUrl() {
        String originalUrl = "https://www.example.com/custom";
        String customShortUrl = "my-custom-link";
        
        ShortUrlResult result = shortUrlGeneratorService.generateShortUrl(
            originalUrl, customShortUrl, 1L);
        
        assertTrue(result.isSuccess());
        assertEquals(customShortUrl, result.getShortUrl());
    }
}
```

#### 5.1.1 URLæ ¼å¼éªŒè¯å®ç°

**åŸºç¡€URLéªŒè¯å™¨**
```java
@Component
public class URLValidator {
    
    private static final String URL_REGEX = 
        "^(https?://)?" +                     // åè®® (å¯é€‰)
        "([\\w\\-]+\\.)+[\\w\\-]+" +          // åŸŸå
        "(:[0-9]+)?" +                        // ç«¯å£ (å¯é€‰)
        "(/[\\w\\-._~:/?#[\\]@!$&'()*+,;=]*)?" + // è·¯å¾„ (å¯é€‰)
        "$";
    
    private static final Pattern URL_PATTERN = Pattern.compile(URL_REGEX);
    
    /**
     * éªŒè¯URLæ ¼å¼æ˜¯å¦åˆæ³•
     */
    public ValidationResult validateURL(String url) {
        if (StringUtils.isBlank(url)) {
            return ValidationResult.fail("URLä¸èƒ½ä¸ºç©º");
        }
        
        // 1. åŸºç¡€æ ¼å¼éªŒè¯
        if (!URL_PATTERN.matcher(url).matches()) {
            return ValidationResult.fail("URLæ ¼å¼ä¸æ­£ç¡®");
        }
        
        // 2. åè®®éªŒè¯
        String normalizedUrl = normalizeURL(url);
        if (!normalizedUrl.startsWith("http://") && !normalizedUrl.startsWith("https://")) {
            return ValidationResult.fail("ä»…æ”¯æŒHTTP/HTTPSåè®®");
        }
        
        // 3. Java URLç±»éªŒè¯
        try {
            URL urlObj = new URL(normalizedUrl);
            
            // éªŒè¯ä¸»æœºå
            String host = urlObj.getHost();
            if (StringUtils.isBlank(host)) {
                return ValidationResult.fail("æ— æ•ˆçš„ä¸»æœºå");
            }
            
            // éªŒè¯ç«¯å£
            int port = urlObj.getPort();
            if (port != -1 && (port < 1 || port > 65535)) {
                return ValidationResult.fail("ç«¯å£å·è¶…å‡ºæœ‰æ•ˆèŒƒå›´");
            }
            
            // éªŒè¯URLé•¿åº¦
            if (normalizedUrl.length() > 2048) {
                return ValidationResult.fail("URLé•¿åº¦è¶…è¿‡é™åˆ¶(2048å­—ç¬¦)");
            }
            
            return ValidationResult.success(normalizedUrl);
            
        } catch (MalformedURLException e) {
            return ValidationResult.fail("URLæ ¼å¼é”™è¯¯: " + e.getMessage());
        }
    }
    
    /**
     * æ ‡å‡†åŒ–URLæ ¼å¼
     */
    private String normalizeURL(String url) {
        if (!url.startsWith("http://") && !url.startsWith("https://")) {
            return "https://" + url;
        }
        return url;
    }
}

/**
 * éªŒè¯ç»“æœå°è£…ç±»
 */
@Data
@AllArgsConstructor
public class ValidationResult {
    private boolean valid;
    private String message;
    private String normalizedUrl;
    
    public static ValidationResult success(String normalizedUrl) {
        return new ValidationResult(true, "éªŒè¯é€šè¿‡", normalizedUrl);
    }
    
    public static ValidationResult fail(String message) {
        return new ValidationResult(false, message, null);
    }
}
```

#### 5.1.2 æ¶æ„é“¾æ¥æ£€æµ‹å®ç°

**æ¶æ„é“¾æ¥æ£€æµ‹å™¨**
```java
@Service
@Slf4j
public class MaliciousLinkDetector {
    
    @Autowired
    private BlacklistRepository blacklistRepository;
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    @Autowired
    private SafeBrowsingService safeBrowsingService;
    
    private static final String CACHE_PREFIX = "url_security:";
    private static final int CACHE_TTL = 3600; // 1å°æ—¶
    
    /**
     * æ£€æµ‹URLæ˜¯å¦ä¸ºæ¶æ„é“¾æ¥
     */
    public SecurityCheckResult checkMaliciousLink(String url) {
        try {
            // 1. ç¼“å­˜æ£€æŸ¥
            SecurityCheckResult cachedResult = getCachedResult(url);
            if (cachedResult != null) {
                return cachedResult;
            }
            
            // 2. é»‘åå•æ£€æŸ¥
            SecurityCheckResult blacklistResult = checkBlacklist(url);
            if (!blacklistResult.isSafe()) {
                cacheResult(url, blacklistResult);
                return blacklistResult;
            }
            
            // 3. åŸŸåä¿¡èª‰æ£€æŸ¥
            SecurityCheckResult reputationResult = checkDomainReputation(url);
            if (!reputationResult.isSafe()) {
                cacheResult(url, reputationResult);
                return reputationResult;
            }
            
            // 4. ç¬¬ä¸‰æ–¹APIæ£€æŸ¥ (å¼‚æ­¥)
            CompletableFuture.runAsync(() -> {
                SecurityCheckResult apiResult = checkWithThirdPartyAPI(url);
                if (!apiResult.isSafe()) {
                    // æ›´æ–°ç¼“å­˜å’Œæ•°æ®åº“
                    cacheResult(url, apiResult);
                    addToBlacklist(url, apiResult.getReason());
                }
            });
            
            SecurityCheckResult safeResult = SecurityCheckResult.safe();
            cacheResult(url, safeResult);
            return safeResult;
            
        } catch (Exception e) {
            log.error("æ¶æ„é“¾æ¥æ£€æµ‹å¼‚å¸¸: {}", e.getMessage(), e);
            return SecurityCheckResult.unknown("æ£€æµ‹æœåŠ¡å¼‚å¸¸");
        }
    }
    
    /**
     * é»‘åå•æ£€æŸ¥
     */
    private SecurityCheckResult checkBlacklist(String url) {
        try {
            URL urlObj = new URL(url);
            String domain = urlObj.getHost();
            String path = urlObj.getPath();
            
            // æ£€æŸ¥åŸŸåé»‘åå•
            if (blacklistRepository.existsByDomain(domain)) {
                return SecurityCheckResult.malicious("åŸŸååœ¨é»‘åå•ä¸­");
            }
            
            // æ£€æŸ¥å®Œæ•´URLé»‘åå•
            if (blacklistRepository.existsByFullUrl(url)) {
                return SecurityCheckResult.malicious("URLåœ¨é»‘åå•ä¸­");
            }
            
            // æ£€æŸ¥å…³é”®è¯é»‘åå•
            List<String> keywords = blacklistRepository.findAllKeywords();
            for (String keyword : keywords) {
                if (url.toLowerCase().contains(keyword.toLowerCase())) {
                    return SecurityCheckResult.malicious("åŒ…å«æ¶æ„å…³é”®è¯: " + keyword);
                }
            }
            
            return SecurityCheckResult.safe();
            
        } catch (Exception e) {
            log.error("é»‘åå•æ£€æŸ¥å¼‚å¸¸: {}", e.getMessage());
            return SecurityCheckResult.unknown("é»‘åå•æ£€æŸ¥å¤±è´¥");
        }
    }
    
    /**
     * åŸŸåä¿¡èª‰æ£€æŸ¥
     */
    private SecurityCheckResult checkDomainReputation(String url) {
        try {
            URL urlObj = new URL(url);
            String domain = urlObj.getHost();
            
            // æ£€æŸ¥æ˜¯å¦ä¸ºå·²çŸ¥çš„æ¶æ„åŸŸååç¼€
            String[] maliciousSuffixes = {".tk", ".ml", ".ga", ".cf"};
            for (String suffix : maliciousSuffixes) {
                if (domain.endsWith(suffix)) {
                    return SecurityCheckResult.suspicious("ä½¿ç”¨å¯ç–‘åŸŸååç¼€");
                }
            }
            
            // æ£€æŸ¥åŸŸåé•¿åº¦å’Œå­—ç¬¦
            if (domain.length() > 50) {
                return SecurityCheckResult.suspicious("åŸŸåè¿‡é•¿");
            }
            
            // æ£€æŸ¥æ˜¯å¦åŒ…å«è¿‡å¤šæ•°å­—æˆ–ç‰¹æ®Šå­—ç¬¦
            long digitCount = domain.chars().filter(Character::isDigit).count();
            if (digitCount > domain.length() * 0.5) {
                return SecurityCheckResult.suspicious("åŸŸååŒ…å«è¿‡å¤šæ•°å­—");
            }
            
            return SecurityCheckResult.safe();
            
        } catch (Exception e) {
            log.error("åŸŸåä¿¡èª‰æ£€æŸ¥å¼‚å¸¸: {}", e.getMessage());
            return SecurityCheckResult.unknown("åŸŸåä¿¡èª‰æ£€æŸ¥å¤±è´¥");
        }
    }
    
    /**
     * ç¬¬ä¸‰æ–¹APIæ£€æŸ¥ (Google Safe Browsing)
     */
    private SecurityCheckResult checkWithThirdPartyAPI(String url) {
        try {
            // è°ƒç”¨Google Safe Browsing API
            SafeBrowsingResponse response = safeBrowsingService.checkURL(url);
            
            if (response.isThreat()) {
                return SecurityCheckResult.malicious("ç¬¬ä¸‰æ–¹APIæ£€æµ‹ä¸ºå¨èƒ: " + response.getThreatType());
            }
            
            return SecurityCheckResult.safe();
            
        } catch (Exception e) {
            log.error("ç¬¬ä¸‰æ–¹APIæ£€æŸ¥å¼‚å¸¸: {}", e.getMessage());
            return SecurityCheckResult.unknown("ç¬¬ä¸‰æ–¹APIæ£€æŸ¥å¤±è´¥");
        }
    }
    
    /**
     * ç¼“å­˜æ£€æŸ¥ç»“æœ
     */
    private SecurityCheckResult getCachedResult(String url) {
        try {
            String cacheKey = CACHE_PREFIX + DigestUtils.md5Hex(url);
            return (SecurityCheckResult) redisTemplate.opsForValue().get(cacheKey);
        } catch (Exception e) {
            log.error("ç¼“å­˜è¯»å–å¼‚å¸¸: {}", e.getMessage());
            return null;
        }
    }
    
    /**
     * ç¼“å­˜æ£€æŸ¥ç»“æœ
     */
    private void cacheResult(String url, SecurityCheckResult result) {
        try {
            String cacheKey = CACHE_PREFIX + DigestUtils.md5Hex(url);
            redisTemplate.opsForValue().set(cacheKey, result, CACHE_TTL, TimeUnit.SECONDS);
        } catch (Exception e) {
            log.error("ç¼“å­˜å†™å…¥å¼‚å¸¸: {}", e.getMessage());
        }
    }
    
    /**
     * æ·»åŠ åˆ°é»‘åå•
     */
    private void addToBlacklist(String url, String reason) {
        try {
            URL urlObj = new URL(url);
            BlacklistEntity blacklist = new BlacklistEntity();
            blacklist.setDomain(urlObj.getHost());
            blacklist.setFullUrl(url);
            blacklist.setReason(reason);
            blacklist.setCreatedAt(new Date());
            blacklistRepository.save(blacklist);
        } catch (Exception e) {
            log.error("æ·»åŠ é»‘åå•å¼‚å¸¸: {}", e.getMessage());
        }
    }
}

/**
 * å®‰å…¨æ£€æŸ¥ç»“æœ
 */
@Data
@AllArgsConstructor
public class SecurityCheckResult {
    private boolean safe;
    private String status; // SAFE, MALICIOUS, SUSPICIOUS, UNKNOWN
    private String reason;
    
    public static SecurityCheckResult safe() {
        return new SecurityCheckResult(true, "SAFE", "å®‰å…¨");
    }
    
    public static SecurityCheckResult malicious(String reason) {
        return new SecurityCheckResult(false, "MALICIOUS", reason);
    }
    
    public static SecurityCheckResult suspicious(String reason) {
        return new SecurityCheckResult(false, "SUSPICIOUS", reason);
    }
    
    public static SecurityCheckResult unknown(String reason) {
        return new SecurityCheckResult(false, "UNKNOWN", reason);
    }
}
```

#### 5.1.3 URLå®‰å…¨æœåŠ¡æ•´åˆ

**URLå®‰å…¨æœåŠ¡**
```java
@Service
@Slf4j
public class URLSecurityService {
    
    @Autowired
    private URLValidator urlValidator;
    
    @Autowired
    private MaliciousLinkDetector maliciousLinkDetector;
    
    /**
     * å®Œæ•´çš„URLå®‰å…¨æ£€æŸ¥
     */
    public URLSecurityResult validateAndCheck(String url) {
        // 1. URLæ ¼å¼éªŒè¯
        ValidationResult validationResult = urlValidator.validateURL(url);
        if (!validationResult.isValid()) {
            return URLSecurityResult.invalid(validationResult.getMessage());
        }
        
        String normalizedUrl = validationResult.getNormalizedUrl();
        
        // 2. æ¶æ„é“¾æ¥æ£€æµ‹
        SecurityCheckResult securityResult = maliciousLinkDetector.checkMaliciousLink(normalizedUrl);
        if (!securityResult.isSafe()) {
            return URLSecurityResult.unsafe(normalizedUrl, securityResult.getReason());
        }
        
        return URLSecurityResult.safe(normalizedUrl);
    }
}

/**
 * URLå®‰å…¨æ£€æŸ¥ç»“æœ
 */
@Data
@AllArgsConstructor
public class URLSecurityResult {
    private boolean valid;
    private boolean safe;
    private String normalizedUrl;
    private String message;
    
    public static URLSecurityResult safe(String normalizedUrl) {
        return new URLSecurityResult(true, true, normalizedUrl, "URLå®‰å…¨");
    }
    
    public static URLSecurityResult unsafe(String normalizedUrl, String reason) {
        return new URLSecurityResult(true, false, normalizedUrl, reason);
    }
    
    public static URLSecurityResult invalid(String message) {
        return new URLSecurityResult(false, false, null, message);
    }
    
    public boolean isValidAndSafe() {
        return valid && safe;
    }
}
```

#### 5.1.4 æ•°æ®åº“è¡¨ç»“æ„

**é»‘åå•è¡¨**
```sql
CREATE TABLE url_blacklist (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    domain VARCHAR(255) NOT NULL COMMENT 'åŸŸå',
    full_url TEXT COMMENT 'å®Œæ•´URL',
    keyword VARCHAR(100) COMMENT 'æ¶æ„å…³é”®è¯',
    reason VARCHAR(500) NOT NULL COMMENT 'åŠ å…¥é»‘åå•åŸå› ',
    threat_type ENUM('MALWARE', 'PHISHING', 'SPAM', 'SUSPICIOUS') DEFAULT 'SUSPICIOUS',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_domain (domain),
    INDEX idx_keyword (keyword),
    INDEX idx_threat_type (threat_type)
);
```

#### 5.1.5 é…ç½®å’Œä½¿ç”¨ç¤ºä¾‹

**æ§åˆ¶å™¨ä½¿ç”¨ç¤ºä¾‹**
```java
@RestController
@RequestMapping("/api/url")
public class URLController {
    
    @Autowired
    private URLSecurityService urlSecurityService;
    
    @PostMapping("/shorten")
    public ResponseEntity<ApiResponse> shortenURL(@RequestBody ShortenRequest request) {
        try {
            // URLå®‰å…¨æ£€æŸ¥
            URLSecurityResult securityResult = urlSecurityService.validateAndCheck(request.getUrl());
            
            if (!securityResult.isValidAndSafe()) {
                return ResponseEntity.badRequest()
                    .body(ApiResponse.error(securityResult.getMessage()));
            }
            
            // ç»§ç»­çŸ­é“¾ç”Ÿæˆé€»è¾‘...
            String shortUrl = shortUrlService.createShortUrl(securityResult.getNormalizedUrl());
            
            return ResponseEntity.ok(ApiResponse.success(shortUrl));
            
        } catch (Exception e) {
            log.error("çŸ­é“¾ç”Ÿæˆå¼‚å¸¸: {}", e.getMessage(), e);
            return ResponseEntity.status(500)
                .body(ApiResponse.error("æœåŠ¡å¼‚å¸¸ï¼Œè¯·ç¨åé‡è¯•"));
        }
    }
}
```

#### 5.1.6 å•å…ƒæµ‹è¯•ç¤ºä¾‹

```java
@SpringBootTest
class URLValidatorTest {
    
    @Autowired
    private URLValidator urlValidator;
    
    @Test
    void testValidURL() {
        ValidationResult result = urlValidator.validateURL("https://www.example.com");
        assertTrue(result.isValid());
        assertEquals("https://www.example.com", result.getNormalizedUrl());
    }
    
    @Test
    void testInvalidURL() {
        ValidationResult result = urlValidator.validateURL("invalid-url");
        assertFalse(result.isValid());
        assertNotNull(result.getMessage());
    }
    
    @Test
    void testURLNormalization() {
        ValidationResult result = urlValidator.validateURL("example.com");
        assertTrue(result.isValid());
        assertEquals("https://example.com", result.getNormalizedUrl());
    }
}
```

### 5.2 URLé‡å®šå‘åŠŸèƒ½
- **å¿«é€Ÿé‡å®šå‘**ï¼šé€šè¿‡çŸ­é“¾å¿«é€ŸæŸ¥æ‰¾åŸå§‹URLï¼Œæ‰§è¡Œé‡å®šå‘ï¼ˆ301/302å¯é…ç½®ï¼‰

## 7. é‡å®šå‘ç­–ç•¥è®¾è®¡ï¼š301 vs 302 é€‰æ‹©

### 7.1 é‡å®šå‘ç±»å‹å¯¹æ¯”åˆ†æ

| ç‰¹æ€§ | 301 Moved Permanently | 302 Found | æ¨èåœºæ™¯ |
|------|----------------------|-----------|----------|
| **ç¼“å­˜è¡Œä¸º** | æµè§ˆå™¨ä¼šç¼“å­˜é‡å®šå‘ | æµè§ˆå™¨ä¸ç¼“å­˜ï¼Œæ¯æ¬¡éƒ½è¯·æ±‚ | 302é€‚åˆéœ€è¦ç»Ÿè®¡çš„åœºæ™¯ |
| **SEOå½±å“** | æƒé‡è½¬ç§»åˆ°ç›®æ ‡URL | æƒé‡ä¿ç•™åœ¨çŸ­URL | 302é€‚åˆçŸ­URLç³»ç»Ÿ |
| **æ•°æ®ç»Ÿè®¡** | æ— æ³•ç»Ÿè®¡åç»­è®¿é—® | å¯ä»¥ç»Ÿè®¡æ‰€æœ‰è®¿é—® | 302æ”¯æŒå®Œæ•´æ•°æ®åˆ†æ |
| **æ€§èƒ½å½±å“** | å‡å°‘æœåŠ¡å™¨è¯·æ±‚ | å¢åŠ æœåŠ¡å™¨è´Ÿè½½ | 301é€‚åˆé«˜é¢‘è®¿é—®åœºæ™¯ |
| **çµæ´»æ€§** | æ— æ³•åŠ¨æ€ä¿®æ”¹ç›®æ ‡ | æ”¯æŒåŠ¨æ€ä¿®æ”¹ç›®æ ‡URL | 302æ”¯æŒA/Bæµ‹è¯• |

### 7.2 çŸ­URLç³»ç»Ÿé‡å®šå‘ç­–ç•¥

#### æ¨èç­–ç•¥ï¼š
1. **é»˜è®¤ä½¿ç”¨302**ï¼šæ»¡è¶³æ•°æ®ç»Ÿè®¡å’Œçµæ´»æ€§éœ€æ±‚
2. **ç‰¹æ®Šåœºæ™¯ä½¿ç”¨301**ï¼šç¡®å®šä¸å˜ä¸”é«˜é¢‘è®¿é—®çš„é“¾æ¥
3. **æ”¯æŒç”¨æˆ·é…ç½®**ï¼šè®©ç”¨æˆ·æ ¹æ®éœ€æ±‚é€‰æ‹©é‡å®šå‘ç±»å‹

### 7.3 é‡å®šå‘æœåŠ¡å®ç°

#### 7.3.1 é‡å®šå‘ç±»å‹æšä¸¾

```java
/**
 * é‡å®šå‘ç±»å‹æšä¸¾
 */
public enum RedirectType {
    /**
     * 302 ä¸´æ—¶é‡å®šå‘ - é»˜è®¤é€‰æ‹©
     * ä¼˜ç‚¹ï¼šæ”¯æŒæ•°æ®ç»Ÿè®¡ã€åŠ¨æ€ä¿®æ”¹ç›®æ ‡URLã€A/Bæµ‹è¯•
     * ç¼ºç‚¹ï¼šæ¯æ¬¡éƒ½éœ€è¦è¯·æ±‚æœåŠ¡å™¨
     */
    TEMPORARY(302, "Found"),
    
    /**
     * 301 æ°¸ä¹…é‡å®šå‘ - ç‰¹æ®Šåœºæ™¯
     * ä¼˜ç‚¹ï¼šæµè§ˆå™¨ç¼“å­˜ï¼Œå‡å°‘æœåŠ¡å™¨å‹åŠ›
     * ç¼ºç‚¹ï¼šæ— æ³•ç»Ÿè®¡æ•°æ®ã€æ— æ³•ä¿®æ”¹ç›®æ ‡URL
     */
    PERMANENT(301, "Moved Permanently");
    
    private final int code;
    private final String description;
    
    RedirectType(int code, String description) {
        this.code = code;
        this.description = description;
    }
    
    public int getCode() { return code; }
    public String getDescription() { return description; }
}
```

#### 7.3.2 é‡å®šå‘é…ç½®

301çš„åœºæ™¯ï¼šé«˜é¢‘è®¿é—® + ç™½åå•åŸŸå + ç”¨æˆ·é…ç½®

```java
/**
 * é‡å®šå‘é…ç½®
 */
@Configuration
@ConfigurationProperties(prefix = "shorturl.redirect")
@Data
public class RedirectConfig {
    
    /**
     * é»˜è®¤é‡å®šå‘ç±»å‹
     */
    private RedirectType defaultType = RedirectType.TEMPORARY;
    
    /**
     * æ˜¯å¦å¯ç”¨ç»Ÿè®¡
     */
    private boolean enableStatistics = true;
    
    /**
     * æ˜¯å¦å¯ç”¨ç¼“å­˜
     */
    private boolean enableCache = true;
    
    /**
     * ç¼“å­˜è¿‡æœŸæ—¶é—´ï¼ˆç§’ï¼‰
     */
    private int cacheExpireSeconds = 300;
    
    /**
     * 301é‡å®šå‘çš„åŸŸåç™½åå•
     */
    private Set<String> permanentRedirectDomains = new HashSet<>();
    
    /**
     * é«˜é¢‘è®¿é—®é˜ˆå€¼ï¼ˆæ¯å°æ—¶è®¿é—®æ¬¡æ•°ï¼‰
     */
    private int highFrequencyThreshold = 1000;
}
```

#### 7.3.3 ç‚¹å‡»ç»Ÿè®¡æœåŠ¡

```java
/**
 * ç‚¹å‡»ç»Ÿè®¡æœåŠ¡
 */
@Service
@Slf4j
public class ClickStatisticsService {
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    @Autowired
    private ClickStatsRepository clickStatsRepository;
    
    /**
     * å¼‚æ­¥è®°å½•ç‚¹å‡»ç»Ÿè®¡
     */
    @Async("statisticsExecutor")
    public CompletableFuture<Void> recordClickAsync(String shortCode, HttpServletRequest request) {
        try {
            ClickStatistics stats = buildClickStatistics(shortCode, request);
            
            // 1. å®æ—¶è®¡æ•°ï¼ˆRedisï¼‰
            updateRealTimeStats(shortCode);
            
            // 2. è¯¦ç»†ç»Ÿè®¡ï¼ˆå¼‚æ­¥å…¥åº“ï¼‰
            clickStatsRepository.save(stats);
            
            log.debug("ç‚¹å‡»ç»Ÿè®¡è®°å½•æˆåŠŸ: shortCode={}", shortCode);
            
        } catch (Exception e) {
            log.error("è®°å½•ç‚¹å‡»ç»Ÿè®¡å¤±è´¥: shortCode={}", shortCode, e);
        }
        
        return CompletableFuture.completedFuture(null);
    }
    
    /**
     * æ„å»ºç‚¹å‡»ç»Ÿè®¡å¯¹è±¡
     */
    private ClickStatistics buildClickStatistics(String shortCode, HttpServletRequest request) {
        return ClickStatistics.builder()
                .shortCode(shortCode)
                .ip(getClientIp(request))
                .userAgent(request.getHeader("User-Agent"))
                .referer(request.getHeader("Referer"))
                .clickTime(LocalDateTime.now())
                .build();
    }
    
    /**
     * æ›´æ–°å®æ—¶ç»Ÿè®¡
     */
    private void updateRealTimeStats(String shortCode) {
        String key = "stats:click:" + shortCode;
        redisTemplate.opsForValue().increment(key);
        redisTemplate.expire(key, Duration.ofDays(7));
    }
    
    /**
     * è·å–å®¢æˆ·ç«¯IP
     */
    private String getClientIp(HttpServletRequest request) {
        String ip = request.getHeader("X-Forwarded-For");
        if (StringUtils.isBlank(ip) || "unknown".equalsIgnoreCase(ip)) {
            ip = request.getHeader("X-Real-IP");
        }
        if (StringUtils.isBlank(ip) || "unknown".equalsIgnoreCase(ip)) {
            ip = request.getRemoteAddr();
        }
        return ip;
    }
}
```

#### 7.3.4 é‡å®šå‘æœåŠ¡æ ¸å¿ƒå®ç°

```java
/**
 * é‡å®šå‘æœåŠ¡
 */
@Service
@Slf4j
public class RedirectService {
    
    @Autowired
    private UrlMappingRepository urlMappingRepository;
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    @Autowired
    private ClickStatisticsService statisticsService;
    
    @Autowired
    private RedirectConfig redirectConfig;
    
    /**
     * æ‰§è¡Œé‡å®šå‘
     */
    public RedirectResult redirect(String shortCode, HttpServletRequest request) {
        try {
            // 1. æŸ¥æ‰¾URLæ˜ å°„
            UrlMappingEntity mapping = findUrlMapping(shortCode);
            if (mapping == null) {
                return RedirectResult.notFound();
            }
            
            // 2. æ£€æŸ¥URLçŠ¶æ€
            if (!isUrlActive(mapping)) {
                return RedirectResult.expired();
            }
            
            // 3. ç¡®å®šé‡å®šå‘ç±»å‹
            RedirectType redirectType = determineRedirectType(mapping);
            
            // 4. è®°å½•ç»Ÿè®¡ï¼ˆå¼‚æ­¥ï¼‰
            if (redirectConfig.isEnableStatistics() && redirectType == RedirectType.TEMPORARY) {
                statisticsService.recordClickAsync(shortCode, request);
            }
            
            // 5. è¿”å›é‡å®šå‘ç»“æœ
            return RedirectResult.success(mapping.getOriginalUrl(), redirectType);
            
        } catch (Exception e) {
            log.error("é‡å®šå‘å¤„ç†å¤±è´¥: shortCode={}", shortCode, e);
            return RedirectResult.error();
        }
    }
    
    /**
     * æŸ¥æ‰¾URLæ˜ å°„ï¼ˆç¼“å­˜ä¼˜å…ˆï¼‰
     */
    private UrlMappingEntity findUrlMapping(String shortCode) {
        // 1. å°è¯•ä»ç¼“å­˜è·å–
        if (redirectConfig.isEnableCache()) {
            String cacheKey = "mapping:" + shortCode;
            UrlMappingEntity cached = (UrlMappingEntity) redisTemplate.opsForValue().get(cacheKey);
            if (cached != null) {
                return cached;
            }
        }
        
        // 2. ä»æ•°æ®åº“æŸ¥è¯¢
        UrlMappingEntity mapping = urlMappingRepository.findByShortCode(shortCode);
        
        // 3. å†™å…¥ç¼“å­˜
        if (mapping != null && redirectConfig.isEnableCache()) {
            String cacheKey = "mapping:" + shortCode;
            redisTemplate.opsForValue().set(cacheKey, mapping, 
                Duration.ofSeconds(redirectConfig.getCacheExpireSeconds()));
        }
        
        return mapping;
    }
    
    /**
     * æ£€æŸ¥URLæ˜¯å¦æœ‰æ•ˆ
     */
    private boolean isUrlActive(UrlMappingEntity mapping) {
        // æ£€æŸ¥æ˜¯å¦è¿‡æœŸ
        if (mapping.getExpireTime() != null && 
            mapping.getExpireTime().isBefore(LocalDateTime.now())) {
            return false;
        }
        
        // æ£€æŸ¥æ˜¯å¦è¢«ç¦ç”¨
        return mapping.getStatus() == UrlStatus.ACTIVE;
    }
    
    /**
     * ç¡®å®šé‡å®šå‘ç±»å‹
     */
    private RedirectType determineRedirectType(UrlMappingEntity mapping) {
        // 1. ç”¨æˆ·æŒ‡å®šçš„é‡å®šå‘ç±»å‹
        if (mapping.getRedirectType() != null) {
            return mapping.getRedirectType();
        }
        
        // 2. åŸºäºè®¿é—®é¢‘ç‡çš„æ™ºèƒ½é€‰æ‹©
        if (isHighFrequencyUrl(mapping.getShortCode())) {
            // é«˜é¢‘è®¿é—®ä¸”åœ¨ç™½åå•åŸŸåä¸­ï¼Œä½¿ç”¨301
            String domain = extractDomain(mapping.getOriginalUrl());
            if (redirectConfig.getPermanentRedirectDomains().contains(domain)) {
                return RedirectType.PERMANENT;
            }
        }
        
        // 3. é»˜è®¤ä½¿ç”¨é…ç½®çš„ç±»å‹
        return redirectConfig.getDefaultType();
    }
    
    /**
     * åˆ¤æ–­æ˜¯å¦ä¸ºé«˜é¢‘è®¿é—®URL
     */
    private boolean isHighFrequencyUrl(String shortCode) {
        String key = "stats:click:" + shortCode;
        Object count = redisTemplate.opsForValue().get(key);
        if (count instanceof Number) {
            return ((Number) count).intValue() > redirectConfig.getHighFrequencyThreshold();
        }
        return false;
    }
    
    /**
     * æå–åŸŸå
     */
    private String extractDomain(String url) {
        try {
            return new URL(url).getHost();
        } catch (Exception e) {
            return "";
        }
    }
}
```

#### 7.3.5 é‡å®šå‘ç»“æœå°è£…

```java
/**
 * é‡å®šå‘ç»“æœ
 */
@Data
@Builder
public class RedirectResult {
    private boolean success;
    private String targetUrl;
    private RedirectType redirectType;
    private String errorMessage;
    
    public static RedirectResult success(String targetUrl, RedirectType redirectType) {
        return RedirectResult.builder()
                .success(true)
                .targetUrl(targetUrl)
                .redirectType(redirectType)
                .build();
    }
    
    public static RedirectResult notFound() {
        return RedirectResult.builder()
                .success(false)
                .errorMessage("çŸ­é“¾ä¸å­˜åœ¨")
                .build();
    }
    
    public static RedirectResult expired() {
        return RedirectResult.builder()
                .success(false)
                .errorMessage("çŸ­é“¾å·²è¿‡æœŸ")
                .build();
    }
    
    public static RedirectResult error() {
        return RedirectResult.builder()
                .success(false)
                .errorMessage("ç³»ç»Ÿé”™è¯¯")
                .build();
    }
}
```

#### 7.3.6 é‡å®šå‘æ§åˆ¶å™¨

```java
/**
 * é‡å®šå‘æ§åˆ¶å™¨
 */
@RestController
@Slf4j
public class RedirectController {
    
    @Autowired
    private RedirectService redirectService;
    
    /**
     * çŸ­é“¾é‡å®šå‘
     */
    @GetMapping("/{shortCode}")
    public ResponseEntity<Void> redirect(@PathVariable String shortCode, 
                                       HttpServletRequest request) {
        
        // å‚æ•°éªŒè¯
        if (!isValidShortCode(shortCode)) {
            return ResponseEntity.notFound().build();
        }
        
        // æ‰§è¡Œé‡å®šå‘
        RedirectResult result = redirectService.redirect(shortCode, request);
        
        if (!result.isSuccess()) {
            log.warn("é‡å®šå‘å¤±è´¥: shortCode={}, error={}", shortCode, result.getErrorMessage());
            return ResponseEntity.notFound().build();
        }
        
        // æ„å»ºé‡å®šå‘å“åº”
        HttpHeaders headers = new HttpHeaders();
        headers.setLocation(URI.create(result.getTargetUrl()));
        
        // æ ¹æ®é‡å®šå‘ç±»å‹è¿”å›ä¸åŒçš„çŠ¶æ€ç 
        HttpStatus status = result.getRedirectType() == RedirectType.PERMANENT 
                ? HttpStatus.MOVED_PERMANENTLY 
                : HttpStatus.FOUND;
        
        log.info("é‡å®šå‘æˆåŠŸ: {} -> {}, type={}", shortCode, result.getTargetUrl(), 
                result.getRedirectType());
        
        return new ResponseEntity<>(headers, status);
    }
    
    /**
     * éªŒè¯çŸ­ç æ ¼å¼
     */
    private boolean isValidShortCode(String shortCode) {
        return StringUtils.isNotBlank(shortCode) && 
               shortCode.matches("^[a-zA-Z0-9]{4,8}$");
    }
}
```

### 7.4 é‡å®šå‘ç­–ç•¥é…ç½®ç¤ºä¾‹

```yaml
# application.yml
shorturl:
  redirect:
    # é»˜è®¤é‡å®šå‘ç±»å‹ï¼šTEMPORARY(302) æˆ– PERMANENT(301)
    default-type: TEMPORARY
    # æ˜¯å¦å¯ç”¨ç»Ÿè®¡
    enable-statistics: true
    # æ˜¯å¦å¯ç”¨ç¼“å­˜
    enable-cache: true
    # ç¼“å­˜è¿‡æœŸæ—¶é—´ï¼ˆç§’ï¼‰
    cache-expire-seconds: 300
    # é«˜é¢‘è®¿é—®é˜ˆå€¼ï¼ˆæ¯å°æ—¶ï¼‰
    high-frequency-threshold: 1000
    # 301é‡å®šå‘ç™½åå•åŸŸå
    permanent-redirect-domains:
      - "docs.company.com"
      - "help.company.com"
```

### 7.5 æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

#### 7.5.1 ç¼“å­˜ç­–ç•¥
```java
/**
 * å¤šçº§ç¼“å­˜é…ç½®
 */
@Configuration
public class RedirectCacheConfig {
    
    /**
     * æœ¬åœ°ç¼“å­˜ï¼ˆCaffeineï¼‰
     */
    @Bean
    public Cache<String, UrlMappingEntity> localCache() {
        return Caffeine.newBuilder()
                .maximumSize(10000)
                .expireAfterWrite(Duration.ofMinutes(5))
                .recordStats()
                .build();
    }
    
    /**
     * åˆ†å¸ƒå¼ç¼“å­˜ï¼ˆRedisï¼‰
     */
    @Bean
    public RedisTemplate<String, Object> redisTemplate(RedisConnectionFactory factory) {
        RedisTemplate<String, Object> template = new RedisTemplate<>();
        template.setConnectionFactory(factory);
        template.setKeySerializer(new StringRedisSerializer());
        template.setValueSerializer(new GenericJackson2JsonRedisSerializer());
        return template;
    }
}
```

### 7.6 ç›‘æ§å’Œå‘Šè­¦

```java
/**
 * é‡å®šå‘ç›‘æ§
 */
@Component
@Slf4j
public class RedirectMonitor {
    
    private final MeterRegistry meterRegistry;
    private final Counter redirectCounter;
    private final Timer redirectTimer;
    
    public RedirectMonitor(MeterRegistry meterRegistry) {
        this.meterRegistry = meterRegistry;
        this.redirectCounter = Counter.builder("redirect.count")
                .description("é‡å®šå‘æ¬¡æ•°ç»Ÿè®¡")
                .register(meterRegistry);
        this.redirectTimer = Timer.builder("redirect.duration")
                .description("é‡å®šå‘è€—æ—¶ç»Ÿè®¡")
                .register(meterRegistry);
    }
    
    /**
     * è®°å½•é‡å®šå‘æŒ‡æ ‡
     */
    public void recordRedirect(RedirectType type, boolean success, Duration duration) {
        redirectCounter.increment(
                Tags.of(
                        "type", type.name(),
                        "success", String.valueOf(success)
                )
        );
        
        redirectTimer.record(duration);
    }
}
```

### 7.7 æœ€ä½³å®è·µå»ºè®®

#### 7.7.1 é€‰æ‹©ç­–ç•¥
1. **è¥é”€æ´»åŠ¨é“¾æ¥**ï¼šä½¿ç”¨302ï¼Œéœ€è¦è¯¦ç»†ç»Ÿè®¡å’ŒA/Bæµ‹è¯•
2. **æ–‡æ¡£é“¾æ¥**ï¼šä½¿ç”¨301ï¼Œå‡å°‘æœåŠ¡å™¨å‹åŠ›
3. **APIé‡å®šå‘**ï¼šä½¿ç”¨302ï¼Œæ”¯æŒç‰ˆæœ¬åˆ‡æ¢
4. **ä¸´æ—¶æ´»åŠ¨**ï¼šä½¿ç”¨302ï¼Œæ”¯æŒåŠ¨æ€ä¿®æ”¹

#### 7.7.2 æ€§èƒ½ä¼˜åŒ–
1. **ç¼“å­˜ç­–ç•¥**ï¼šæœ¬åœ°ç¼“å­˜ + Redisç¼“å­˜
2. **å¼‚æ­¥ç»Ÿè®¡**ï¼šé¿å…å½±å“é‡å®šå‘æ€§èƒ½
3. **è¿æ¥æ± **ï¼šä¼˜åŒ–æ•°æ®åº“è¿æ¥
4. **CDNåŠ é€Ÿ**ï¼šé™æ€èµ„æºä½¿ç”¨CDN

#### 7.7.3 ç›‘æ§å‘Šè­¦
1. **é‡å®šå‘æˆåŠŸç‡**ï¼š< 99.9% å‘Šè­¦
2. **å“åº”æ—¶é—´**ï¼š> 100ms å‘Šè­¦
3. **ç¼“å­˜å‘½ä¸­ç‡**ï¼š< 90% å‘Šè­¦
4. **é”™è¯¯ç‡**ï¼š> 0.1% å‘Šè­¦
- **å¤±æ•ˆå¤„ç†**ï¼šæ£€æµ‹é“¾æ¥æœ‰æ•ˆæœŸï¼Œå¤„ç†è¿‡æœŸé“¾æ¥ï¼Œæ˜¾ç¤ºå‹å¥½é”™è¯¯é¡µé¢
- **è®¿é—®ç»Ÿè®¡**ï¼šè®°å½•æ¯æ¬¡è®¿é—®çš„è¯¦ç»†ä¿¡æ¯ï¼ˆæ—¶é—´ã€IPã€è®¾å¤‡ã€æ¥æºç­‰ï¼‰




### 5.3 ç»Ÿè®¡åˆ†æåŠŸèƒ½
- **å®æ—¶ç»Ÿè®¡**ï¼šç‚¹å‡»æ¬¡æ•°ã€è®¿é—®è¶‹åŠ¿ã€åœ°ç†åˆ†å¸ƒã€è®¾å¤‡ç»Ÿè®¡
- **æ•°æ®å¯è§†åŒ–**ï¼šå›¾è¡¨å±•ç¤ºè®¿é—®æ•°æ®ï¼Œæ”¯æŒæ—¶é—´èŒƒå›´ç­›é€‰
- **æ•°æ®å¯¼å‡º**ï¼šæ”¯æŒCSV/Excelæ ¼å¼å¯¼å‡ºï¼Œæ»¡è¶³æ•°æ®åˆ†æéœ€æ±‚

### 5.4 ç”¨æˆ·ç®¡ç†åŠŸèƒ½
- **ç”¨æˆ·æ³¨å†Œ**ï¼šé‚®ç®±æ³¨å†ŒéªŒè¯ï¼Œå¯†ç å¼ºåº¦æ£€æŸ¥
- **æƒé™ç®¡ç†**ï¼šæ¸¸å®¢ã€æ³¨å†Œç”¨æˆ·ã€é«˜çº§ç”¨æˆ·ä¸‰çº§æƒé™ä½“ç³»
- **APIæ¥å£**ï¼šä¸ºå¼€å‘è€…æä¾›RESTful APIï¼Œæ”¯æŒæ‰¹é‡æ“ä½œ

## 6. éåŠŸèƒ½æ€§éœ€æ±‚è¯¦ç»†åˆ†æ

### 6.1 æ€§èƒ½éœ€æ±‚
- **å¹¶å‘å¤„ç†**ï¼šæ”¯æŒ10ä¸‡QPSçš„é«˜å¹¶å‘è®¿é—®
- **å“åº”æ—¶é—´**ï¼šçŸ­é“¾ç”Ÿæˆ<200msï¼Œé‡å®šå‘<100ms
- **ååé‡**ï¼šå•æœºå¤„ç†èƒ½åŠ›1ä¸‡QPSï¼Œæ”¯æŒæ°´å¹³æ‰©å±•

### 6.2 å¯ç”¨æ€§éœ€æ±‚
- **ç³»ç»Ÿå¯ç”¨æ€§**ï¼š99.9%ä»¥ä¸Šçš„æœåŠ¡å¯ç”¨æ€§
- **æ•…éšœæ¢å¤**ï¼šæ•…éšœè‡ªåŠ¨æ£€æµ‹å’Œæ¢å¤ï¼ŒRTO<5åˆ†é’Ÿ
- **å®¹ç¾å¤‡ä»½**ï¼šå¤šæœºæˆ¿éƒ¨ç½²ï¼Œæ•°æ®å®æ—¶åŒæ­¥

### 6.3 å®‰å…¨æ€§éœ€æ±‚
- **æ•°æ®å®‰å…¨**ï¼šHTTPSåŠ å¯†ä¼ è¾“ï¼Œæ•æ„Ÿæ•°æ®åŠ å¯†å­˜å‚¨
- **è®¿é—®æ§åˆ¶**ï¼šAPIé™æµï¼Œé˜²æ­¢æ¶æ„æ”»å‡»
- **å†…å®¹å®‰å…¨**ï¼šURLé»‘åå•æœºåˆ¶ï¼Œé˜²æ­¢æ¶æ„é“¾æ¥ä¼ æ’­

### 6.4 æ‰©å±•æ€§éœ€æ±‚
- **æ°´å¹³æ‰©å±•**ï¼šæ”¯æŒæœåŠ¡å™¨é›†ç¾¤æ‰©å±•
- **æ•°æ®æ‰©å±•**ï¼šæ”¯æŒåˆ†åº“åˆ†è¡¨ï¼Œå¤„ç†æµ·é‡æ•°æ®
- **åŠŸèƒ½æ‰©å±•**ï¼šæ¨¡å—åŒ–è®¾è®¡ï¼Œä¾¿äºæ–°åŠŸèƒ½å¼€å‘

## 7. ç³»ç»Ÿæ¶æ„è®¾è®¡

### 7.1 æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ç”¨æˆ·ç«¯(Web)    â”‚    â”‚   ç”¨æˆ·ç«¯(Mobile) â”‚    â”‚   ç¬¬ä¸‰æ–¹API     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                      â”‚                      â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚      è´Ÿè½½å‡è¡¡å™¨(Nginx)      â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚      APIç½‘å…³å±‚             â”‚
                    â”‚  (è®¤è¯ã€é™æµã€è·¯ç”±)         â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                       â”‚                        â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  çŸ­é“¾æœåŠ¡      â”‚    â”‚   ç”¨æˆ·æœåŠ¡         â”‚    â”‚   ç»Ÿè®¡æœåŠ¡         â”‚
â”‚ (URLç¼©çŸ­/é‡å®šå‘)â”‚    â”‚ (æ³¨å†Œ/ç™»å½•/æƒé™)    â”‚    â”‚ (æ•°æ®ç»Ÿè®¡/åˆ†æ)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                      â”‚                        â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚    æ•°æ®è®¿é—®å±‚      â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                     â”‚                     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”
â”‚  Redisç¼“å­˜     â”‚    â”‚   MySQLä¸»åº“     â”‚    â”‚  MySQLä»åº“  â”‚
â”‚ (çƒ­ç‚¹æ•°æ®ç¼“å­˜)  â”‚    â”‚ (æ ¸å¿ƒæ•°æ®å­˜å‚¨)   â”‚    â”‚ (è¯»å–åˆ†ç¦»)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 7.2 æŠ€æœ¯æ ˆé€‰æ‹©
- **å‰ç«¯**ï¼šReact + TypeScript + Tailwind CSS
- **åç«¯**ï¼šSpring Boot + MyBatis + Redis
- **æ•°æ®åº“**ï¼šMySQL 8.0 (ä¸»ä»å¤åˆ¶)
- **ç¼“å­˜**ï¼šRedis Cluster
- **æ¶ˆæ¯é˜Ÿåˆ—**ï¼šRabbitMQ (å¼‚æ­¥ç»Ÿè®¡)
- **ç›‘æ§**ï¼šPrometheus + Grafana
- **éƒ¨ç½²**ï¼šDocker + Kubernetes

## 8. æ•°æ®åº“è®¾è®¡

### 8.1 æ ¸å¿ƒè¡¨ç»“æ„

**url_mappingè¡¨ (çŸ­é“¾æ˜ å°„è¡¨)**
```sql
CREATE TABLE url_mapping (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    short_code VARCHAR(10) NOT NULL UNIQUE COMMENT 'çŸ­é“¾æ ‡è¯†ç¬¦',
    original_url TEXT NOT NULL COMMENT 'åŸå§‹URL',
    user_id BIGINT DEFAULT NULL COMMENT 'ç”¨æˆ·ID',
    title VARCHAR(255) DEFAULT NULL COMMENT 'é“¾æ¥æ ‡é¢˜',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    expired_at TIMESTAMP DEFAULT NULL COMMENT 'è¿‡æœŸæ—¶é—´',
    is_active TINYINT DEFAULT 1 COMMENT 'æ˜¯å¦æœ‰æ•ˆ',
    INDEX idx_short_code (short_code),
    INDEX idx_user_id (user_id),
    INDEX idx_created_at (created_at)
);
```

**user_infoè¡¨ (ç”¨æˆ·ä¿¡æ¯è¡¨)**
```sql
CREATE TABLE user_info (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    email VARCHAR(255) NOT NULL UNIQUE,
    password_hash VARCHAR(255) NOT NULL,
    username VARCHAR(100) NOT NULL,
    user_type ENUM('guest', 'registered', 'premium') DEFAULT 'registered',
    api_key VARCHAR(64) UNIQUE DEFAULT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_email (email),
    INDEX idx_api_key (api_key)
);
```

**click_statsè¡¨ (ç‚¹å‡»ç»Ÿè®¡è¡¨)**
```sql
CREATE TABLE click_stats (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    short_code VARCHAR(10) NOT NULL,
    ip_address VARCHAR(45) NOT NULL,
    user_agent TEXT,
    referer VARCHAR(500),
    country VARCHAR(50),
    city VARCHAR(100),
    clicked_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_short_code (short_code),
    INDEX idx_clicked_at (clicked_at)
);
```

### 8.2 åˆ†åº“åˆ†è¡¨ç­–ç•¥
- **åˆ†ç‰‡é”®**ï¼šä½¿ç”¨short_codeçš„hashå€¼è¿›è¡Œåˆ†ç‰‡
- **åˆ†ç‰‡æ•°é‡**ï¼šåˆæœŸ4ä¸ªåˆ†ç‰‡ï¼Œæ”¯æŒåŠ¨æ€æ‰©å®¹
- **è·¯ç”±è§„åˆ™**ï¼šhash(short_code) % shard_count

## 9. æ ¸å¿ƒç®—æ³•è®¾è®¡

### 9.1 çŸ­é“¾ç”Ÿæˆç®—æ³•

**Base62ç¼–ç ç®—æ³•**
```
å­—ç¬¦é›†ï¼š0-9, a-z, A-Z (å…±62ä¸ªå­—ç¬¦)
ç®—æ³•æµç¨‹ï¼š
1. è·å–è‡ªå¢ID (ä½¿ç”¨æ•°æ®åº“è‡ªå¢æˆ–åˆ†å¸ƒå¼IDç”Ÿæˆå™¨)
2. å°†IDè½¬æ¢ä¸ºBase62ç¼–ç 
3. è¡¥å……åˆ°æŒ‡å®šé•¿åº¦ (6-8ä½)
4. æ£€æŸ¥å”¯ä¸€æ€§ï¼Œå¦‚æœ‰å†²çªåˆ™é‡æ–°ç”Ÿæˆ
```

**ç¤ºä¾‹å®ç°é€»è¾‘**
```
è¾“å…¥ï¼šåŸå§‹URL + ç”¨æˆ·ID
è¾“å‡ºï¼š6ä½çŸ­é“¾æ ‡è¯†ç¬¦

æ­¥éª¤ï¼š
1. æ£€æŸ¥URLæ˜¯å¦å·²å­˜åœ¨ -> è¿”å›å·²æœ‰çŸ­é“¾
2. ç”Ÿæˆå”¯ä¸€ID (é›ªèŠ±ç®—æ³•æˆ–æ•°æ®åº“è‡ªå¢)
3. Base62ç¼–ç è½¬æ¢
4. å­˜å‚¨æ˜ å°„å…³ç³»
5. è¿”å›çŸ­é“¾
```

### 9.2 ç¼“å­˜ç­–ç•¥è®¾è®¡

**å¤šçº§ç¼“å­˜æ¶æ„**
- **L1ç¼“å­˜**ï¼šæœ¬åœ°ç¼“å­˜ (Caffeine) - çƒ­ç‚¹æ•°æ®ï¼Œ1000æ¡ï¼ŒTTL 5åˆ†é’Ÿ
- **L2ç¼“å­˜**ï¼šRedisç¼“å­˜ - å¸¸ç”¨æ•°æ®ï¼ŒTTL 1å°æ—¶
- **L3ç¼“å­˜**ï¼šæ•°æ®åº“ - æŒä¹…åŒ–å­˜å‚¨

**ç¼“å­˜æ›´æ–°ç­–ç•¥**
- **å†™å…¥**ï¼šCache Asideæ¨¡å¼ï¼Œå…ˆæ›´æ–°æ•°æ®åº“ï¼Œå†åˆ é™¤ç¼“å­˜
- **è¯»å–**ï¼šç¼“å­˜æœªå‘½ä¸­æ—¶ä»æ•°æ®åº“åŠ è½½ï¼Œå¼‚æ­¥æ›´æ–°ç¼“å­˜
- **æ·˜æ±°**ï¼šLRUç®—æ³•ï¼Œå®šæœŸæ¸…ç†è¿‡æœŸæ•°æ®

## 10. å®‰å…¨æ€§è®¾è®¡

### 10.1 URLå®‰å…¨æ£€æŸ¥
- **é»‘åå•æœºåˆ¶**ï¼šç»´æŠ¤æ¶æ„åŸŸåé»‘åå•ï¼Œå®šæœŸæ›´æ–°
- **å†…å®¹æ£€æµ‹**ï¼šé›†æˆç¬¬ä¸‰æ–¹å®‰å…¨APIï¼Œæ£€æµ‹é’“é±¼ç½‘ç«™
- **è®¿é—®é™åˆ¶**ï¼šå•IPæ¯åˆ†é’Ÿæœ€å¤šåˆ›å»º10ä¸ªçŸ­é“¾

### 10.2 ç³»ç»Ÿå®‰å…¨é˜²æŠ¤
- **SQLæ³¨å…¥é˜²æŠ¤**ï¼šä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢ï¼Œè¾“å…¥éªŒè¯
- **XSSé˜²æŠ¤**ï¼šè¾“å‡ºç¼–ç ï¼ŒCSPç­–ç•¥
- **CSRFé˜²æŠ¤**ï¼šTokenéªŒè¯ï¼ŒSameSite Cookie
- **APIå®‰å…¨**ï¼šJWTè®¤è¯ï¼Œæ¥å£é™æµï¼Œç­¾åéªŒè¯

## 11. æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

### 11.1 æ•°æ®åº“ä¼˜åŒ–
- **è¯»å†™åˆ†ç¦»**ï¼šä¸»åº“å†™å…¥ï¼Œä»åº“è¯»å–ï¼Œå‡å°‘ä¸»åº“å‹åŠ›
- **ç´¢å¼•ä¼˜åŒ–**ï¼šä¸ºæŸ¥è¯¢å­—æ®µå»ºç«‹åˆé€‚ç´¢å¼•ï¼Œå®šæœŸåˆ†ææ…¢æŸ¥è¯¢
- **è¿æ¥æ± **ï¼šä½¿ç”¨HikariCPè¿æ¥æ± ï¼Œä¼˜åŒ–è¿æ¥ç®¡ç†

### 11.2 åº”ç”¨å±‚ä¼˜åŒ–
- **å¼‚æ­¥å¤„ç†**ï¼šç»Ÿè®¡æ•°æ®å¼‚æ­¥å†™å…¥ï¼Œé¿å…å½±å“ä¸»æµç¨‹
- **æ‰¹é‡æ“ä½œ**ï¼šæ‰¹é‡æ’å…¥ç»Ÿè®¡æ•°æ®ï¼Œæé«˜å†™å…¥æ•ˆç‡
- **CDNåŠ é€Ÿ**ï¼šé™æ€èµ„æºä½¿ç”¨CDNåˆ†å‘ï¼Œå‡å°‘æœåŠ¡å™¨è´Ÿè½½

### 11.3 ç³»ç»Ÿç›‘æ§
- **æ€§èƒ½æŒ‡æ ‡**ï¼šQPSã€å“åº”æ—¶é—´ã€é”™è¯¯ç‡ã€èµ„æºä½¿ç”¨ç‡
- **ä¸šåŠ¡æŒ‡æ ‡**ï¼šçŸ­é“¾åˆ›å»ºæ•°ã€è®¿é—®é‡ã€ç”¨æˆ·æ´»è·ƒåº¦
- **å‘Šè­¦æœºåˆ¶**ï¼šå¼‚å¸¸è‡ªåŠ¨å‘Šè­¦ï¼Œæ”¯æŒé‚®ä»¶/çŸ­ä¿¡/é’‰é’‰é€šçŸ¥

## 12. éƒ¨ç½²ä¸è¿ç»´

### 12.1 å®¹å™¨åŒ–éƒ¨ç½²
- **Dockeré•œåƒ**ï¼šåº”ç”¨æ‰“åŒ…ä¸ºDockeré•œåƒï¼Œæ ‡å‡†åŒ–éƒ¨ç½²
- **Kubernetes**ï¼šä½¿ç”¨K8sè¿›è¡Œå®¹å™¨ç¼–æ’ï¼Œæ”¯æŒè‡ªåŠ¨æ‰©ç¼©å®¹
- **æœåŠ¡å‘ç°**ï¼šä½¿ç”¨Consulæˆ–K8s Serviceè¿›è¡ŒæœåŠ¡æ³¨å†Œå‘ç°

### 12.2 CI/CDæµç¨‹
- **ä»£ç ç®¡ç†**ï¼šGitç‰ˆæœ¬æ§åˆ¶ï¼Œåˆ†æ”¯ç®¡ç†ç­–ç•¥
- **è‡ªåŠ¨åŒ–æµ‹è¯•**ï¼šå•å…ƒæµ‹è¯•ã€é›†æˆæµ‹è¯•ã€æ€§èƒ½æµ‹è¯•
- **è‡ªåŠ¨åŒ–éƒ¨ç½²**ï¼šJenkins/GitLab CIå®ç°è‡ªåŠ¨åŒ–éƒ¨ç½²

### 12.3 ç›‘æ§å‘Šè­¦
- **æ—¥å¿—æ”¶é›†**ï¼šELK Stackæ”¶é›†å’Œåˆ†ææ—¥å¿—
- **æŒ‡æ ‡ç›‘æ§**ï¼šPrometheus + Grafanaç›‘æ§ç³»ç»ŸæŒ‡æ ‡
- **é“¾è·¯è¿½è¸ª**ï¼šJaegerè¿›è¡Œåˆ†å¸ƒå¼é“¾è·¯è¿½è¸ª