---
title: 粘性分区
date: 2025-04-19 14:04
permalink: /kafka/粘性分区.html
tags:
  - Kafka
categories:
  - Kafka
---

Kafka 的 **粘性分区（Sticky Partitioning）** 是一种生产者端的分区选择策略，主要用于在消息没有明确指定 Key 的情况下优化消息批处理效率，减少分区切换带来的开销。

在 Kafka 生产者中，消息默认会被发送到 Topic 的多个分区以实现负载均衡。早期版本（Kafka < 2.4）在没有 Key 的情况下，生产者采用 **轮询（Round Robin）** 或 **随机（Random）** 策略选择分区。但这种策略可能导致以下问题：

- **批次未填满即发送**：频繁切换分区会导致每个分区的批次积累不足，降低吞吐量。
- **延迟增加**：频繁创建新批次会增加 CPU 和内存开销。

粘性分区通过 **将消息“粘”到某个分区一段时间**，尽可能填充批次后再切换分区，从而优化吞吐量和延迟。

## 核心机制

#### **粘性行为**

- 当生产者发送消息时（无 Key），会选择一个分区并尽可能长时间地向其发送消息，直到满足某些条件触发分区切换。
- 在切换分区时，会随机选择一个新的分区（而不是轮询），但长期来看仍能保证分区的均衡性。

#### **分区切换触发条件**

粘性分区的切换通常由以下条件触发：

1. **批次填满**：当前分区的批次达到 `batch.size` 配置的阈值。
2. **时间到达**：当前批次在 `linger.ms` 配置的时间内未填满。
3. **分区不可用**：分区 Leader 发生变更或出现错误（需重试时可能切换分区）。
4. **消息序列化失败**：生产者需要重新选择分区。

### **粘性分区的配置**

在 Kafka 生产者中，粘性分区是默认策略（Kafka 2.4+）。以下是相关配置：

```properties
# 使用默认的粘性分区策略（Kafka 2.4+ 默认）
partitioner.class=org.apache.kafka.clients.producer.UniformStickyPartitioner

# 显式配置粘性分区（旧版本可能需要手动设置）
partitioner.class=org.apache.kafka.clients.producer.StickyPartitioner
```

**不适合严格均匀分布的场景**：如需严格轮询分发，需切换回 `RoundRobinPartitioner`。

## 分区策略对比

| 策略                       | 适用场景                        | 特点                                                     |
| :------------------------- | :------------------------------ | :------------------------------------------------------- |
| `UniformStickyPartitioner` | 无 Key 的默认策略（Kafka 2.4+） | 粘性分区，优先填充批次，减少切换。                       |
| `RoundRobinPartitioner`    | 严格均匀分布需求                | 按轮询选择分区，可能降低吞吐量。                         |
| `DefaultPartitioner`       | 带 Key 的消息（哈希分区）       | 根据 Key 的哈希值选择分区（保证相同 Key 进入同一分区）。 |

