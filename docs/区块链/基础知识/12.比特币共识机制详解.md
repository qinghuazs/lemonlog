---
title: æ¯”ç‰¹å¸å…±è¯†æœºåˆ¶è¯¦è§£
date: 2025-09-30
permalink: /blockchain/bitcoin-consensus-mechanism.html
tags:
  - åŒºå—é“¾
  - æ¯”ç‰¹å¸
  - å…±è¯†æœºåˆ¶
  - PoW
categories:
  - åŒºå—é“¾
---

# æ¯”ç‰¹å¸å…±è¯†æœºåˆ¶è¯¦è§£

## ä»€ä¹ˆæ˜¯å…±è¯†æœºåˆ¶ï¼Ÿ

å…±è¯†æœºåˆ¶æ˜¯åˆ†å¸ƒå¼ç³»ç»Ÿä¸­å¤šä¸ªèŠ‚ç‚¹å°±æŸä¸ªææ¡ˆè¾¾æˆä¸€è‡´çš„ç®—æ³•ã€‚åœ¨æ¯”ç‰¹å¸ç½‘ç»œä¸­ï¼Œå…±è¯†æœºåˆ¶è§£å†³çš„æ ¸å¿ƒé—®é¢˜æ˜¯ï¼š**å¦‚ä½•åœ¨æ²¡æœ‰ä¸­å¿ƒåŒ–æƒå¨çš„æƒ…å†µä¸‹ï¼Œè®©å…¨ç½‘èŠ‚ç‚¹å¯¹äº¤æ˜“é¡ºåºå’ŒåŒºå—é“¾çŠ¶æ€è¾¾æˆä¸€è‡´ã€‚**

### éœ€è¦è§£å†³çš„é—®é¢˜

```mermaid
graph TD
    A[åˆ†å¸ƒå¼ç½‘ç»œé—®é¢˜] --> B[åŒèŠ±æ”»å‡»]
    A --> C[æ‹œå åº­å°†å†›é—®é¢˜]
    A --> D[å¥³å·«æ”»å‡»]
    A --> E[ç½‘ç»œå»¶è¿Ÿå’Œåˆ†å‰]

    B --> F[å…±è¯†æœºåˆ¶]
    C --> F
    D --> F
    E --> F

    F --> G[å·¥ä½œé‡è¯æ˜PoW]
```

### å…±è¯†ä¸‰è¦ç´ 

1. **å®‰å…¨æ€§ï¼ˆSafetyï¼‰**ï¼šä¸ä¼šäº§ç”Ÿé”™è¯¯ç»“æœ
2. **æ´»æ€§ï¼ˆLivenessï¼‰**ï¼šç³»ç»Ÿæœ€ç»ˆä¼šäº§ç”Ÿç»“æœ
3. **å®¹é”™æ€§ï¼ˆFault Toleranceï¼‰**ï¼šèƒ½å¤Ÿå®¹å¿éƒ¨åˆ†èŠ‚ç‚¹æ•…éšœ

## å·¥ä½œé‡è¯æ˜ï¼ˆProof of Workï¼‰

### PoWåŸç†

å·¥ä½œé‡è¯æ˜è¦æ±‚çŸ¿å·¥æ‰¾åˆ°ä¸€ä¸ªéšæœºæ•°ï¼ˆnonceï¼‰ï¼Œä½¿å¾—åŒºå—å“ˆå¸Œå€¼æ»¡è¶³ç‰¹å®šæ¡ä»¶ã€‚

```java
public class ProofOfWork {
    // ç›®æ ‡éš¾åº¦ï¼ˆå‰å¯¼é›¶çš„ä¸ªæ•°ï¼‰
    private static final int DIFFICULTY = 4;

    public class Block {
        private int index;
        private long timestamp;
        private String previousHash;
        private List<Transaction> transactions;
        private int nonce;           // å·¥ä½œé‡è¯æ˜çš„å…³é”®
        private String hash;

        // è®¡ç®—åŒºå—å“ˆå¸Œ
        public String calculateHash() {
            String data = index + timestamp + previousHash +
                         transactionsToString() + nonce;
            return SHA256.hash(data);
        }

        // æŒ–çŸ¿ï¼šå¯»æ‰¾æœ‰æ•ˆçš„nonce
        public void mineBlock() {
            String target = "0".repeat(DIFFICULTY); // "0000"

            System.out.println("å¼€å§‹æŒ–çŸ¿...");
            long startTime = System.currentTimeMillis();

            while (!hash.startsWith(target)) {
                nonce++;
                hash = calculateHash();

                // æ¯10000æ¬¡è¾“å‡ºè¿›åº¦
                if (nonce % 10000 == 0) {
                    System.out.println("å°è¯• " + nonce + " æ¬¡...");
                }
            }

            long endTime = System.currentTimeMillis();
            System.out.println("æŒ–çŸ¿æˆåŠŸï¼");
            System.out.println("Nonce: " + nonce);
            System.out.println("Hash: " + hash);
            System.out.println("è€—æ—¶: " + (endTime - startTime) + "ms");
        }
    }
}
```

### å“ˆå¸Œéš¾é¢˜

```mermaid
graph LR
    A[åŒºå—æ•°æ®] --> B[+ Nonce]
    B --> C[SHA-256]
    C --> D{å“ˆå¸Œå€¼<br/>æ»¡è¶³éš¾åº¦?}
    D -->|å¦| E[Nonce++]
    E --> B
    D -->|æ˜¯| F[æ‰¾åˆ°è§£]
```

**ç¤ºä¾‹ï¼š**
```
ç›®æ ‡ï¼šæ‰¾åˆ°ä»¥"0000"å¼€å¤´çš„å“ˆå¸Œ

Nonce: 0     Hash: 9a3f7c8e... âŒ
Nonce: 1     Hash: 8b2e6d7a... âŒ
Nonce: 2     Hash: 7c1d5c9b... âŒ
...
Nonce: 47582 Hash: 00003c2f... âœ… æˆåŠŸï¼
```

### PoWçš„ç‰¹æ€§

```java
public class PoWCharacteristics {

    // 1. è®¡ç®—å›°éš¾
    public void miningDifficult() {
        // å¹³å‡éœ€è¦å°è¯• 2^éš¾åº¦ æ¬¡
        // éš¾åº¦20ä½ï¼šéœ€è¦çº¦100ä¸‡æ¬¡å°è¯•
        // éš¾åº¦30ä½ï¼šéœ€è¦çº¦10äº¿æ¬¡å°è¯•
    }

    // 2. éªŒè¯ç®€å•
    public boolean verifyProof(Block block) {
        // åªéœ€è®¡ç®—ä¸€æ¬¡å“ˆå¸Œ
        String hash = block.calculateHash();
        return hash.startsWith("0".repeat(DIFFICULTY));
    }

    // 3. ä¸å¯é¢„æµ‹
    public void unpredictable() {
        // æ— æ³•é¢„æµ‹å“ªä¸ªnonceæ˜¯æ­£ç¡®çš„
        // åªèƒ½é€šè¿‡æš´åŠ›å°è¯•
    }

    // 4. æ¦‚ç‡å…¬å¹³
    public double miningProbability(double hashPower, double totalHashPower) {
        // æŒ–åˆ°åŒºå—çš„æ¦‚ç‡ = ç®—åŠ›å æ¯”
        return hashPower / totalHashPower;
    }
}
```

## éš¾åº¦è°ƒæ•´ç®—æ³•

### ä¸ºä»€ä¹ˆéœ€è¦éš¾åº¦è°ƒæ•´ï¼Ÿ

æ¯”ç‰¹å¸çš„ç›®æ ‡æ˜¯ä¿æŒ**å¹³å‡æ¯10åˆ†é’Ÿäº§ç”Ÿä¸€ä¸ªåŒºå—**ã€‚ä½†å…¨ç½‘ç®—åŠ›ä¼šå˜åŒ–ï¼š
- çŸ¿å·¥åŠ å…¥ â†’ ç®—åŠ›å¢åŠ  â†’ å‡ºå—å˜å¿«
- çŸ¿å·¥é€€å‡º â†’ ç®—åŠ›å‡å°‘ â†’ å‡ºå—å˜æ…¢

éš¾åº¦è°ƒæ•´ç¡®ä¿å‡ºå—æ—¶é—´ç¨³å®šã€‚

### éš¾åº¦è°ƒæ•´æœºåˆ¶

```java
public class DifficultyAdjustment {
    private static final int TARGET_TIMESPAN = 14 * 24 * 60 * 60; // 2å‘¨
    private static final int TARGET_SPACING = 10 * 60;            // 10åˆ†é’Ÿ
    private static final int INTERVAL = TARGET_TIMESPAN / TARGET_SPACING; // 2016åŒºå—

    public BigInteger calculateNextDifficulty(
            BlockChain chain,
            Block lastBlock) {

        // æ¯2016ä¸ªåŒºå—è°ƒæ•´ä¸€æ¬¡
        if ((lastBlock.getHeight() + 1) % INTERVAL != 0) {
            return lastBlock.getDifficulty();
        }

        // è·å–2016ä¸ªåŒºå—å‰çš„åŒºå—
        Block firstBlock = chain.getBlock(
            lastBlock.getHeight() - INTERVAL + 1
        );

        // è®¡ç®—å®é™…è€—æ—¶
        long actualTimespan = lastBlock.getTimestamp() -
                             firstBlock.getTimestamp();

        // é™åˆ¶è°ƒæ•´èŒƒå›´ï¼ˆ4å€å†…ï¼‰
        if (actualTimespan < TARGET_TIMESPAN / 4) {
            actualTimespan = TARGET_TIMESPAN / 4;
        }
        if (actualTimespan > TARGET_TIMESPAN * 4) {
            actualTimespan = TARGET_TIMESPAN * 4;
        }

        // è®¡ç®—æ–°éš¾åº¦
        BigInteger oldTarget = lastBlock.getTarget();
        BigInteger newTarget = oldTarget.multiply(
            BigInteger.valueOf(actualTimespan)
        ).divide(
            BigInteger.valueOf(TARGET_TIMESPAN)
        );

        return targetToDifficulty(newTarget);
    }

    // ç¤ºä¾‹ï¼šéš¾åº¦è°ƒæ•´è¿‡ç¨‹
    public void demonstrateAdjustment() {
        // å‡è®¾æœ€è¿‘2016ä¸ªåŒºå—ç”¨äº†12å¤©ï¼ˆåº”è¯¥æ˜¯14å¤©ï¼‰
        int actualDays = 12;
        int targetDays = 14;

        // å‡ºå—å¤ªå¿«äº†ï¼Œéœ€è¦å¢åŠ éš¾åº¦
        double adjustmentFactor = (double) targetDays / actualDays;
        System.out.println("è°ƒæ•´ç³»æ•°: " + adjustmentFactor); // 1.167

        // æ–°éš¾åº¦ = æ—§éš¾åº¦ Ã— 1.167
        // æŒ–çŸ¿å˜éš¾äº†ï¼
    }
}
```

### éš¾åº¦è°ƒæ•´å®ä¾‹

```mermaid
graph TD
    A[åŒºå— 0-2015<br/>é¢„è®¡14å¤©] --> B{å®é™…æ—¶é—´?}
    B -->|12å¤©<br/>å¤ªå¿«| C[éš¾åº¦å¢åŠ  16.7%]
    B -->|14å¤©<br/>æ­£å¥½| D[éš¾åº¦ä¸å˜]
    B -->|16å¤©<br/>å¤ªæ…¢| E[éš¾åº¦å‡å°‘ 12.5%]
```

**çœŸå®æ•°æ®ç¤ºä¾‹ï¼š**
```
è°ƒæ•´å‘¨æœŸ #001:
- åŒºå—é«˜åº¦: 0 - 2015
- å®é™…æ—¶é—´: 13.2å¤©
- éš¾åº¦è°ƒæ•´: +6.1%

è°ƒæ•´å‘¨æœŸ #002:
- åŒºå—é«˜åº¦: 2016 - 4031
- å®é™…æ—¶é—´: 14.8å¤©
- éš¾åº¦è°ƒæ•´: -5.4%
```

## æœ€é•¿é“¾åŸåˆ™

### é“¾é€‰æ‹©è§„åˆ™

å½“ç½‘ç»œä¸­å‡ºç°å¤šæ¡ç«äº‰é“¾æ—¶ï¼ŒèŠ‚ç‚¹éµå¾ª**æœ€é•¿é“¾åŸåˆ™**ï¼š
- é€‰æ‹©ç´¯è®¡å·¥ä½œé‡æœ€å¤§çš„é“¾
- é€šå¸¸è¡¨ç°ä¸ºæœ€é•¿çš„é“¾
- æŠ›å¼ƒè¾ƒçŸ­çš„åˆ†å‰

```java
public class LongestChainRule {
    private List<Block> mainChain;

    // æ¥æ”¶æ–°åŒºå—
    public void receiveBlock(Block newBlock) {
        // 1. éªŒè¯åŒºå—
        if (!validateBlock(newBlock)) {
            System.out.println("æ— æ•ˆåŒºå—");
            return;
        }

        // 2. æ‰¾åˆ°çˆ¶åŒºå—
        Block parent = findBlock(newBlock.getPreviousHash());
        if (parent == null) {
            System.out.println("å­¤å—ï¼Œæš‚å­˜");
            storeOrphanBlock(newBlock);
            return;
        }

        // 3. æ„å»ºä¸´æ—¶é“¾
        List<Block> newChain = buildChain(newBlock);

        // 4. æ¯”è¾ƒé“¾é•¿åº¦ï¼ˆå®é™…æ¯”è¾ƒç´¯è®¡éš¾åº¦ï¼‰
        if (getChainWork(newChain) > getChainWork(mainChain)) {
            // æ–°é“¾æ›´é•¿ï¼Œåˆ‡æ¢åˆ°æ–°é“¾
            reorganizeChain(newChain);
            System.out.println("é“¾é‡ç»„ï¼šåˆ‡æ¢åˆ°æ›´é•¿çš„é“¾");
        }
    }

    // è®¡ç®—é“¾çš„ç´¯è®¡å·¥ä½œé‡
    private BigInteger getChainWork(List<Block> chain) {
        BigInteger totalWork = BigInteger.ZERO;
        for (Block block : chain) {
            totalWork = totalWork.add(block.getWork());
        }
        return totalWork;
    }

    // é“¾é‡ç»„
    private void reorganizeChain(List<Block> newChain) {
        // 1. æ‰¾åˆ°åˆ†å‰ç‚¹
        Block forkPoint = findForkPoint(mainChain, newChain);

        // 2. å›æ»šä¸»é“¾åˆ°åˆ†å‰ç‚¹
        List<Block> orphanedBlocks = new ArrayList<>();
        while (getLastBlock() != forkPoint) {
            Block removed = removeLastBlock();
            orphanedBlocks.add(removed);

            // å›æ»šäº¤æ˜“ï¼ˆè¿”å›å†…å­˜æ± ï¼‰
            for (Transaction tx : removed.getTransactions()) {
                mempool.add(tx);
            }
        }

        // 3. åº”ç”¨æ–°é“¾
        int forkIndex = newChain.indexOf(forkPoint);
        for (int i = forkIndex + 1; i < newChain.size(); i++) {
            addBlock(newChain.get(i));
        }

        System.out.println("é‡ç»„å®Œæˆï¼Œå›æ»šäº† " +
                          orphanedBlocks.size() + " ä¸ªåŒºå—");
    }
}
```

### é“¾é‡ç»„ç¤ºä¾‹

```mermaid
sequenceDiagram
    participant Node
    participant ChainA
    participant ChainB

    Note over Node: åˆå§‹çŠ¶æ€ï¼šé“¾Aæ˜¯ä¸»é“¾
    Node->>ChainA: åŒºå—1-2-3

    Note over ChainB: å‡ºç°ç«äº‰é“¾B
    ChainB->>Node: åŒºå—1-2'-3'-4'

    Note over Node: æ¯”è¾ƒé“¾é•¿åº¦
    Node->>Node: ChainBæ›´é•¿

    Note over Node: é“¾é‡ç»„
    Node->>ChainA: æŠ›å¼ƒåŒºå—3
    Node->>ChainB: åˆ‡æ¢åˆ°é“¾B

    Note over Node: æ–°çš„ä¸»é“¾ï¼š1-2'-3'-4'
```

## åˆ†å‰å¤„ç†

### åˆ†å‰ç±»å‹

```mermaid
graph TD
    A[åŒºå—é“¾åˆ†å‰] --> B[ä¸´æ—¶åˆ†å‰]
    A --> C[è½¯åˆ†å‰]
    A --> D[ç¡¬åˆ†å‰]

    B --> B1[ç½‘ç»œå»¶è¿Ÿå¯¼è‡´]
    B --> B2[è‡ªåŠ¨è§£å†³]

    C --> C1[å‘åå…¼å®¹]
    C --> C2[æ—§èŠ‚ç‚¹å¯ç”¨]

    D --> D1[ä¸å…¼å®¹]
    D --> D2[éœ€è¦å‡çº§]
```

### 1. ä¸´æ—¶åˆ†å‰

**äº§ç”ŸåŸå› ï¼š**
- ä¸¤ä¸ªçŸ¿å·¥å‡ ä¹åŒæ—¶æŒ–å‡ºåŒºå—
- ç½‘ç»œå»¶è¿Ÿå¯¼è‡´åŒºå—ä¼ æ’­ä¸åŒæ­¥

```java
public class TemporaryFork {
    public void demonstrateFork() {
        // æ—¶é—´ç‚¹ T
        // çŸ¿å·¥AæŒ–å‡ºåŒºå—100A
        Block block100A = minerA.mineBlock();

        // å‡ ä¹åŒæ—¶ï¼ŒçŸ¿å·¥BæŒ–å‡ºåŒºå—100B
        Block block100B = minerB.mineBlock();

        // ç½‘ç»œåˆ†è£‚æˆä¸¤éƒ¨åˆ†
        List<Node> nodesWithA = broadcastBlock(block100A);
        List<Node> nodesWithB = broadcastBlock(block100B);

        System.out.println("ä¸´æ—¶åˆ†å‰äº§ç”Ÿï¼");
        System.out.println("èŠ‚ç‚¹åˆ†æˆä¸¤ç»„ï¼š");
        System.out.println("- ä¸€ç»„åœ¨é“¾ ...->100A ä¸Š");
        System.out.println("- ä¸€ç»„åœ¨é“¾ ...->100B ä¸Š");

        // æ—¶é—´ç‚¹ T+10åˆ†é’Ÿ
        // çŸ¿å·¥CåŸºäº100AæŒ–å‡ºåŒºå—101
        Block block101 = minerC.mineBlock(block100A);

        // é“¾ ...->100A->101 æ›´é•¿
        // æ‰€æœ‰èŠ‚ç‚¹åˆ‡æ¢åˆ°è¿™æ¡é“¾
        // åŒºå—100Bè¢«æŠ›å¼ƒï¼ˆæˆä¸ºå­¤å—ï¼‰

        System.out.println("\nåˆ†å‰è§£å†³ï¼");
        System.out.println("æœ€é•¿é“¾ï¼š...->100A->101");
        System.out.println("åŒºå—100Bæˆä¸ºå­¤å—");
    }
}
```

**åˆ†å‰ç¤ºä¾‹å›¾ï¼š**
```mermaid
graph LR
    B98[åŒºå—98] --> B99[åŒºå—99]
    B99 --> B100A[åŒºå—100A<br/>çŸ¿å·¥A]
    B99 --> B100B[åŒºå—100B<br/>çŸ¿å·¥B]
    B100A --> B101[åŒºå—101]

    style B100A fill:#90EE90
    style B101 fill:#90EE90
    style B100B fill:#FFB6C6
```

### 2. è½¯åˆ†å‰ï¼ˆSoft Forkï¼‰

**å®šä¹‰ï¼š** å‘åå…¼å®¹çš„åè®®å‡çº§ï¼Œæ—§èŠ‚ç‚¹ä»å¯éªŒè¯æ–°åŒºå—ã€‚

```java
public class SoftFork {
    // ç¤ºä¾‹ï¼šé™åˆ¶åŒºå—å¤§å°ï¼ˆæ—§è§„åˆ™ï¼š10MBï¼Œæ–°è§„åˆ™ï¼š1MBï¼‰

    // æ—§èŠ‚ç‚¹éªŒè¯
    public boolean oldNodeValidate(Block block) {
        return block.getSize() <= 10_000_000; // 10MB
    }

    // æ–°èŠ‚ç‚¹éªŒè¯
    public boolean newNodeValidate(Block block) {
        return block.getSize() <= 1_000_000;  // 1MB
    }

    // æ–°åŒºå—ï¼ˆ1MBï¼‰
    Block newBlock = new Block(size: 1MB);

    // æ—§èŠ‚ç‚¹éªŒè¯ï¼šé€šè¿‡ï¼ˆ1MB < 10MBï¼‰âœ…
    // æ–°èŠ‚ç‚¹éªŒè¯ï¼šé€šè¿‡ï¼ˆ1MB = 1MBï¼‰âœ…
    // å‘åå…¼å®¹ï¼

    // æ—§çŸ¿å·¥æŒ–å‡ºå¤§åŒºå—ï¼ˆ5MBï¼‰
    Block oldBlock = new Block(size: 5MB);

    // æ—§èŠ‚ç‚¹éªŒè¯ï¼šé€šè¿‡ï¼ˆ5MB < 10MBï¼‰âœ…
    // æ–°èŠ‚ç‚¹éªŒè¯ï¼šå¤±è´¥ï¼ˆ5MB > 1MBï¼‰âŒ
    // æ–°èŠ‚ç‚¹æ‹’ç»ï¼Œæ—§åŒºå—è¢«å­¤ç«‹
}
```

**è‘—åè½¯åˆ†å‰ï¼š**
- **P2SH (BIP 16)**ï¼šæ–°çš„æ”¯ä»˜è„šæœ¬æ ¼å¼
- **SegWit (BIP 141)**ï¼šéš”ç¦»è§è¯
- **Taproot (BIP 340-342)**ï¼šéšç§å’Œè„šæœ¬å¢å¼º

### 3. ç¡¬åˆ†å‰ï¼ˆHard Forkï¼‰

**å®šä¹‰ï¼š** ä¸å…¼å®¹çš„åè®®å‡çº§ï¼Œæ—§èŠ‚ç‚¹æ— æ³•éªŒè¯æ–°åŒºå—ã€‚

```java
public class HardFork {
    // ç¤ºä¾‹ï¼šå¢åŠ åŒºå—å¤§å°ï¼ˆæ—§è§„åˆ™ï¼š1MBï¼Œæ–°è§„åˆ™ï¼š8MBï¼‰

    // æ—§èŠ‚ç‚¹éªŒè¯
    public boolean oldNodeValidate(Block block) {
        return block.getSize() <= 1_000_000; // 1MB
    }

    // æ–°èŠ‚ç‚¹éªŒè¯
    public boolean newNodeValidate(Block block) {
        return block.getSize() <= 8_000_000; // 8MB
    }

    // æ–°çŸ¿å·¥æŒ–å‡ºå¤§åŒºå—ï¼ˆ5MBï¼‰
    Block newBlock = new Block(size: 5MB);

    // æ—§èŠ‚ç‚¹éªŒè¯ï¼šå¤±è´¥ï¼ˆ5MB > 1MBï¼‰âŒ
    // æ–°èŠ‚ç‚¹éªŒè¯ï¼šé€šè¿‡ï¼ˆ5MB < 8MBï¼‰âœ…

    // ç½‘ç»œåˆ†è£‚ï¼
    // - æ—§èŠ‚ç‚¹ï¼šæ‹’ç»æ–°åŒºå—ï¼Œç»§ç»­åœ¨æ—§é“¾
    // - æ–°èŠ‚ç‚¹ï¼šæ¥å—æ–°åŒºå—ï¼Œåœ¨æ–°é“¾ä¸Š
}
```

**è‘—åç¡¬åˆ†å‰ï¼š**
- **Bitcoin Cash (BCH)**ï¼š2017å¹´8æœˆï¼Œå¢åŠ åŒºå—å¤§å°åˆ°8MB
- **Bitcoin SV (BSV)**ï¼š2018å¹´11æœˆï¼Œä»BCHåˆ†å‰

```mermaid
graph LR
    BTC[Bitcoin] --> |2017-08| BCH[Bitcoin Cash]
    BCH --> |2018-11| BSV[Bitcoin SV]

    style BTC fill:#F7931A
    style BCH fill:#8DC351
    style BSV fill:#EAB300
```

## å­¤å—å’Œé™ˆæ—§å—

### æ¦‚å¿µåŒºåˆ†

```java
public class OrphanAndStaleBlocks {

    // å­¤å—ï¼ˆOrphan Blockï¼‰ï¼šçˆ¶åŒºå—æœªçŸ¥
    public class OrphanBlock {
        Block orphan;

        public void handleOrphan(Block block) {
            if (!hasParent(block)) {
                System.out.println("å­¤å—ï¼šçˆ¶åŒºå—æœªæ”¶åˆ°");
                orphanPool.add(block);

                // è¯·æ±‚çˆ¶åŒºå—
                requestBlock(block.getPreviousHash());
            }
        }
    }

    // é™ˆæ—§å—ï¼ˆStale Blockï¼‰ï¼šæœ‰æ•ˆä½†ä¸åœ¨ä¸»é“¾
    public class StaleBlock {
        Block stale;

        public void handleStale(Block block) {
            if (isValid(block) && !isInMainChain(block)) {
                System.out.println("é™ˆæ—§å—ï¼šè¢«æ›´é•¿çš„é“¾è¶…è¶Š");
                // åŒºå—æœ¬èº«æœ‰æ•ˆï¼Œä½†è¾“æ‰äº†ç«äº‰
            }
        }
    }
}
```

### é™ˆæ—§å—äº§ç”Ÿæµç¨‹

```mermaid
sequenceDiagram
    participant MinerA
    participant MinerB
    participant Network

    Note over MinerA,MinerB: ä¸¤çŸ¿å·¥åŒæ—¶æŒ–çŸ¿

    MinerA->>MinerA: æ‰¾åˆ°åŒºå—A (é«˜åº¦100)
    MinerB->>MinerB: æ‰¾åˆ°åŒºå—B (é«˜åº¦100)

    MinerA->>Network: å¹¿æ’­åŒºå—A
    MinerB->>Network: å¹¿æ’­åŒºå—B

    Note over Network: ç½‘ç»œåˆ†è£‚<br/>éƒ¨åˆ†èŠ‚ç‚¹æ¥å—A<br/>éƒ¨åˆ†èŠ‚ç‚¹æ¥å—B

    MinerA->>Network: æŒ–å‡ºåŒºå—101 (åŸºäºA)

    Note over Network: é“¾Aæ›´é•¿<br/>åŒºå—Bæˆä¸ºé™ˆæ—§å—
```

### å­¤å—ç‡ç»Ÿè®¡

```java
public class BlockStatistics {
    public void calculateOrphanRate() {
        int totalBlocks = 100000;
        int orphanBlocks = 500;

        double orphanRate = (double) orphanBlocks / totalBlocks * 100;
        System.out.println("å­¤å—ç‡: " + orphanRate + "%"); // çº¦0.5%

        // å­¤å—ç‡å—å½±å“å› ç´ ï¼š
        // 1. ç½‘ç»œå»¶è¿Ÿ
        // 2. åŒºå—å¤§å°
        // 3. å‡ºå—æ—¶é—´
        // 4. å…¨ç½‘ç®—åŠ›åˆ†å¸ƒ
    }
}
```

## å…±è¯†å®‰å…¨æ€§åˆ†æ

### 51%æ”»å‡»

**æ”»å‡»åŸç†ï¼š**
å¦‚æœæ”»å‡»è€…æ§åˆ¶è¶…è¿‡50%çš„ç®—åŠ›ï¼Œå¯ä»¥ï¼š
- äº§ç”Ÿæ›´é•¿çš„é“¾
- å›æ»šäº¤æ˜“ï¼ˆåŒèŠ±ï¼‰
- æ‹’ç»ç¡®è®¤ç‰¹å®šäº¤æ˜“

```java
public class FiftyOnePercentAttack {
    public void demonstrateAttack() {
        // 1. æ”»å‡»è€…æ”¯ä»˜ç»™å•†å®¶
        Transaction payment = new Transaction(
            attacker, merchant, 100_BTC
        );

        // 2. å•†å®¶ç­‰å¾…6æ¬¡ç¡®è®¤åå‘è´§
        waitForConfirmations(payment, 6);
        merchant.shipProduct();

        // 3. æ”»å‡»è€…ç§˜å¯†æŒ–çŸ¿ï¼ˆä¸å¹¿æ’­ï¼‰
        List<Block> secretChain = new ArrayList<>();
        for (int i = 0; i < 7; i++) {
            Block secretBlock = attacker.mineBlock();
            secretChain.add(secretBlock);
            // ç§˜å¯†é“¾ä¸åŒ…å«paymentäº¤æ˜“ï¼
        }

        // 4. å¹¿æ’­ç§˜å¯†é“¾ï¼ˆæ¯”ä¸»é“¾é•¿ï¼‰
        attacker.broadcast(secretChain);

        // 5. ç½‘ç»œåˆ‡æ¢åˆ°ç§˜å¯†é“¾
        // paymentäº¤æ˜“å›æ»šï¼Œæ”»å‡»è€…çš„å¸è¿˜åœ¨
        // å•†å®¶æŸå¤±ï¼šè´§ç‰©å·²å‘å‡ºï¼Œä½†æœªæ”¶åˆ°æ¬¾

        System.out.println("åŒèŠ±æ”»å‡»æˆåŠŸï¼");
        System.out.println("æ”»å‡»è€…ï¼šæ‹¿å›äº†100 BTC");
        System.out.println("å•†å®¶ï¼šæŸå¤±è´§ç‰©");
    }

    // æ”»å‡»æˆæœ¬åˆ†æ
    public void calculateAttackCost() {
        double globalHashRate = 400_000_000; // TH/s
        double attackHashRate = globalHashRate * 0.51; // 51%

        // ç¡¬ä»¶æˆæœ¬
        double costPerTHs = 50; // ç¾å…ƒ
        double hardwareCost = attackHashRate * costPerTHs;

        // ç”µåŠ›æˆæœ¬ï¼ˆæ¯å°æ—¶ï¼‰
        double powerPerTHs = 0.03; // kW
        double electricityRate = 0.05; // ç¾å…ƒ/kWh
        double hourlyCost = attackHashRate * powerPerTHs * electricityRate;

        System.out.println("51%æ”»å‡»æˆæœ¬ï¼š");
        System.out.println("ç¡¬ä»¶æˆæœ¬: $" + hardwareCost);
        System.out.println("æ¯å°æ—¶ç”µè´¹: $" + hourlyCost);
        System.out.println("æ”»å‡»1å°æ—¶æ€»æˆæœ¬: $" +
                          (hardwareCost + hourlyCost));

        // å®é™…æ•°å­—ï¼ˆ2024å¹´ï¼‰ï¼š
        // ç¡¬ä»¶æˆæœ¬ï¼šçº¦200äº¿ç¾å…ƒ
        // æ¯å°æ—¶ç”µè´¹ï¼šçº¦60ä¸‡ç¾å…ƒ
        // ç»æµä¸Šä¸å¯è¡Œï¼
    }
}
```

### ç¡®è®¤æ·±åº¦ä¸å®‰å…¨æ€§

```java
public class ConfirmationSecurity {
    // è®¡ç®—å›æ»šæ¦‚ç‡
    public double calculateReverseProbability(
            int confirmations,
            double attackerHashRate) {

        double p = attackerHashRate; // æ”»å‡»è€…ç®—åŠ›å æ¯”
        double q = 1 - p;            // è¯šå®ç®—åŠ›å æ¯”

        double probability = 1.0;
        for (int z = 0; z < confirmations; z++) {
            probability *= p / q;
        }

        return probability;
    }

    public void securityAnalysis() {
        double attackerPower = 0.10; // 10%ç®—åŠ›

        System.out.println("æ”»å‡»è€…ç®—åŠ›: " + (attackerPower * 100) + "%");
        System.out.println("\nå›æ»šæ¦‚ç‡ï¼š");

        for (int conf = 1; conf <= 6; conf++) {
            double prob = calculateReverseProbability(conf, attackerPower);
            System.out.printf("%dæ¬¡ç¡®è®¤: %.4f%%\n", conf, prob * 100);
        }

        // è¾“å‡ºï¼š
        // 1æ¬¡ç¡®è®¤: 11.11%
        // 2æ¬¡ç¡®è®¤: 1.23%
        // 3æ¬¡ç¡®è®¤: 0.14%
        // 4æ¬¡ç¡®è®¤: 0.015%
        // 5æ¬¡ç¡®è®¤: 0.0017%
        // 6æ¬¡ç¡®è®¤: 0.00019%
    }
}
```

**æ¨èç¡®è®¤æ¬¡æ•°ï¼š**
| äº¤æ˜“é‡‘é¢ | ç¡®è®¤æ¬¡æ•° | å®‰å…¨æ€§ |
|---------|---------|--------|
| å°é¢ | 1-2æ¬¡ | åŸºæœ¬å®‰å…¨ |
| ä¸­é¢ | 3-4æ¬¡ | è¾ƒå®‰å…¨ |
| å¤§é¢ | 6æ¬¡åŠä»¥ä¸Š | éå¸¸å®‰å…¨ |

### è‡ªç§æŒ–çŸ¿ï¼ˆSelfish Miningï¼‰

```java
public class SelfishMining {
    public void strategy() {
        // ç­–ç•¥ï¼šçŸ¿å·¥æŒ–åˆ°åŒºå—åä¸ç«‹å³å¹¿æ’­

        Block secretBlock = miner.mineBlock();

        // ä¿å¯†ï¼Œç»§ç»­æŒ–ä¸‹ä¸€ä¸ª
        Block nextBlock = miner.mineBlock();

        // å½“å…¶ä»–çŸ¿å·¥æŒ–å‡ºåŒºå—æ—¶ï¼Œç«‹å³å¹¿æ’­ä¸¤ä¸ªåŒºå—
        if (otherMinerFoundBlock()) {
            broadcast(secretBlock);
            broadcast(nextBlock);

            // è‡ªå·±çš„é“¾æ›´é•¿ï¼Œè·å¾—ä¸¤ä¸ªåŒºå—å¥–åŠ±
            // å…¶ä»–çŸ¿å·¥çš„åŒºå—è¢«å­¤ç«‹ï¼Œæµªè´¹ç®—åŠ›
        }

        // è¿™ç§ç­–ç•¥å¯èƒ½è·å¾—è¶…è¿‡ç®—åŠ›å æ¯”çš„å¥–åŠ±
        // ä½†éœ€è¦æ‰¿æ‹…é£é™©ï¼ˆå¯èƒ½è¾“æ‰ç«äº‰ï¼‰
    }
}
```

## å…±è¯†æœºåˆ¶å¯¹æ¯”

### PoW vs PoS vs DPoS

```java
public class ConsensusComparison {
    // å·¥ä½œé‡è¯æ˜ (Proof of Work)
    public class PoW {
        String consensus = "ç®—åŠ›ç«äº‰";
        String security = "è®¡ç®—æˆæœ¬";
        double energyConsumption = HIGH;
        int tps = 7;  // æ¯”ç‰¹å¸
        String example = "Bitcoin, Ethereum (æ—§)";
    }

    // æƒç›Šè¯æ˜ (Proof of Stake)
    public class PoS {
        String consensus = "æŒå¸æƒé‡";
        String security = "ç»æµåˆ©ç›Š";
        double energyConsumption = LOW;
        int tps = 1000;
        String example = "Ethereum 2.0, Cardano";
    }

    // å§”æ‰˜æƒç›Šè¯æ˜ (Delegated Proof of Stake)
    public class DPoS {
        String consensus = "æŠ•ç¥¨é€‰ä¸¾";
        String security = "å£°èª‰æœºåˆ¶";
        double energyConsumption = VERY_LOW;
        int tps = 4000;
        String example = "EOS, Tron";
    }
}
```

| ç‰¹æ€§ | PoW | PoS | DPoS |
|------|-----|-----|------|
| **èƒ½æºæ¶ˆè€—** | æé«˜ | ä½ | æä½ |
| **å»ä¸­å¿ƒåŒ–** | é«˜ | ä¸­ | ä½ |
| **å®‰å…¨æ€§** | æˆç†Ÿå¯é  | è¾ƒæ–° | è¾ƒä½ |
| **TPS** | ä½ï¼ˆ7ï¼‰ | ä¸­ï¼ˆ1000ï¼‰ | é«˜ï¼ˆ4000ï¼‰ |
| **å‡†å…¥é—¨æ§›** | é«˜ï¼ˆçŸ¿æœºï¼‰ | ä¸­ï¼ˆæŒå¸ï¼‰ | ä½ï¼ˆæŠ•ç¥¨ï¼‰ |
| **æ”»å‡»æˆæœ¬** | æé«˜ | é«˜ | ä¸­ |

## å…±è¯†æœºåˆ¶çš„æ¼”è¿›

```mermaid
timeline
    title åŒºå—é“¾å…±è¯†æœºåˆ¶æ¼”è¿›
    2009 : PoWå·¥ä½œé‡è¯æ˜
         : æ¯”ç‰¹å¸è¯ç”Ÿ
    2012 : PoSæƒç›Šè¯æ˜
         : Peercoiné¦–æ¬¡å®ç°
    2014 : DPoSå§”æ‰˜æƒç›Šè¯æ˜
         : BitShareså¼•å…¥
    2017 : BFTç±»å…±è¯†
         : Tendermint, HotStuff
    2020 : PoW+PoSæ··åˆ
         : Ethereum 2.0
    2023 : é›¶çŸ¥è¯†è¯æ˜å…±è¯†
         : zkRollupæ‰©å±•
```

## æ€»ç»“

### æ ¸å¿ƒè¦ç‚¹

âœ… **å…±è¯†æœºåˆ¶çš„ä½œç”¨**
- åœ¨åˆ†å¸ƒå¼ç½‘ç»œä¸­è¾¾æˆä¸€è‡´
- é˜²æ­¢åŒèŠ±å’Œæ‹œå åº­æ”»å‡»
- ä¿è¯è´¦æœ¬çš„å®‰å…¨æ€§å’Œä¸€è‡´æ€§

âœ… **PoWå·¥ä½œåŸç†**
- é€šè¿‡è®¡ç®—æ‰¾åˆ°æœ‰æ•ˆå“ˆå¸Œ
- è®¡ç®—å›°éš¾ï¼ŒéªŒè¯ç®€å•
- ç®—åŠ›è¶Šå¤§ï¼Œè·èƒœæ¦‚ç‡è¶Šé«˜

âœ… **éš¾åº¦è°ƒæ•´**
- æ¯2016ä¸ªåŒºå—è°ƒæ•´ä¸€æ¬¡
- ç›®æ ‡ï¼šä¿æŒ10åˆ†é’Ÿå‡ºå—
- è°ƒæ•´èŒƒå›´é™åˆ¶åœ¨4å€å†…

âœ… **æœ€é•¿é“¾åŸåˆ™**
- é€‰æ‹©ç´¯è®¡å·¥ä½œé‡æœ€å¤§çš„é“¾
- è‡ªåŠ¨è§£å†³ä¸´æ—¶åˆ†å‰
- 6æ¬¡ç¡®è®¤è¾¾åˆ°å®‰å…¨é˜ˆå€¼

âœ… **å®‰å…¨æ€§ä¿éšœ**
- 51%æ”»å‡»æˆæœ¬æé«˜
- ç¡®è®¤æ·±åº¦æä¾›å®‰å…¨æ€§
- å»ä¸­å¿ƒåŒ–æ˜¯å…³é”®

### å®è·µå»ºè®®

1. **äº¤æ˜“ç¡®è®¤**ï¼šå¤§é¢äº¤æ˜“ç­‰å¾…6æ¬¡ç¡®è®¤
2. **èŠ‚ç‚¹é€‰æ‹©**ï¼šè¿è¡Œå…¨èŠ‚ç‚¹æœ€å®‰å…¨
3. **å…³æ³¨ç¡¬åˆ†å‰**ï¼šåŠæ—¶å‡çº§å®¢æˆ·ç«¯
4. **ç†è§£é£é™©**ï¼šæ–°åŒºå—å¯èƒ½è¢«å­¤ç«‹

---

**ä¸‹ä¸€æ­¥å­¦ä¹ ï¼š**
- [æ¯”ç‰¹å¸ç»æµæ¨¡å‹ä¸æ¿€åŠ±æœºåˆ¶](./13.æ¯”ç‰¹å¸ç»æµæ¨¡å‹ä¸æ¿€åŠ±æœºåˆ¶.md)
- [æ¯”ç‰¹å¸å®‰å…¨æœºåˆ¶](./14.æ¯”ç‰¹å¸å®‰å…¨æœºåˆ¶.md)
- [æ¯”ç‰¹å¸æŒ–çŸ¿åŸç†](./04.æ¯”ç‰¹å¸æŒ–çŸ¿åŸç†.md)

æ¯”ç‰¹å¸çš„å…±è¯†æœºåˆ¶æ˜¯å…¶æœ€æ ¸å¿ƒçš„åˆ›æ–°ï¼Œç†è§£å®ƒæ˜¯æŒæ¡åŒºå—é“¾æŠ€æœ¯çš„å…³é”®ï¼ğŸš€