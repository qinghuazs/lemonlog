---
title: æ¯”ç‰¹å¸çŸ¿æ± åè®®
date: 2025-09-30
permalink: /blockchain/bitcoin-mining-pool.html
tags:
  - åŒºå—é“¾
  - æ¯”ç‰¹å¸
  - çŸ¿æ± 
  - Stratum
categories:
  - åŒºå—é“¾
  - æ¯”ç‰¹å¸åŸºç¡€
---

# æ¯”ç‰¹å¸çŸ¿æ± åè®®

## 1. çŸ¿æ± åŸºç¡€æ¦‚å¿µ

### 1.1 ä¸ºä»€ä¹ˆéœ€è¦çŸ¿æ± 

**å•ç‹¬æŒ–çŸ¿çš„æŒ‘æˆ˜**:
- å½“å‰å…¨ç½‘ç®—åŠ›: ~500 EH/s
- ä¸ªäººçŸ¿æœºç®—åŠ›: ~100 TH/s
- æŒ–åˆ°åŒºå—æ¦‚ç‡: 1/5,000,000 â‰ˆ æ¯3ä¸ªæœˆ1ä¸ªåŒºå—
- æ”¶ç›Šä¸ç¨³å®š

**çŸ¿æ± ä¼˜åŠ¿**:
- ç¨³å®šçš„æ”¶ç›Šæµ
- é™ä½æ–¹å·®
- å…±äº«åŸºç¡€è®¾æ–½æˆæœ¬
- ä¸“ä¸šè¿ç»´

```mermaid
graph TB
    A[çŸ¿æ± æœåŠ¡å™¨] --> B[åˆ†é…æŒ–çŸ¿ä»»åŠ¡]

    B --> C[çŸ¿å·¥1: 100 TH/s]
    B --> D[çŸ¿å·¥2: 50 TH/s]
    B --> E[çŸ¿å·¥3: 80 TH/s]
    B --> F[çŸ¿å·¥N...]

    C --> G[æäº¤Share]
    D --> G
    E --> G
    F --> G

    G --> H{æ‰¾åˆ°åŒºå—?}
    H -->|æ˜¯| I[çŸ¿æ± è·å¾—å¥–åŠ±]
    H -->|å¦| J[è®°å½•å·¥ä½œé‡]

    I --> K[æŒ‰ç®—åŠ›åˆ†é…]
    K --> C
    K --> D
    K --> E
    K --> F
```

### 1.2 æ ¸å¿ƒæ¦‚å¿µ

**Share (ä»½é¢)**:
- é™ä½éš¾åº¦çš„å·¥ä½œè¯æ˜
- ç”¨äºç»Ÿè®¡çŸ¿å·¥ç®—åŠ›
- Shareéš¾åº¦ << åŒºå—éš¾åº¦

```java
/**
 * Shareéš¾åº¦è®¡ç®—
 */
public class ShareDifficulty {

    // æ¯”ç‰¹å¸ç½‘ç»œéš¾åº¦
    private static final long NETWORK_DIFFICULTY = 60_000_000_000_000L;

    // çŸ¿æ± è®¾å®šçš„Shareéš¾åº¦ (ä½å¾—å¤š)
    private static final long SHARE_DIFFICULTY = 1_000_000L;

    /**
     * éªŒè¯Share
     */
    public static boolean validateShare(byte[] blockHeader) throws Exception {
        MessageDigest sha256 = MessageDigest.getInstance("SHA-256");

        // åŒé‡SHA256
        byte[] hash1 = sha256.digest(blockHeader);
        sha256.reset();
        byte[] hash2 = sha256.digest(hash1);

        // è½¬æ¢ä¸ºå¤§æ•´æ•°
        BigInteger hashValue = new BigInteger(1, reverseBytes(hash2));

        // è®¡ç®—ç›®æ ‡å€¼
        BigInteger shareTarget = calculateTarget(SHARE_DIFFICULTY);

        // æ£€æŸ¥æ˜¯å¦æ»¡è¶³Shareéš¾åº¦
        if (hashValue.compareTo(shareTarget) <= 0) {
            System.out.println("âœ“ æœ‰æ•ˆShare");

            // è¿›ä¸€æ­¥æ£€æŸ¥æ˜¯å¦æ»¡è¶³ç½‘ç»œéš¾åº¦
            BigInteger networkTarget = calculateTarget(NETWORK_DIFFICULTY);
            if (hashValue.compareTo(networkTarget) <= 0) {
                System.out.println("ğŸ‰ æ‰¾åˆ°åŒºå—!");
                return true;
            }
        }

        return false;
    }

    /**
     * æ ¹æ®éš¾åº¦è®¡ç®—ç›®æ ‡å€¼
     */
    private static BigInteger calculateTarget(long difficulty) {
        // target = 2^256 / difficulty
        BigInteger max = new BigInteger("FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF", 16);
        return max.divide(BigInteger.valueOf(difficulty));
    }

    private static byte[] reverseBytes(byte[] bytes) {
        byte[] reversed = new byte[bytes.length];
        for (int i = 0; i < bytes.length; i++) {
            reversed[i] = bytes[bytes.length - 1 - i];
        }
        return reversed;
    }

    public static void main(String[] args) throws Exception {
        System.out.println("=== Shareéš¾åº¦ç¤ºä¾‹ ===\n");

        System.out.println("ç½‘ç»œéš¾åº¦: " + String.format("%,d", NETWORK_DIFFICULTY));
        System.out.println("Shareéš¾åº¦: " + String.format("%,d", SHARE_DIFFICULTY));
        System.out.println("éš¾åº¦æ¯”ä¾‹: 1:" + (NETWORK_DIFFICULTY / SHARE_DIFFICULTY));
        System.out.println();

        System.out.println("ğŸ’¡ æ„ä¹‰:");
        System.out.println("- çŸ¿å·¥çº¦æ¯10ç§’æäº¤1ä¸ªShare");
        System.out.println("- çŸ¿æ± æ¯çº¦" + (NETWORK_DIFFICULTY / SHARE_DIFFICULTY / 6) + "å°æ—¶æ‰¾åˆ°1ä¸ªåŒºå—");
        System.out.println("- é€šè¿‡Shareç»Ÿè®¡æ¯ä¸ªçŸ¿å·¥çš„ç®—åŠ›è´¡çŒ®");
    }
}
```

## 2. Stratum V1åè®®

### 2.1 åè®®æ¦‚è¿°

Stratumæ˜¯ç›®å‰æœ€æµè¡Œçš„çŸ¿æ± åè®®,åŸºäºJSON-RPC over TCP:

**ç‰¹ç‚¹**:
- é•¿è¿æ¥,é¿å…HTTPè½®è¯¢
- åŒå‘é€šä¿¡
- å‡å°‘å¸¦å®½æ¶ˆè€—
- å¿«é€ŸåŒºå—åˆ‡æ¢

### 2.2 åè®®æµç¨‹

```mermaid
sequenceDiagram
    participant M as çŸ¿å·¥
    participant P as çŸ¿æ± 

    M->>P: 1. mining.subscribe()
    P->>M: è¿”å›: ExtraNonce1, ExtraNonce2_size

    M->>P: 2. mining.authorize(username, password)
    P->>M: è¿”å›: true/false

    P->>M: 3. mining.set_difficulty(difficulty)

    P->>M: 4. mining.notify(job_id, prevhash, coinb1, coinb2, merkle, ...)

    M->>M: 5. è®¡ç®—å“ˆå¸Œ

    M->>P: 6. mining.submit(job_id, ExtraNonce2, nTime, nonce)
    P->>M: è¿”å›: true (æ¥å—) / false (æ‹’ç»)

    Note over M,P: æ–°åŒºå—äº§ç”Ÿ
    P->>M: 7. mining.notify (æ–°ä»»åŠ¡)
```

### 2.3 Stratum V1 Javaå®ç°

```java
import java.io.*;
import java.net.*;
import java.util.*;
import org.json.*;

/**
 * Stratum V1å®¢æˆ·ç«¯å®ç°
 */
public class StratumV1Client {

    private Socket socket;
    private BufferedReader reader;
    private PrintWriter writer;

    private String extraNonce1;
    private int extraNonce2Size;
    private String jobId;
    private Map<String, Object> currentJob;

    private String poolUrl;
    private int poolPort;
    private String username;
    private String password;

    public StratumV1Client(String poolUrl, int poolPort,
            String username, String password) {
        this.poolUrl = poolUrl;
        this.poolPort = poolPort;
        this.username = username;
        this.password = password;
        this.currentJob = new HashMap<>();
    }

    /**
     * è¿æ¥åˆ°çŸ¿æ± 
     */
    public void connect() throws Exception {
        System.out.println("è¿æ¥åˆ°çŸ¿æ± : " + poolUrl + ":" + poolPort);

        socket = new Socket(poolUrl, poolPort);
        reader = new BufferedReader(
            new InputStreamReader(socket.getInputStream()));
        writer = new PrintWriter(
            new OutputStreamWriter(socket.getOutputStream()), true);

        System.out.println("âœ“ è¿æ¥æˆåŠŸ");
    }

    /**
     * 1. è®¢é˜…
     */
    public void subscribe() throws Exception {
        JSONObject request = new JSONObject();
        request.put("id", 1);
        request.put("method", "mining.subscribe");
        request.put("params", new JSONArray());

        System.out.println("\n>>> mining.subscribe");
        sendRequest(request);

        JSONObject response = readResponse();
        System.out.println("<<< " + response.toString(2));

        // è§£æå“åº”
        JSONArray result = response.getJSONArray("result");
        extraNonce1 = result.getJSONArray(1).getString(0);
        extraNonce2Size = result.getInt(2);

        System.out.println("\nExtraNonce1: " + extraNonce1);
        System.out.println("ExtraNonce2 Size: " + extraNonce2Size);
    }

    /**
     * 2. è®¤è¯
     */
    public void authorize() throws Exception {
        JSONObject request = new JSONObject();
        request.put("id", 2);
        request.put("method", "mining.authorize");

        JSONArray params = new JSONArray();
        params.put(username);
        params.put(password);
        request.put("params", params);

        System.out.println("\n>>> mining.authorize");
        sendRequest(request);

        JSONObject response = readResponse();
        boolean authorized = response.getBoolean("result");

        System.out.println("<<< è®¤è¯ç»“æœ: " + (authorized ? "âœ“ æˆåŠŸ" : "âœ— å¤±è´¥"));
    }

    /**
     * 3. ç›‘å¬çŸ¿æ± æ¶ˆæ¯
     */
    public void listen() throws Exception {
        System.out.println("\nå¼€å§‹ç›‘å¬çŸ¿æ± æ¶ˆæ¯...\n");

        while (true) {
            String line = reader.readLine();
            if (line == null) break;

            JSONObject message = new JSONObject(line);

            if (message.has("method")) {
                String method = message.getString("method");

                switch (method) {
                    case "mining.set_difficulty":
                        handleSetDifficulty(message);
                        break;

                    case "mining.notify":
                        handleNotify(message);
                        break;

                    default:
                        System.out.println("æœªçŸ¥æ–¹æ³•: " + method);
                }
            } else if (message.has("result")) {
                // æäº¤Shareçš„å“åº”
                boolean accepted = message.optBoolean("result", false);
                System.out.println("Share " + (accepted ? "âœ“ æ¥å—" : "âœ— æ‹’ç»"));
            }
        }
    }

    /**
     * å¤„ç†è®¾ç½®éš¾åº¦
     */
    private void handleSetDifficulty(JSONObject message) throws Exception {
        JSONArray params = message.getJSONArray("params");
        double difficulty = params.getDouble(0);

        System.out.println("<<< mining.set_difficulty: " + difficulty);
    }

    /**
     * å¤„ç†æ–°ä»»åŠ¡
     */
    private void handleNotify(JSONObject message) throws Exception {
        JSONArray params = message.getJSONArray("params");

        jobId = params.getString(0);
        String prevHash = params.getString(1);
        String coinbase1 = params.getString(2);
        String coinbase2 = params.getString(3);
        JSONArray merkleBranches = params.getJSONArray(4);
        String version = params.getString(5);
        String nBits = params.getString(6);
        String nTime = params.getString(7);
        boolean cleanJobs = params.getBoolean(8);

        currentJob.put("job_id", jobId);
        currentJob.put("prevhash", prevHash);
        currentJob.put("coinbase1", coinbase1);
        currentJob.put("coinbase2", coinbase2);
        currentJob.put("merkle_branch", merkleBranches);
        currentJob.put("version", version);
        currentJob.put("nbits", nBits);
        currentJob.put("ntime", nTime);
        currentJob.put("clean_jobs", cleanJobs);

        System.out.println("<<< mining.notify (æ–°ä»»åŠ¡)");
        System.out.println("    Job ID: " + jobId);
        System.out.println("    Prev Hash: " + prevHash.substring(0, 16) + "...");
        System.out.println("    Clean Jobs: " + cleanJobs);

        if (cleanJobs) {
            System.out.println("    âš ï¸  éœ€è¦ç«‹å³åˆ‡æ¢åˆ°æ–°ä»»åŠ¡!");
        }
    }

    /**
     * 4. æäº¤Share
     */
    public void submitShare(String extraNonce2, String nTime, String nonce)
            throws Exception {
        JSONObject request = new JSONObject();
        request.put("id", 4);
        request.put("method", "mining.submit");

        JSONArray params = new JSONArray();
        params.put(username);           // worker name
        params.put(jobId);              // job_id
        params.put(extraNonce2);        // ExtraNonce2
        params.put(nTime);              // nTime
        params.put(nonce);              // nonce
        request.put("params", params);

        System.out.println("\n>>> mining.submit");
        System.out.println("    Job ID: " + jobId);
        System.out.println("    ExtraNonce2: " + extraNonce2);
        System.out.println("    nTime: " + nTime);
        System.out.println("    Nonce: " + nonce);

        sendRequest(request);
    }

    /**
     * å‘é€è¯·æ±‚
     */
    private void sendRequest(JSONObject request) {
        writer.println(request.toString());
    }

    /**
     * è¯»å–å“åº”
     */
    private JSONObject readResponse() throws Exception {
        String line = reader.readLine();
        return new JSONObject(line);
    }

    /**
     * å…³é—­è¿æ¥
     */
    public void close() throws Exception {
        if (socket != null && !socket.isClosed()) {
            socket.close();
        }
    }

    /**
     * ä½¿ç”¨ç¤ºä¾‹
     */
    public static void main(String[] args) throws Exception {
        System.out.println("=== Stratum V1å®¢æˆ·ç«¯ç¤ºä¾‹ ===\n");

        // è¿æ¥åˆ°çŸ¿æ±  (ç¤ºä¾‹)
        StratumV1Client client = new StratumV1Client(
            "stratum.example.com",
            3333,
            "username.worker1",
            "password"
        );

        try {
            // 1. è¿æ¥
            client.connect();

            // 2. è®¢é˜…
            client.subscribe();

            // 3. è®¤è¯
            client.authorize();

            // 4. ç›‘å¬æ¶ˆæ¯ (æ¨¡æ‹Ÿ)
            System.out.println("\nğŸ’¡ å®é™…åº”ç”¨ä¸­,è¿™é‡Œä¼š:");
            System.out.println("   - æŒç»­ç›‘å¬çŸ¿æ± æ¶ˆæ¯");
            System.out.println("   - ä½¿ç”¨çŸ¿æœºè¿›è¡Œå“ˆå¸Œè®¡ç®—");
            System.out.println("   - æ‰¾åˆ°Shareåæäº¤");

            // æ¨¡æ‹Ÿæäº¤Share
            Thread.sleep(2000);
            client.submitShare(
                "00000000",  // ExtraNonce2
                "5f8a7b3c",  // nTime
                "1a2b3c4d"   // nonce
            );

        } finally {
            client.close();
        }
    }
}
```

### 2.4 Stratum V1çš„é—®é¢˜

| é—®é¢˜ | è¯´æ˜ | å½±å“ |
|-----|------|------|
| äº¤æ˜“é€‰æ‹©æƒåœ¨çŸ¿æ±  | çŸ¿å·¥æ— æ³•è‡ªä¸»é€‰æ‹©äº¤æ˜“ | ä¸­å¿ƒåŒ–é£é™© |
| æ˜æ–‡ä¼ è¾“ | æ— åŠ å¯†,æ˜“è¢«åŠ«æŒ | å®‰å…¨æ€§å·® |
| æ•ˆç‡ä½ | æ¯æ¬¡éƒ½ä¼ è¾“å®Œæ•´Merkleåˆ†æ”¯ | å¸¦å®½æµªè´¹ |
| æ— èº«ä»½éªŒè¯ | å®¹æ˜“è¢«ä¸­é—´äººæ”»å‡» | ç®—åŠ›è¢«ç›— |

## 3. Stratum V2åè®®

### 3.1 V2çš„æ”¹è¿›

Stratum V2 (2020å¹´å‘å¸ƒ) æ˜¯å¯¹V1çš„é‡å¤§å‡çº§:

```mermaid
graph LR
    A[Stratum V2ç‰¹æ€§] --> B[äºŒè¿›åˆ¶åè®®]
    A --> C[åŠ å¯†ä¼ è¾“]
    A --> D[äº¤æ˜“é€‰æ‹©æƒ]
    A --> E[æ•ˆç‡ä¼˜åŒ–]

    B --> B1[æ›´å°çš„æ¶ˆæ¯]
    B --> B2[æ›´å¿«çš„è§£æ]

    C --> C1[AEADåŠ å¯†]
    C --> C2[é˜²æ­¢åŠ«æŒ]

    D --> D1[çŸ¿å·¥è‡ªä¸»é€‰æ‹©]
    D --> D2[æŠ—å®¡æŸ¥]

    E --> E1[å¢é‡Merkleæ›´æ–°]
    E --> E2[æ›´å°‘å¸¦å®½]
```

### 3.2 V2åè®®æ¶æ„

```java
/**
 * Stratum V2æ¶ˆæ¯ç±»å‹
 */
public class StratumV2Protocol {

    /**
     * æ¶ˆæ¯ç±»å‹æšä¸¾
     */
    public enum MessageType {
        // Setupè¿æ¥
        SETUP_CONNECTION(0x00),
        SETUP_CONNECTION_SUCCESS(0x01),
        SETUP_CONNECTION_ERROR(0x02),

        // é€šé“ç®¡ç†
        OPEN_STANDARD_MINING_CHANNEL(0x10),
        OPEN_MINING_CHANNEL_SUCCESS(0x11),
        OPEN_MINING_CHANNEL_ERROR(0x12),

        // æŒ–çŸ¿æ¶ˆæ¯
        NEW_MINING_JOB(0x15),
        SET_NEW_PREV_HASH(0x16),

        // æäº¤Share
        SUBMIT_SHARES_STANDARD(0x1A),
        SUBMIT_SHARES_SUCCESS(0x1B),
        SUBMIT_SHARES_ERROR(0x1C),

        // äº¤æ˜“é€‰æ‹©(Job Declaration)
        DECLARE_MINING_JOB(0x20),
        PROVIDE_MISSING_TRANSACTIONS(0x21);

        private final int value;

        MessageType(int value) {
            this.value = value;
        }

        public int getValue() {
            return value;
        }
    }

    /**
     * V2æ¶ˆæ¯ç»“æ„
     */
    public static class Message {
        private int extensionType;  // 2å­—èŠ‚: æ‰©å±•ç±»å‹
        private int messageType;    // 1å­—èŠ‚: æ¶ˆæ¯ç±»å‹
        private int messageLength;  // 3å­—èŠ‚: æ¶ˆæ¯é•¿åº¦
        private byte[] payload;     // å˜é•¿: æ¶ˆæ¯ä½“

        public Message(MessageType type, byte[] payload) {
            this.extensionType = 0;
            this.messageType = type.getValue();
            this.messageLength = payload.length;
            this.payload = payload;
        }

        /**
         * åºåˆ—åŒ–æ¶ˆæ¯
         */
        public byte[] serialize() throws Exception {
            ByteArrayOutputStream bos = new ByteArrayOutputStream();

            // Extension Type (2 bytes, little-endian)
            bos.write(extensionType & 0xFF);
            bos.write((extensionType >> 8) & 0xFF);

            // Message Type (1 byte)
            bos.write(messageType & 0xFF);

            // Message Length (3 bytes, little-endian)
            bos.write(messageLength & 0xFF);
            bos.write((messageLength >> 8) & 0xFF);
            bos.write((messageLength >> 16) & 0xFF);

            // Payload
            bos.write(payload);

            return bos.toByteArray();
        }

        /**
         * ååºåˆ—åŒ–æ¶ˆæ¯
         */
        public static Message deserialize(byte[] data) throws Exception {
            if (data.length < 6) {
                throw new IllegalArgumentException("æ¶ˆæ¯å¤ªçŸ­");
            }

            // è§£æå¤´éƒ¨
            int extensionType = (data[0] & 0xFF) | ((data[1] & 0xFF) << 8);
            int messageType = data[2] & 0xFF;
            int messageLength = (data[3] & 0xFF) |
                               ((data[4] & 0xFF) << 8) |
                               ((data[5] & 0xFF) << 16);

            // è§£æpayload
            byte[] payload = new byte[messageLength];
            System.arraycopy(data, 6, payload, 0, messageLength);

            Message msg = new Message(null, payload);
            msg.extensionType = extensionType;
            msg.messageType = messageType;
            msg.messageLength = messageLength;

            return msg;
        }

        public int getMessageType() {
            return messageType;
        }

        public byte[] getPayload() {
            return payload;
        }
    }

    /**
     * SetupConnectionæ¶ˆæ¯
     */
    public static class SetupConnection {
        private int protocol;      // åè®®ç‰ˆæœ¬
        private int minVersion;    // æœ€å°ç‰ˆæœ¬
        private int maxVersion;    // æœ€å¤§ç‰ˆæœ¬
        private int flags;         // æ ‡å¿—ä½
        private String endpointHost;
        private int endpointPort;
        private String vendor;
        private String hardwareVersion;
        private String firmware;
        private String deviceId;

        public byte[] encode() throws Exception {
            ByteArrayOutputStream bos = new ByteArrayOutputStream();

            // Protocol (1 byte)
            bos.write(protocol);

            // Min/Max Version (2 bytes each)
            writeU16(bos, minVersion);
            writeU16(bos, maxVersion);

            // Flags (4 bytes)
            writeU32(bos, flags);

            // Endpoint (STR0_255)
            writeStr(bos, endpointHost);
            writeU16(bos, endpointPort);

            // Device info
            writeStr(bos, vendor);
            writeStr(bos, hardwareVersion);
            writeStr(bos, firmware);
            writeStr(bos, deviceId);

            return bos.toByteArray();
        }

        private void writeU16(ByteArrayOutputStream bos, int value) {
            bos.write(value & 0xFF);
            bos.write((value >> 8) & 0xFF);
        }

        private void writeU32(ByteArrayOutputStream bos, int value) {
            bos.write(value & 0xFF);
            bos.write((value >> 8) & 0xFF);
            bos.write((value >> 16) & 0xFF);
            bos.write((value >> 24) & 0xFF);
        }

        private void writeStr(ByteArrayOutputStream bos, String str) {
            byte[] bytes = str.getBytes();
            bos.write(bytes.length);
            bos.write(bytes, 0, bytes.length);
        }
    }

    /**
     * SubmitSharesStandardæ¶ˆæ¯
     */
    public static class SubmitSharesStandard {
        private int channelId;      // 4 bytes
        private int sequenceNumber; // 4 bytes
        private int jobId;          // 4 bytes
        private int nonce;          // 4 bytes
        private int nTime;          // 4 bytes
        private int version;        // 4 bytes

        public byte[] encode() throws Exception {
            ByteArrayOutputStream bos = new ByteArrayOutputStream();

            writeU32(bos, channelId);
            writeU32(bos, sequenceNumber);
            writeU32(bos, jobId);
            writeU32(bos, nonce);
            writeU32(bos, nTime);
            writeU32(bos, version);

            return bos.toByteArray();
        }

        private void writeU32(ByteArrayOutputStream bos, int value) {
            bos.write(value & 0xFF);
            bos.write((value >> 8) & 0xFF);
            bos.write((value >> 16) & 0xFF);
            bos.write((value >> 24) & 0xFF);
        }
    }

    /**
     * ä½¿ç”¨ç¤ºä¾‹
     */
    public static void main(String[] args) throws Exception {
        System.out.println("=== Stratum V2åè®®ç¤ºä¾‹ ===\n");

        // 1. åˆ›å»ºSetupConnectionæ¶ˆæ¯
        SetupConnection setup = new SetupConnection();
        setup.protocol = 0;
        setup.minVersion = 2;
        setup.maxVersion = 2;
        setup.flags = 0x00000001; // éœ€è¦æ ‡å‡†é€šé“
        setup.endpointHost = "0.0.0.0";
        setup.endpointPort = 0;
        setup.vendor = "MyMiner";
        setup.hardwareVersion = "v1.0";
        setup.firmware = "1.0.0";
        setup.deviceId = "miner-001";

        byte[] setupPayload = setup.encode();
        Message setupMsg = new Message(
            MessageType.SETUP_CONNECTION,
            setupPayload
        );

        byte[] serialized = setupMsg.serialize();

        System.out.println("1ï¸âƒ£  SetupConnectionæ¶ˆæ¯");
        System.out.println("æ¶ˆæ¯å¤§å°: " + serialized.length + " å­—èŠ‚");
        System.out.println("æ¶ˆæ¯ç±»å‹: 0x" +
            String.format("%02X", setupMsg.getMessageType()));
        System.out.println();

        // 2. åˆ›å»ºSubmitSharesæ¶ˆæ¯
        SubmitSharesStandard submit = new SubmitSharesStandard();
        submit.channelId = 1;
        submit.sequenceNumber = 100;
        submit.jobId = 42;
        submit.nonce = 0x12345678;
        submit.nTime = 0x6123456;
        submit.version = 0x20000000;

        byte[] submitPayload = submit.encode();
        Message submitMsg = new Message(
            MessageType.SUBMIT_SHARES_STANDARD,
            submitPayload
        );

        byte[] submitSerialized = submitMsg.serialize();

        System.out.println("2ï¸âƒ£  SubmitSharesStandardæ¶ˆæ¯");
        System.out.println("æ¶ˆæ¯å¤§å°: " + submitSerialized.length + " å­—èŠ‚");
        System.out.println("Channel ID: " + submit.channelId);
        System.out.println("Job ID: " + submit.jobId);
        System.out.println("Nonce: 0x" + Integer.toHexString(submit.nonce));
        System.out.println();

        // 3. V1 vs V2å¯¹æ¯”
        System.out.println("3ï¸âƒ£  V1 vs V2å¯¹æ¯”");
        System.out.println();

        String v1Submit = "{\"id\":1,\"method\":\"mining.submit\"," +
            "\"params\":[\"worker\",\"job123\",\"00000000\"," +
            "\"5f8a7b3c\",\"1a2b3c4d\"]}";

        System.out.println("V1 (JSON):");
        System.out.println("  æ¶ˆæ¯å¤§å°: " + v1Submit.length() + " å­—èŠ‚");
        System.out.println("  ç¼–ç : æ–‡æœ¬");
        System.out.println("  åŠ å¯†: æ— ");
        System.out.println();

        System.out.println("V2 (äºŒè¿›åˆ¶):");
        System.out.println("  æ¶ˆæ¯å¤§å°: " + submitSerialized.length + " å­—èŠ‚");
        System.out.println("  ç¼–ç : äºŒè¿›åˆ¶");
        System.out.println("  åŠ å¯†: AEAD");
        System.out.println();

        System.out.println("ğŸ’¡ V2ä¼˜åŠ¿:");
        System.out.println("  - æ¶ˆæ¯å¤§å°å‡å°‘ " +
            String.format("%.1f%%", (1.0 - (double)submitSerialized.length/v1Submit.length()) * 100));
        System.out.println("  - æ”¯æŒåŠ å¯†é€šä¿¡");
        System.out.println("  - æ”¯æŒäº¤æ˜“é€‰æ‹©æƒ");
    }
}
```

### 3.3 Job Declaration (äº¤æ˜“é€‰æ‹©)

Stratum V2æœ€é‡è¦çš„ç‰¹æ€§æ˜¯**çŸ¿å·¥å¯ä»¥è‡ªä¸»é€‰æ‹©äº¤æ˜“**:

```java
/**
 * Job Declaration - çŸ¿å·¥è‡ªä¸»é€‰æ‹©äº¤æ˜“
 */
public class JobDeclaration {

    /**
     * çŸ¿å·¥ç«¯: å£°æ˜æŒ–çŸ¿ä»»åŠ¡
     */
    public static class DeclareMiningJob {
        private int requestId;
        private byte[] prevHash;
        private List<String> txShortIds;  // ä½¿ç”¨çŸ­IDå¼•ç”¨äº¤æ˜“
        private int minNTime;
        private int version;

        /**
         * æ„å»ºCoinbaseäº¤æ˜“
         */
        public Transaction buildCoinbaseTransaction(
                String minerAddress,
                long blockReward,
                long fees) {

            Transaction coinbase = new Transaction();
            coinbase.version = 2;

            // Coinbaseè¾“å…¥
            TxInput input = new TxInput();
            input.prevTxId = new byte[32]; // å…¨0
            input.prevIndex = 0xFFFFFFFF;
            input.scriptSig = buildCoinbaseScriptSig();
            input.sequence = 0xFFFFFFFF;
            coinbase.inputs.add(input);

            // Coinbaseè¾“å‡º
            TxOutput output = new TxOutput();
            output.amount = blockReward + fees;
            output.scriptPubKey = addressToScriptPubKey(minerAddress);
            coinbase.outputs.add(output);

            coinbase.lockTime = 0;

            return coinbase;
        }

        /**
         * é€‰æ‹©äº¤æ˜“(æ¥è‡ªå†…å­˜æ± )
         */
        public List<Transaction> selectTransactions(
                Mempool mempool,
                long maxBlockWeight) {

            List<Transaction> selected = new ArrayList<>();
            long currentWeight = 0;

            // æŒ‰æ‰‹ç»­è´¹ç‡æ’åº
            List<MempoolEntry> sorted = mempool.getTransactionsSortedByFeeRate();

            for (MempoolEntry entry : sorted) {
                long txWeight = entry.transaction.getWeight();

                if (currentWeight + txWeight <= maxBlockWeight) {
                    selected.add(entry.transaction);
                    currentWeight += txWeight;
                } else {
                    break;
                }
            }

            return selected;
        }

        private byte[] buildCoinbaseScriptSig() {
            // ç®€åŒ–å®ç°
            ByteArrayOutputStream bos = new ByteArrayOutputStream();

            // åŒºå—é«˜åº¦ (BIP34)
            int height = 800000;
            bos.write(0x03); // OP_PUSHDATA(3å­—èŠ‚)
            bos.write(height & 0xFF);
            bos.write((height >> 8) & 0xFF);
            bos.write((height >> 16) & 0xFF);

            // é¢å¤–nonceå’Œä»»æ„æ•°æ®
            bos.write(0x08); // 8å­—èŠ‚
            bos.write(new byte[8], 0, 8);

            return bos.toByteArray();
        }

        private byte[] addressToScriptPubKey(String address) {
            // ç®€åŒ–: P2WPKH
            return new byte[22];
        }
    }

    /**
     * çŸ¿æ± ç«¯: å¤„ç†Job Declaration
     */
    public static class JobDeclarationHandler {

        /**
         * éªŒè¯çŸ¿å·¥å£°æ˜çš„ä»»åŠ¡
         */
        public ValidationResult validateJob(DeclareMiningJob job) {
            ValidationResult result = new ValidationResult();

            // 1. éªŒè¯Prev Hashæ˜¯å¦æ˜¯æœ€æ–°çš„
            if (!isLatestPrevHash(job.prevHash)) {
                result.valid = false;
                result.error = "Prev hashå·²è¿‡æœŸ";
                return result;
            }

            // 2. éªŒè¯äº¤æ˜“é€‰æ‹©æ˜¯å¦åˆç†
            long totalFees = 0;
            for (String txId : job.txShortIds) {
                Transaction tx = getTransactionByShortId(txId);
                if (tx == null) {
                    result.valid = false;
                    result.error = "äº¤æ˜“ä¸å­˜åœ¨: " + txId;
                    return result;
                }

                // éªŒè¯äº¤æ˜“æœ‰æ•ˆæ€§
                if (!validateTransaction(tx)) {
                    result.valid = false;
                    result.error = "æ— æ•ˆäº¤æ˜“: " + txId;
                    return result;
                }

                totalFees += tx.getFee();
            }

            result.valid = true;
            result.totalFees = totalFees;
            return result;
        }

        /**
         * å¦‚æœä»»åŠ¡æœ‰æ•ˆ,çŸ¿æ± æ¥å—å¹¶å…è®¸çŸ¿å·¥æŒ–çŸ¿
         */
        public void acceptJob(DeclareMiningJob job) {
            System.out.println("âœ“ çŸ¿æ± æ¥å—çŸ¿å·¥å£°æ˜çš„ä»»åŠ¡");
            System.out.println("  åŒ…å«äº¤æ˜“æ•°: " + job.txShortIds.size());
            System.out.println("  çŸ¿å·¥ä¿ç•™äº¤æ˜“é€‰æ‹©æƒ");
        }

        private boolean isLatestPrevHash(byte[] prevHash) {
            // æ£€æŸ¥æ˜¯å¦æ˜¯é“¾å°–
            return true; // ç®€åŒ–
        }

        private Transaction getTransactionByShortId(String shortId) {
            // ä»mempoolè·å–äº¤æ˜“
            return new Transaction(); // ç®€åŒ–
        }

        private boolean validateTransaction(Transaction tx) {
            // éªŒè¯äº¤æ˜“
            return true; // ç®€åŒ–
        }
    }

    public static class ValidationResult {
        boolean valid;
        String error;
        long totalFees;
    }

    // ç®€åŒ–çš„æ•°æ®ç»“æ„
    public static class Transaction {
        int version;
        List<TxInput> inputs = new ArrayList<>();
        List<TxOutput> outputs = new ArrayList<>();
        int lockTime;

        public long getFee() {
            return 50000; // ç®€åŒ–
        }

        public long getWeight() {
            return 500; // ç®€åŒ–
        }
    }

    public static class TxInput {
        byte[] prevTxId;
        int prevIndex;
        byte[] scriptSig;
        int sequence;
    }

    public static class TxOutput {
        long amount;
        byte[] scriptPubKey;
    }

    public static class Mempool {
        public List<MempoolEntry> getTransactionsSortedByFeeRate() {
            return new ArrayList<>();
        }
    }

    public static class MempoolEntry {
        Transaction transaction;
        double feeRate;
    }

    /**
     * ä½¿ç”¨ç¤ºä¾‹
     */
    public static void main(String[] args) {
        System.out.println("=== Job Declarationç¤ºä¾‹ ===\n");

        System.out.println("ä¼ ç»ŸStratum V1:");
        System.out.println("  çŸ¿æ± : é€‰æ‹©æ‰€æœ‰äº¤æ˜“");
        System.out.println("  çŸ¿å·¥: è¢«åŠ¨æ¥å—");
        System.out.println("  é—®é¢˜: çŸ¿æ± å¯ä»¥å®¡æŸ¥äº¤æ˜“");
        System.out.println();

        System.out.println("Stratum V2 + Job Declaration:");
        System.out.println("  çŸ¿å·¥: è‡ªä¸»é€‰æ‹©äº¤æ˜“");
        System.out.println("  çŸ¿æ± : éªŒè¯é€‰æ‹©æ˜¯å¦åˆç†");
        System.out.println("  ä¼˜åŠ¿: å»ä¸­å¿ƒåŒ–,æŠ—å®¡æŸ¥");
        System.out.println();

        // æ¨¡æ‹ŸJob Declaration
        DeclareMiningJob job = new DeclareMiningJob();
        job.requestId = 1;
        job.prevHash = new byte[32];
        job.txShortIds = Arrays.asList("tx001", "tx002", "tx003");
        job.minNTime = (int)(System.currentTimeMillis() / 1000);
        job.version = 0x20000000;

        JobDeclarationHandler handler = new JobDeclarationHandler();
        ValidationResult result = handler.validateJob(job);

        if (result.valid) {
            handler.acceptJob(job);
            System.out.println("\nâœ… çŸ¿å·¥è·å¾—äº¤æ˜“é€‰æ‹©æƒ!");
            System.out.println("   è¿™æ˜¯Stratum V2çš„é‡å¤§è¿›æ­¥");
        }
    }
}
```

## 4. çŸ¿æ± æ”¶ç›Šåˆ†é…æ¨¡å‹

### 4.1 å¸¸è§åˆ†é…æ¨¡å‹

```java
/**
 * çŸ¿æ± æ”¶ç›Šåˆ†é…æ¨¡å‹
 */
public class PoolPayoutModels {

    /**
     * PPS (Pay Per Share) - æŒ‰ä»½é¢æ”¯ä»˜
     *
     * ç‰¹ç‚¹:
     * - çŸ¿å·¥æäº¤Shareå³è·å¾—å›ºå®šæ”¶ç›Š
     * - çŸ¿æ± æ‰¿æ‹…æ‰€æœ‰æ–¹å·®é£é™©
     * - æ”¶ç›Šç¨³å®š,ä½†çŸ¿æ± æ‰‹ç»­è´¹è¾ƒé«˜(3-5%)
     */
    public static class PPSModel {

        public double calculatePayout(
                long sharesSubmitted,
                double networkDifficulty,
                double shareDifficulty,
                double blockReward) {

            // å•ä¸ªShareçš„ç†è®ºä»·å€¼
            double shareValue = (shareDifficulty / networkDifficulty) * blockReward;

            // çŸ¿å·¥æ”¶ç›Š (æ‰£é™¤æ‰‹ç»­è´¹)
            double fee = 0.04; // 4%æ‰‹ç»­è´¹
            double payout = sharesSubmitted * shareValue * (1 - fee);

            return payout;
        }

        public void example() {
            System.out.println("=== PPSæ¨¡å‹ç¤ºä¾‹ ===\n");

            long shares = 10000;
            double netDiff = 60_000_000_000_000.0;
            double shareDiff = 1_000_000.0;
            double reward = 6.25;

            double payout = calculatePayout(shares, netDiff, shareDiff, reward);

            System.out.println("æäº¤Shares: " + String.format("%,d", shares));
            System.out.println("å•Shareä»·å€¼: " +
                String.format("%.8f BTC", (shareDiff/netDiff)*reward));
            System.out.println("çŸ¿å·¥æ”¶ç›Š: " + String.format("%.8f BTC", payout));
            System.out.println();

            System.out.println("âœ“ ä¼˜ç‚¹: æ”¶ç›Šç¨³å®š,æ— æ–¹å·®");
            System.out.println("âœ— ç¼ºç‚¹: æ‰‹ç»­è´¹è¾ƒé«˜");
        }
    }

    /**
     * PPLNS (Pay Per Last N Shares) - æŒ‰æœ€è¿‘Nä¸ªä»½é¢æ”¯ä»˜
     *
     * ç‰¹ç‚¹:
     * - åªæœ‰åœ¨æ‰¾åˆ°åŒºå—åæ‰æ”¯ä»˜
     * - è®¡ç®—æœ€è¿‘Nä¸ªSharesçš„è´¡çŒ®
     * - çŸ¿å·¥å’ŒçŸ¿æ± å…±æ‹…æ–¹å·®é£é™©
     * - æ‰‹ç»­è´¹è¾ƒä½(1-2%)
     */
    public static class PPLNSModel {
        private static final long N = 100000000; // çª—å£å¤§å°

        private Queue<ShareRecord> recentShares = new LinkedList<>();

        public void submitShare(String minerId, long difficulty) {
            ShareRecord share = new ShareRecord();
            share.minerId = minerId;
            share.difficulty = difficulty;
            share.timestamp = System.currentTimeMillis();

            recentShares.offer(share);

            // ç§»é™¤è¶…å‡ºçª—å£çš„Shares
            long totalDiff = 0;
            for (ShareRecord s : recentShares) {
                totalDiff += s.difficulty;
            }

            while (totalDiff > N && !recentShares.isEmpty()) {
                ShareRecord removed = recentShares.poll();
                totalDiff -= removed.difficulty;
            }
        }

        public Map<String, Double> distributeReward(double blockReward) {
            Map<String, Double> payouts = new HashMap<>();

            // ç»Ÿè®¡æ¯ä¸ªçŸ¿å·¥çš„è´¡çŒ®
            Map<String, Long> contributions = new HashMap<>();
            long totalDifficulty = 0;

            for (ShareRecord share : recentShares) {
                contributions.put(share.minerId,
                    contributions.getOrDefault(share.minerId, 0L) + share.difficulty);
                totalDifficulty += share.difficulty;
            }

            // æŒ‰æ¯”ä¾‹åˆ†é… (æ‰£é™¤æ‰‹ç»­è´¹)
            double fee = 0.02; // 2%æ‰‹ç»­è´¹
            double distributable = blockReward * (1 - fee);

            for (Map.Entry<String, Long> entry : contributions.entrySet()) {
                double proportion = (double)entry.getValue() / totalDifficulty;
                payouts.put(entry.getKey(), distributable * proportion);
            }

            return payouts;
        }

        public void example() {
            System.out.println("\n=== PPLNSæ¨¡å‹ç¤ºä¾‹ ===\n");

            PPLNSModel pool = new PPLNSModel();

            // æ¨¡æ‹ŸçŸ¿å·¥æäº¤Shares
            for (int i = 0; i < 100; i++) {
                pool.submitShare("miner1", 1000000);
            }
            for (int i = 0; i < 80; i++) {
                pool.submitShare("miner2", 1000000);
            }
            for (int i = 0; i < 60; i++) {
                pool.submitShare("miner3", 1000000);
            }

            System.out.println("çª—å£å†…Shares:");
            System.out.println("  Miner1: 100 shares");
            System.out.println("  Miner2: 80 shares");
            System.out.println("  Miner3: 60 shares");
            System.out.println();

            // æ‰¾åˆ°åŒºå—,åˆ†é…æ”¶ç›Š
            Map<String, Double> payouts = pool.distributeReward(6.25);

            System.out.println("åŒºå—å¥–åŠ±åˆ†é…:");
            for (Map.Entry<String, Double> entry : payouts.entrySet()) {
                System.out.printf("  %s: %.8f BTC%n",
                    entry.getKey(), entry.getValue());
            }
            System.out.println();

            System.out.println("âœ“ ä¼˜ç‚¹: æ‰‹ç»­è´¹ä½,æŠ—è·³æ± ");
            System.out.println("âœ— ç¼ºç‚¹: æ”¶ç›Šæœ‰æ–¹å·®");
        }
    }

    /**
     * FPPS (Full Pay Per Share) - å®Œå…¨æŒ‰ä»½é¢æ”¯ä»˜
     *
     * ç‰¹ç‚¹:
     * - PPS + äº¤æ˜“æ‰‹ç»­è´¹åˆ†é…
     * - æ”¶ç›Š = åŒºå—å¥–åŠ± + å¹³å‡äº¤æ˜“æ‰‹ç»­è´¹
     */
    public static class FPPSModel {

        public double calculatePayout(
                long sharesSubmitted,
                double networkDifficulty,
                double shareDifficulty,
                double blockReward,
                double avgTxFees) {

            double shareValue = (shareDifficulty / networkDifficulty) *
                (blockReward + avgTxFees);

            double fee = 0.025; // 2.5%æ‰‹ç»­è´¹
            double payout = sharesSubmitted * shareValue * (1 - fee);

            return payout;
        }

        public void example() {
            System.out.println("\n=== FPPSæ¨¡å‹ç¤ºä¾‹ ===\n");

            long shares = 10000;
            double netDiff = 60_000_000_000_000.0;
            double shareDiff = 1_000_000.0;
            double reward = 6.25;
            double avgFees = 0.15; // å¹³å‡äº¤æ˜“æ‰‹ç»­è´¹

            double payout = calculatePayout(shares, netDiff, shareDiff, reward, avgFees);
            double ppsOnly = new PPSModel().calculatePayout(
                shares, netDiff, shareDiff, reward);

            System.out.println("FPPSæ”¶ç›Š: " + String.format("%.8f BTC", payout));
            System.out.println("PPSæ”¶ç›Š:  " + String.format("%.8f BTC", ppsOnly));
            System.out.println("é¢å¤–æ”¶ç›Š: " +
                String.format("%.8f BTC (äº¤æ˜“æ‰‹ç»­è´¹)", payout - ppsOnly));
            System.out.println();

            System.out.println("âœ“ ä¼˜ç‚¹: åŒ…å«äº¤æ˜“æ‰‹ç»­è´¹,æ”¶ç›Šæ›´é«˜");
            System.out.println("âœ— ç¼ºç‚¹: æ‰‹ç»­è´¹ä»è¾ƒé«˜");
        }
    }

    public static class ShareRecord {
        String minerId;
        long difficulty;
        long timestamp;
    }

    /**
     * ä½¿ç”¨ç¤ºä¾‹
     */
    public static void main(String[] args) {
        new PPSModel().example();
        new PPLNSModel().example();
        new FPPSModel().example();

        System.out.println("\n=== æ¨¡å‹å¯¹æ¯” ===\n");
        System.out.println("| æ¨¡å‹  | æ‰‹ç»­è´¹ | æ–¹å·® | æŠ—è·³æ±  | é€‚ç”¨åœºæ™¯ |");
        System.out.println("|-------|--------|------|--------|----------|");
        System.out.println("| PPS   | é«˜(4%) | æ—    | å¼±     | è¿½æ±‚ç¨³å®š |");
        System.out.println("| PPLNS | ä½(2%) | æœ‰   | å¼º     | é•¿æœŸæŒ–çŸ¿ |");
        System.out.println("| FPPS  | ä¸­(2.5%)| æ—    | å¼±     | ç»¼åˆè€ƒè™‘ |");
    }
}
```

### 4.2 æ”¯ä»˜é˜ˆå€¼å’Œå‘¨æœŸ

```java
/**
 * çŸ¿æ± æ”¯ä»˜ç®¡ç†
 */
public class PoolPaymentManager {

    private Map<String, Double> minerBalances = new HashMap<>();
    private double paymentThreshold = 0.001; // æœ€ä½æ”¯ä»˜é˜ˆå€¼
    private int paymentInterval = 86400; // æ”¯ä»˜å‘¨æœŸ(ç§’)

    /**
     * ç´¯ç§¯çŸ¿å·¥æ”¶ç›Š
     */
    public void creditMiner(String minerId, double amount) {
        double current = minerBalances.getOrDefault(minerId, 0.0);
        minerBalances.put(minerId, current + amount);

        System.out.printf("çŸ¿å·¥ %s ç´¯ç§¯æ”¶ç›Š: %.8f BTC%n", minerId, current + amount);
    }

    /**
     * å¤„ç†æ”¯ä»˜
     */
    public void processPayments() {
        System.out.println("\n=== å¤„ç†æ”¯ä»˜ ===\n");

        List<Payment> payments = new ArrayList<>();

        for (Map.Entry<String, Double> entry : minerBalances.entrySet()) {
            String minerId = entry.getKey();
            double balance = entry.getValue();

            if (balance >= paymentThreshold) {
                Payment payment = new Payment();
                payment.minerId = minerId;
                payment.amount = balance;
                payment.address = getMinerAddress(minerId);
                payment.timestamp = System.currentTimeMillis();

                payments.add(payment);

                // æ¸…é›¶ä½™é¢
                minerBalances.put(minerId, 0.0);
            }
        }

        if (payments.isEmpty()) {
            System.out.println("æ²¡æœ‰è¾¾åˆ°æ”¯ä»˜é˜ˆå€¼çš„çŸ¿å·¥");
            return;
        }

        // æ‰¹é‡æ”¯ä»˜
        Transaction payoutTx = buildBatchPayoutTransaction(payments);

        System.out.println("æ‰¹é‡æ”¯ä»˜äº¤æ˜“:");
        System.out.println("  è¾“å‡ºæ•°: " + payments.size());
        System.out.println("  æ€»é‡‘é¢: " +
            String.format("%.8f BTC", payments.stream()
                .mapToDouble(p -> p.amount).sum()));

        // å¹¿æ’­äº¤æ˜“
        broadcastTransaction(payoutTx);
    }

    /**
     * æ„å»ºæ‰¹é‡æ”¯ä»˜äº¤æ˜“
     */
    private Transaction buildBatchPayoutTransaction(List<Payment> payments) {
        Transaction tx = new Transaction();
        tx.version = 2;

        // è¾“å…¥(æ¥è‡ªçŸ¿æ± çƒ­é’±åŒ…)
        TxInput input = new TxInput();
        input.prevTxId = new byte[32];
        input.prevIndex = 0;
        input.sequence = 0xFFFFFFFF;
        tx.inputs.add(input);

        // è¾“å‡º(æ¯ä¸ªçŸ¿å·¥ä¸€ä¸ª)
        for (Payment payment : payments) {
            TxOutput output = new TxOutput();
            output.amount = (long)(payment.amount * 100_000_000); // è½¬æ¢ä¸ºèª
            output.scriptPubKey = addressToScriptPubKey(payment.address);
            tx.outputs.add(output);
        }

        tx.lockTime = 0;

        return tx;
    }

    private String getMinerAddress(String minerId) {
        return "bc1q" + minerId + "address";
    }

    private byte[] addressToScriptPubKey(String address) {
        return new byte[22]; // ç®€åŒ–
    }

    private void broadcastTransaction(Transaction tx) {
        System.out.println("âœ“ äº¤æ˜“å·²å¹¿æ’­");
    }

    public static class Payment {
        String minerId;
        double amount;
        String address;
        long timestamp;
    }

    public static class Transaction {
        int version;
        List<TxInput> inputs = new ArrayList<>();
        List<TxOutput> outputs = new ArrayList<>();
        int lockTime;
    }

    public static class TxInput {
        byte[] prevTxId;
        int prevIndex;
        int sequence;
    }

    public static class TxOutput {
        long amount;
        byte[] scriptPubKey;
    }

    /**
     * ä½¿ç”¨ç¤ºä¾‹
     */
    public static void main(String[] args) {
        System.out.println("=== çŸ¿æ± æ”¯ä»˜ç®¡ç†ç¤ºä¾‹ ===\n");

        PoolPaymentManager manager = new PoolPaymentManager();

        // æ¨¡æ‹ŸçŸ¿å·¥æŒ–çŸ¿æ”¶ç›Š
        manager.creditMiner("miner1", 0.0005);
        manager.creditMiner("miner2", 0.0012);
        manager.creditMiner("miner3", 0.00008);

        System.out.println();

        // å¤„ç†æ”¯ä»˜
        manager.processPayments();

        System.out.println();
        System.out.println("ğŸ’¡ è¯´æ˜:");
        System.out.println("- Miner1æœªè¾¾é˜ˆå€¼(0.0005 < 0.001),ä¸æ”¯ä»˜");
        System.out.println("- Miner2å·²æ”¯ä»˜: 0.0012 BTC");
        System.out.println("- Miner3æœªè¾¾é˜ˆå€¼,ä¸æ”¯ä»˜");
    }
}
```

## 5. çŸ¿æ± MEV (Miner Extractable Value)

### 5.1 ä»€ä¹ˆæ˜¯MEV

MEVæŒ‡çŸ¿å·¥é€šè¿‡é‡æ–°æ’åºã€æ’å…¥æˆ–å®¡æŸ¥äº¤æ˜“æ¥è·å–é¢å¤–æ”¶ç›Š:

```java
/**
 * çŸ¿æ± MEVç¤ºä¾‹
 */
public class MiningPoolMEV {

    /**
     * äº¤æ˜“æ’åºä¼˜åŒ–
     */
    public static class TransactionOrdering {

        /**
         * ç®€å•ç­–ç•¥: æŒ‰æ‰‹ç»­è´¹ç‡æ’åº
         */
        public List<Transaction> orderByFeeRate(List<Transaction> txs) {
            List<Transaction> sorted = new ArrayList<>(txs);
            sorted.sort((a, b) -> Double.compare(b.getFeeRate(), a.getFeeRate()));
            return sorted;
        }

        /**
         * MEVç­–ç•¥: è¯†åˆ«å¥—åˆ©æœºä¼š
         */
        public List<Transaction> orderWithMEV(List<Transaction> txs) {
            List<Transaction> ordered = new ArrayList<>();

            // 1. è¯†åˆ«é«˜ä»·å€¼äº¤æ˜“
            Transaction arbitrage = findArbitrageOpportunity(txs);
            if (arbitrage != null) {
                // åœ¨å¥—åˆ©äº¤æ˜“å‰æ’å…¥çŸ¿å·¥çš„äº¤æ˜“
                Transaction frontRun = createFrontRunTransaction(arbitrage);
                ordered.add(frontRun);
                ordered.add(arbitrage);

                // åœ¨å¥—åˆ©äº¤æ˜“åæ’å…¥çŸ¿å·¥çš„å¹³ä»“äº¤æ˜“
                Transaction backRun = createBackRunTransaction(arbitrage);
                ordered.add(backRun);

                System.out.println("å‘ç°MEVæœºä¼š:");
                System.out.println("  å¥—åˆ©äº¤æ˜“æ‰‹ç»­è´¹: " +
                    String.format("%.8f BTC", arbitrage.getFee()));
                System.out.println("  çŸ¿å·¥é¢å¤–æ”¶ç›Š: " +
                    String.format("%.8f BTC", 0.01)); // ç¤ºä¾‹
            }

            // 2. å…¶ä½™äº¤æ˜“æŒ‰æ‰‹ç»­è´¹æ’åº
            txs.removeAll(ordered);
            ordered.addAll(orderByFeeRate(txs));

            return ordered;
        }

        private Transaction findArbitrageOpportunity(List<Transaction> txs) {
            // ç®€åŒ–: å¯»æ‰¾DEXå¥—åˆ©äº¤æ˜“
            for (Transaction tx : txs) {
                if (tx.getData().contains("swap") && tx.getFee() > 0.001) {
                    return tx;
                }
            }
            return null;
        }

        private Transaction createFrontRunTransaction(Transaction target) {
            // çŸ¿å·¥åœ¨ç›®æ ‡äº¤æ˜“å‰æ’å…¥è‡ªå·±çš„äº¤æ˜“
            Transaction tx = new Transaction();
            tx.setData("frontrun:" + target.getTxId());
            tx.setFee(target.getFee() * 1.1); // æ›´é«˜çš„æ‰‹ç»­è´¹
            return tx;
        }

        private Transaction createBackRunTransaction(Transaction target) {
            // çŸ¿å·¥åœ¨ç›®æ ‡äº¤æ˜“åå¹³ä»“
            Transaction tx = new Transaction();
            tx.setData("backrun:" + target.getTxId());
            return tx;
        }
    }

    /**
     * äº¤æ˜“
     */
    public static class Transaction {
        private String txId;
        private long size;
        private double fee;
        private String data;

        public double getFeeRate() {
            return fee / size * 100_000_000; // sat/vB
        }

        public double getFee() {
            return fee;
        }

        public String getTxId() {
            return txId;
        }

        public String getData() {
            return data != null ? data : "";
        }

        public void setData(String data) {
            this.data = data;
        }

        public void setFee(double fee) {
            this.fee = fee;
        }
    }

    /**
     * ä½¿ç”¨ç¤ºä¾‹
     */
    public static void main(String[] args) {
        System.out.println("=== çŸ¿æ± MEVç¤ºä¾‹ ===\n");

        // åˆ›å»ºäº¤æ˜“æ± 
        List<Transaction> txs = new ArrayList<>();

        Transaction tx1 = new Transaction();
        tx1.txId = "tx001";
        tx1.size = 250;
        tx1.fee = 0.0001;
        txs.add(tx1);

        Transaction tx2 = new Transaction();
        tx2.txId = "tx002";
        tx2.size = 300;
        tx2.fee = 0.0015;
        tx2.data = "swap(ETH, BTC, 100)"; // å¥—åˆ©äº¤æ˜“
        txs.add(tx2);

        Transaction tx3 = new Transaction();
        tx3.txId = "tx003";
        tx3.size = 200;
        tx3.fee = 0.0002;
        txs.add(tx3);

        TransactionOrdering ordering = new TransactionOrdering();

        // æ™®é€šæ’åº
        System.out.println("1ï¸âƒ£  æ™®é€šæ’åº (æŒ‰æ‰‹ç»­è´¹ç‡):");
        List<Transaction> normal = ordering.orderByFeeRate(new ArrayList<>(txs));
        for (Transaction tx : normal) {
            System.out.printf("  %s: %.8f BTC (%.2f sat/vB)%n",
                tx.txId, tx.fee, tx.getFeeRate());
        }
        System.out.println();

        // MEVä¼˜åŒ–
        System.out.println("2ï¸âƒ£  MEVä¼˜åŒ–:");
        List<Transaction> mev = ordering.orderWithMEV(new ArrayList<>(txs));
        for (int i = 0; i < mev.size(); i++) {
            Transaction tx = mev.get(i);
            System.out.printf("  [%d] %s: %s%n",
                i, tx.txId != null ? tx.txId : "miner_tx", tx.data);
        }
        System.out.println();

        System.out.println("ğŸ’¡ MEVäº‰è®®:");
        System.out.println("  âœ“ çŸ¿å·¥æ”¶ç›Šæœ€å¤§åŒ–");
        System.out.println("  âœ— å¯¹æ™®é€šç”¨æˆ·ä¸å…¬å¹³");
        System.out.println("  âœ— å¯èƒ½å¯¼è‡´ç½‘ç»œæ‹¥å µ");
        System.out.println();

        System.out.println("âš ï¸  Stratum V2çš„Job Declarationå¯ä»¥ç¼“è§£MEV:");
        System.out.println("  - çŸ¿å·¥è‡ªä¸»é€‰æ‹©äº¤æ˜“");
        System.out.println("  - çŸ¿æ± æ— æ³•å¼ºåˆ¶æ’å…¥MEVäº¤æ˜“");
    }
}
```

## 6. å»ä¸­å¿ƒåŒ–çŸ¿æ± 

### 6.1 P2Poolæ¦‚å¿µ

```mermaid
graph TB
    A[ä¼ ç»ŸçŸ¿æ± ] --> A1[ä¸­å¿ƒåŒ–æœåŠ¡å™¨]
    A --> A2[çŸ¿å·¥æ— æ§åˆ¶æƒ]
    A --> A3[å•ç‚¹æ•…éšœ]

    B[P2Pool] --> B1[P2Pç½‘ç»œ]
    B --> B2[çŸ¿å·¥å®Œå…¨æ§åˆ¶]
    B --> B3[æ— å•ç‚¹æ•…éšœ]

    B1 --> C[Share Chain]
    C --> C1[æ¯30ç§’ä¸€ä¸ªShareåŒºå—]
    C --> C2[çŸ¿å·¥éªŒè¯Share]
    C --> C3[å»ä¸­å¿ƒåŒ–æ”¯ä»˜]
```

```java
/**
 * P2Pool - å»ä¸­å¿ƒåŒ–çŸ¿æ± 
 */
public class P2Pool {

    /**
     * Share ChainåŒºå—
     */
    public static class ShareBlock {
        private byte[] prevShareHash;  // å‰ä¸€ä¸ªShareåŒºå—
        private byte[] bitcoinBlockHash; // å¯¹åº”çš„æ¯”ç‰¹å¸åŒºå—
        private List<Output> outputs;   // æ”¯ä»˜è¾“å‡º
        private long timestamp;
        private int nonce;

        /**
         * æ„å»ºShare Chain Coinbase
         */
        public Transaction buildCoinbase(
                List<MinerShare> recentShares,
                double blockReward) {

            Transaction coinbase = new Transaction();

            // è¾“å…¥
            TxInput input = new TxInput();
            input.prevTxId = new byte[32];
            input.prevIndex = 0xFFFFFFFF;
            coinbase.inputs.add(input);

            // è¾“å‡º: æŒ‰æœ€è¿‘Nä¸ªSharesåˆ†é…
            Map<String, Double> distribution =
                calculateDistribution(recentShares, blockReward);

            for (Map.Entry<String, Double> entry : distribution.entrySet()) {
                TxOutput output = new TxOutput();
                output.amount = (long)(entry.getValue() * 100_000_000);
                output.scriptPubKey = addressToScriptPubKey(entry.getKey());
                coinbase.outputs.add(output);
            }

            return coinbase;
        }

        /**
         * è®¡ç®—æ”¶ç›Šåˆ†é… (PPLNS)
         */
        private Map<String, Double> calculateDistribution(
                List<MinerShare> shares,
                double reward) {

            Map<String, Long> contributions = new HashMap<>();
            long total = 0;

            for (MinerShare share : shares) {
                contributions.put(share.minerAddress,
                    contributions.getOrDefault(share.minerAddress, 0L) +
                    share.difficulty);
                total += share.difficulty;
            }

            Map<String, Double> distribution = new HashMap<>();
            for (Map.Entry<String, Long> entry : contributions.entrySet()) {
                double proportion = (double)entry.getValue() / total;
                distribution.put(entry.getKey(), reward * proportion);
            }

            return distribution;
        }

        private byte[] addressToScriptPubKey(String address) {
            return new byte[22];
        }
    }

    public static class MinerShare {
        String minerAddress;
        long difficulty;
        long timestamp;
    }

    public static class Output {
        String address;
        double amount;
    }

    public static class Transaction {
        List<TxInput> inputs = new ArrayList<>();
        List<TxOutput> outputs = new ArrayList<>();
    }

    public static class TxInput {
        byte[] prevTxId;
        int prevIndex;
    }

    public static class TxOutput {
        long amount;
        byte[] scriptPubKey;
    }

    /**
     * ä½¿ç”¨ç¤ºä¾‹
     */
    public static void main(String[] args) {
        System.out.println("=== P2Poolç¤ºä¾‹ ===\n");

        System.out.println("P2Poolå·¥ä½œåŸç†:");
        System.out.println("1. çŸ¿å·¥åœ¨æœ¬åœ°è¿è¡Œå®Œæ•´èŠ‚ç‚¹");
        System.out.println("2. Share Chainè®°å½•æ¯ä¸ªçŸ¿å·¥çš„è´¡çŒ®");
        System.out.println("3. æ‰¾åˆ°æ¯”ç‰¹å¸åŒºå—æ—¶,è‡ªåŠ¨æŒ‰Share Chainåˆ†é…æ”¶ç›Š");
        System.out.println();

        System.out.println("ä¼˜åŠ¿:");
        System.out.println("âœ“ å®Œå…¨å»ä¸­å¿ƒåŒ–");
        System.out.println("âœ“ çŸ¿å·¥ä¿ç•™äº¤æ˜“é€‰æ‹©æƒ");
        System.out.println("âœ“ æ— éœ€ä¿¡ä»»çŸ¿æ± è¿è¥å•†");
        System.out.println("âœ“ 0%æ‰‹ç»­è´¹");
        System.out.println();

        System.out.println("æŒ‘æˆ˜:");
        System.out.println("âœ— éœ€è¦è¿è¡Œå®Œæ•´èŠ‚ç‚¹");
        System.out.println("âœ— æŠ€æœ¯é—¨æ§›è¾ƒé«˜");
        System.out.println("âœ— æ”¶ç›Šæ–¹å·®ç•¥å¤§");
    }
}
```

## 7. ç›¸å…³æ–‡æ¡£

- [04.æ¯”ç‰¹å¸æŒ–çŸ¿åŸç†.md](./04.æ¯”ç‰¹å¸æŒ–çŸ¿åŸç†.md) - æŒ–çŸ¿åŸºç¡€
- [12.æ¯”ç‰¹å¸å…±è¯†æœºåˆ¶è¯¦è§£.md](./12.æ¯”ç‰¹å¸å…±è¯†æœºåˆ¶è¯¦è§£.md) - PoWå…±è¯†
- [22.æ¯”ç‰¹å¸èŠ‚ç‚¹è¿ç»´å®æˆ˜.md](./22.æ¯”ç‰¹å¸èŠ‚ç‚¹è¿ç»´å®æˆ˜.md) - èŠ‚ç‚¹è¿ç»´

## 8. å‚è€ƒèµ„æ–™

- [Stratum V2è§„èŒƒ](https://github.com/stratum-mining/sv2-spec)
- [P2Poolæ–‡æ¡£](https://github.com/p2pool/p2pool)
- [çŸ¿æ± å¯¹æ¯”](https://miningpoolstats.stream/bitcoin)