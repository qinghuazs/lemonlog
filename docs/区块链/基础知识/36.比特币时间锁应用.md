---
title: 比特币时间锁应用
date: 2025-09-30
permalink: /blockchain/bitcoin-timelock.html
tags:
  - 区块链
  - 比特币
  - 时间锁
  - CLTV
  - CSV
categories:
  - 区块链
  - 比特币基础
---

# 比特币时间锁应用

## 1. 时间锁基础

### 1.1 时间锁类型

比特币支持两种时间锁机制：

| 类型 | 名称 | 作用域 | 用途 |
|-----|------|-------|------|
| nLockTime | 交易级时间锁 | 整个交易 | 延迟交易广播 |
| nSequence | 输入级时间锁 | 单个输入 | 相对时间锁(CSV) |
| OP_CLTV | 脚本级绝对时间锁 | 脚本 | 特定时间后可花费 |
| OP_CSV | 脚本级相对时间锁 | 脚本 | 确认后N个块可花费 |

**时间表示方式**：
- `< 500000000`: 区块高度
- `≥ 500000000`: Unix时间戳

### 1.2 应用场景

- ⏰ **定时释放**：工资、遗产继承
- 🔐 **托管服务**：第三方仲裁
- ⚡ **闪电网络**：HTLC超时退款
- 🎁 **定时礼物**：生日、纪念日
- 💰 **定期支付**：订阅、分期付款

## 2. nLockTime实现

交易级时间锁，使整个交易在指定时间前无法被矿工打包。

```java
public class NLockTimeTransaction {
    
    public static Transaction createTimeLocked(
            String fromAddress,
            String toAddress, 
            double amount,
            long unlockTime) {
        
        Transaction tx = new Transaction();
        tx.version = 2;
        tx.lockTime = (int)unlockTime; // 区块高度或时间戳
        
        // 输入
        TxInput input = new TxInput();
        input.prevTxId = new byte[32];
        input.prevIndex = 0;
        input.sequence = 0xFFFFFFFE; // 必须<0xFFFFFFFF才能启用nLockTime
        tx.inputs.add(input);
        
        // 输出
        TxOutput output = new TxOutput();
        output.amount = (long)(amount * 100_000_000);
        output.scriptPubKey = addressToScript(toAddress);
        tx.outputs.add(output);
        
        System.out.println("创建nLockTime交易:");
        System.out.println("  解锁时间: " + (unlockTime < 500000000 ? 
            "区块" + unlockTime : "时间戳" + unlockTime));
        
        return tx;
    }
    
    private static byte[] addressToScript(String addr) {
        return new byte[25];
    }
}
```

## 3. OP_CLTV (绝对时间锁)

### 3.1 CLTV原理

OP_CHECKLOCKTIMEVERIFY (BIP65)：要求交易的nLockTime不早于栈顶值。

**脚本示例**：
```
<timestamp> OP_CHECKLOCKTIMEVERIFY OP_DROP <pubkey> OP_CHECKSIG
```

### 3.2 定时遗产继承

```java
public class InheritanceWithCLTV {
    
    /**
     * 创建遗产继承脚本
     * - 所有者随时可花费
     * - 1年后继承人可花费
     */
    public static byte[] createInheritanceScript(
            String ownerPubKey,
            String heirPubKey,
            long inheritTime) {
        
        ByteArrayOutputStream script = new ByteArrayOutputStream();
        
        // IF分支: 所有者立即花费
        script.write(0x63); // OP_IF
        script.write(ownerPubKey.getBytes());
        script.write(0xAC); // OP_CHECKSIG
        
        // ELSE分支: 继承人1年后花费  
        script.write(0x67); // OP_ELSE
        writeLockTime(script, inheritTime);
        script.write(0xB1); // OP_CHECKLOCKTIMEVERIFY
        script.write(0x75); // OP_DROP
        script.write(heirPubKey.getBytes());
        script.write(0xAC); // OP_CHECKSIG
        
        script.write(0x68); // OP_ENDIF
        
        System.out.println("遗产继承脚本:");
        System.out.println("  所有者: 随时可花费");
        System.out.println("  继承人: " + new java.util.Date(inheritTime * 1000) + " 后可花费");
        
        return script.toByteArray();
    }
    
    private static void writeLockTime(ByteArrayOutputStream bos, long time) {
        bos.write((int)(time & 0xFF));
        bos.write((int)((time >> 8) & 0xFF));
        bos.write((int)((time >> 16) & 0xFF));
        bos.write((int)((time >> 24) & 0xFF));
    }
}
```

## 4. OP_CSV (相对时间锁)

### 4.1 CSV原理

OP_CHECKSEQUENCEVERIFY (BIP112)：相对于输入的确认时间。

**时间单位**：
- `bit 22 = 0`: 区块数量
- `bit 22 = 1`: 512秒的倍数

### 4.2 闪电网络HTLC

```java
public class LightningHTLC {
    
    /**
     * 创建HTLC脚本 (闪电网络核心)
     */
    public static byte[] createHTLCScript(
            byte[] paymentHash,
            String senderPubKey,
            String receiverPubKey,
            int timeout) { // CSV相对时间
        
        ByteArrayOutputStream script = new ByteArrayOutputStream();
        
        // IF分支: 接收方用preimage解锁
        script.write(0x63); // OP_IF
        script.write(0xA8); // OP_SHA256
        script.write(0x20); // 32字节
        script.write(paymentHash, 0, 32);
        script.write(0x88); // OP_EQUALVERIFY
        script.write(receiverPubKey.getBytes());
        script.write(0xAC); // OP_CHECKSIG
        
        // ELSE分支: 发送方超时退款
        script.write(0x67); // OP_ELSE
        writeSequence(script, timeout);
        script.write(0xB2); // OP_CHECKSEQUENCEVERIFY
        script.write(0x75); // OP_DROP
        script.write(senderPubKey.getBytes());
        script.write(0xAC); // OP_CHECKSIG
        
        script.write(0x68); // OP_ENDIF
        
        System.out.println("HTLC脚本:");
        System.out.println("  接收方: 用preimage立即解锁");
        System.out.println("  发送方: " + timeout + "个区块后退款");
        
        return script.toByteArray();
    }
    
    private static void writeSequence(ByteArrayOutputStream bos, int seq) {
        bos.write(seq & 0xFF);
        bos.write((seq >> 8) & 0xFF);
    }
}
```

## 5. 实战应用

### 5.1 定期工资发放

```java
public class SalaryPayment {
    
    public static List<Transaction> createMonthlySalary(
            String employer,
            String employee,
            double monthlyAmount,
            int months) {
        
        List<Transaction> txs = new ArrayList<>();
        long currentTime = System.currentTimeMillis() / 1000;
        long oneMonth = 30 * 24 * 3600; // 30天
        
        System.out.println("创建" + months + "个月工资交易:\n");
        
        for (int i = 0; i < months; i++) {
            long unlockTime = currentTime + (i + 1) * oneMonth;
            
            Transaction tx = new Transaction();
            tx.version = 2;
            tx.lockTime = (int)unlockTime;
            
            TxInput input = new TxInput();
            input.sequence = 0xFFFFFFFE;
            tx.inputs.add(input);
            
            TxOutput output = new TxOutput();
            output.amount = (long)(monthlyAmount * 100_000_000);
            output.scriptPubKey = new byte[25];
            tx.outputs.add(output);
            
            txs.add(tx);
            
            System.out.printf("第%d月: %.2f BTC, 解锁时间: %s%n",
                i + 1, monthlyAmount, 
                new java.util.Date(unlockTime * 1000));
        }
        
        return txs;
    }
}
```

### 5.2 预付费订阅

```java
public class SubscriptionPayment {
    
    /**
     * 创建可取消的订阅
     */
    public static Transaction createCancellableSubscription(
            String subscriber,
            String service,
            double monthlyFee,
            int refundBlocks) {
        
        Transaction tx = new Transaction();
        
        // 输出到特殊脚本
        TxOutput output = new TxOutput();
        output.amount = (long)(monthlyFee * 100_000_000);
        
        // 脚本: 服务方24小时后可取走, 或用户提前取消
        ByteArrayOutputStream script = new ByteArrayOutputStream();
        
        // IF: 用户取消订阅
        script.write(0x63); // OP_IF
        script.write(subscriber.getBytes());
        script.write(0xAC); // OP_CHECKSIG
        
        // ELSE: 服务方144个块(~24小时)后收款
        script.write(0x67); // OP_ELSE
        writeSequence(script, refundBlocks);
        script.write(0xB2); // OP_CSV
        script.write(0x75); // OP_DROP
        script.write(service.getBytes());
        script.write(0xAC); // OP_CHECKSIG
        script.write(0x68); // OP_ENDIF
        
        output.scriptPubKey = script.toByteArray();
        tx.outputs.add(output);
        
        System.out.println("可取消订阅:");
        System.out.println("  用户: 随时可取消退款");
        System.out.println("  服务: " + refundBlocks + "个块后确认收款");
        
        return tx;
    }
    
    private static void writeSequence(ByteArrayOutputStream bos, int seq) {
        bos.write(seq & 0xFF);
        bos.write((seq >> 8) & 0xFF);
    }
}
```

## 6. 最佳实践

### 6.1 时间锁选择

```
场景                    | 推荐方案
-----------------------|----------
延迟广播交易            | nLockTime
绝对时间解锁            | OP_CLTV  
相对时间解锁            | OP_CSV
闪电网络               | OP_CSV
多签+时间锁            | CLTV/CSV组合
```

### 6.2 安全注意事项

- ⚠️ nSequence必须<0xFFFFFFFF才能启用nLockTime
- ⚠️ CSV需要设置BIP68标志位
- ⚠️ 时间锁交易在解锁前可被替换(RBF)
- ⚠️ 继承脚本建议使用多签+时间锁组合

## 7. 相关文档

- [09.比特币脚本语言详解](./09.比特币脚本语言详解.md)
- [08.闪电网络原理详解](./08.闪电网络原理详解.md)
- [21.比特币智能合约](./21.比特币智能合约.md)

## 8. 参考资料

- [BIP 65: OP_CHECKLOCKTIMEVERIFY](https://github.com/bitcoin/bips/blob/master/bip-0065.mediawiki)
- [BIP 112: OP_CHECKSEQUENCEVERIFY](https://github.com/bitcoin/bips/blob/master/bip-0112.mediawiki)
- [BIP 68: Relative lock-time](https://github.com/bitcoin/bips/blob/master/bip-0068.mediawiki)
