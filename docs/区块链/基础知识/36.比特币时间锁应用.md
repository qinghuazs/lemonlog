---
title: æ¯”ç‰¹å¸æ—¶é—´é”åº”ç”¨
date: 2025-09-30
permalink: /blockchain/bitcoin-timelock.html
tags:
  - åŒºå—é“¾
  - æ¯”ç‰¹å¸
  - æ—¶é—´é”
  - CLTV
  - CSV
categories:
  - åŒºå—é“¾
  - æ¯”ç‰¹å¸åŸºç¡€
---

# æ¯”ç‰¹å¸æ—¶é—´é”åº”ç”¨

## 1. æ—¶é—´é”åŸºç¡€

### 1.1 æ—¶é—´é”ç±»å‹

æ¯”ç‰¹å¸æ”¯æŒä¸¤ç§æ—¶é—´é”æœºåˆ¶ï¼š

| ç±»å‹ | åç§° | ä½œç”¨åŸŸ | ç”¨é€” |
|-----|------|-------|------|
| nLockTime | äº¤æ˜“çº§æ—¶é—´é” | æ•´ä¸ªäº¤æ˜“ | å»¶è¿Ÿäº¤æ˜“å¹¿æ’­ |
| nSequence | è¾“å…¥çº§æ—¶é—´é” | å•ä¸ªè¾“å…¥ | ç›¸å¯¹æ—¶é—´é”(CSV) |
| OP_CLTV | è„šæœ¬çº§ç»å¯¹æ—¶é—´é” | è„šæœ¬ | ç‰¹å®šæ—¶é—´åå¯èŠ±è´¹ |
| OP_CSV | è„šæœ¬çº§ç›¸å¯¹æ—¶é—´é” | è„šæœ¬ | ç¡®è®¤åNä¸ªå—å¯èŠ±è´¹ |

**æ—¶é—´è¡¨ç¤ºæ–¹å¼**ï¼š
- `< 500000000`: åŒºå—é«˜åº¦
- `â‰¥ 500000000`: Unixæ—¶é—´æˆ³

### 1.2 åº”ç”¨åœºæ™¯

- â° **å®šæ—¶é‡Šæ”¾**ï¼šå·¥èµ„ã€é—äº§ç»§æ‰¿
- ğŸ” **æ‰˜ç®¡æœåŠ¡**ï¼šç¬¬ä¸‰æ–¹ä»²è£
- âš¡ **é—ªç”µç½‘ç»œ**ï¼šHTLCè¶…æ—¶é€€æ¬¾
- ğŸ **å®šæ—¶ç¤¼ç‰©**ï¼šç”Ÿæ—¥ã€çºªå¿µæ—¥
- ğŸ’° **å®šæœŸæ”¯ä»˜**ï¼šè®¢é˜…ã€åˆ†æœŸä»˜æ¬¾

## 2. nLockTimeå®ç°

äº¤æ˜“çº§æ—¶é—´é”ï¼Œä½¿æ•´ä¸ªäº¤æ˜“åœ¨æŒ‡å®šæ—¶é—´å‰æ— æ³•è¢«çŸ¿å·¥æ‰“åŒ…ã€‚

```java
public class NLockTimeTransaction {
    
    public static Transaction createTimeLocked(
            String fromAddress,
            String toAddress, 
            double amount,
            long unlockTime) {
        
        Transaction tx = new Transaction();
        tx.version = 2;
        tx.lockTime = (int)unlockTime; // åŒºå—é«˜åº¦æˆ–æ—¶é—´æˆ³
        
        // è¾“å…¥
        TxInput input = new TxInput();
        input.prevTxId = new byte[32];
        input.prevIndex = 0;
        input.sequence = 0xFFFFFFFE; // å¿…é¡»<0xFFFFFFFFæ‰èƒ½å¯ç”¨nLockTime
        tx.inputs.add(input);
        
        // è¾“å‡º
        TxOutput output = new TxOutput();
        output.amount = (long)(amount * 100_000_000);
        output.scriptPubKey = addressToScript(toAddress);
        tx.outputs.add(output);
        
        System.out.println("åˆ›å»ºnLockTimeäº¤æ˜“:");
        System.out.println("  è§£é”æ—¶é—´: " + (unlockTime < 500000000 ? 
            "åŒºå—" + unlockTime : "æ—¶é—´æˆ³" + unlockTime));
        
        return tx;
    }
    
    private static byte[] addressToScript(String addr) {
        return new byte[25];
    }
}
```

## 3. OP_CLTV (ç»å¯¹æ—¶é—´é”)

### 3.1 CLTVåŸç†

OP_CHECKLOCKTIMEVERIFY (BIP65)ï¼šè¦æ±‚äº¤æ˜“çš„nLockTimeä¸æ—©äºæ ˆé¡¶å€¼ã€‚

**è„šæœ¬ç¤ºä¾‹**ï¼š
```
<timestamp> OP_CHECKLOCKTIMEVERIFY OP_DROP <pubkey> OP_CHECKSIG
```

### 3.2 å®šæ—¶é—äº§ç»§æ‰¿

```java
public class InheritanceWithCLTV {
    
    /**
     * åˆ›å»ºé—äº§ç»§æ‰¿è„šæœ¬
     * - æ‰€æœ‰è€…éšæ—¶å¯èŠ±è´¹
     * - 1å¹´åç»§æ‰¿äººå¯èŠ±è´¹
     */
    public static byte[] createInheritanceScript(
            String ownerPubKey,
            String heirPubKey,
            long inheritTime) {
        
        ByteArrayOutputStream script = new ByteArrayOutputStream();
        
        // IFåˆ†æ”¯: æ‰€æœ‰è€…ç«‹å³èŠ±è´¹
        script.write(0x63); // OP_IF
        script.write(ownerPubKey.getBytes());
        script.write(0xAC); // OP_CHECKSIG
        
        // ELSEåˆ†æ”¯: ç»§æ‰¿äºº1å¹´åèŠ±è´¹  
        script.write(0x67); // OP_ELSE
        writeLockTime(script, inheritTime);
        script.write(0xB1); // OP_CHECKLOCKTIMEVERIFY
        script.write(0x75); // OP_DROP
        script.write(heirPubKey.getBytes());
        script.write(0xAC); // OP_CHECKSIG
        
        script.write(0x68); // OP_ENDIF
        
        System.out.println("é—äº§ç»§æ‰¿è„šæœ¬:");
        System.out.println("  æ‰€æœ‰è€…: éšæ—¶å¯èŠ±è´¹");
        System.out.println("  ç»§æ‰¿äºº: " + new java.util.Date(inheritTime * 1000) + " åå¯èŠ±è´¹");
        
        return script.toByteArray();
    }
    
    private static void writeLockTime(ByteArrayOutputStream bos, long time) {
        bos.write((int)(time & 0xFF));
        bos.write((int)((time >> 8) & 0xFF));
        bos.write((int)((time >> 16) & 0xFF));
        bos.write((int)((time >> 24) & 0xFF));
    }
}
```

## 4. OP_CSV (ç›¸å¯¹æ—¶é—´é”)

### 4.1 CSVåŸç†

OP_CHECKSEQUENCEVERIFY (BIP112)ï¼šç›¸å¯¹äºè¾“å…¥çš„ç¡®è®¤æ—¶é—´ã€‚

**æ—¶é—´å•ä½**ï¼š
- `bit 22 = 0`: åŒºå—æ•°é‡
- `bit 22 = 1`: 512ç§’çš„å€æ•°

### 4.2 é—ªç”µç½‘ç»œHTLC

```java
public class LightningHTLC {
    
    /**
     * åˆ›å»ºHTLCè„šæœ¬ (é—ªç”µç½‘ç»œæ ¸å¿ƒ)
     */
    public static byte[] createHTLCScript(
            byte[] paymentHash,
            String senderPubKey,
            String receiverPubKey,
            int timeout) { // CSVç›¸å¯¹æ—¶é—´
        
        ByteArrayOutputStream script = new ByteArrayOutputStream();
        
        // IFåˆ†æ”¯: æ¥æ”¶æ–¹ç”¨preimageè§£é”
        script.write(0x63); // OP_IF
        script.write(0xA8); // OP_SHA256
        script.write(0x20); // 32å­—èŠ‚
        script.write(paymentHash, 0, 32);
        script.write(0x88); // OP_EQUALVERIFY
        script.write(receiverPubKey.getBytes());
        script.write(0xAC); // OP_CHECKSIG
        
        // ELSEåˆ†æ”¯: å‘é€æ–¹è¶…æ—¶é€€æ¬¾
        script.write(0x67); // OP_ELSE
        writeSequence(script, timeout);
        script.write(0xB2); // OP_CHECKSEQUENCEVERIFY
        script.write(0x75); // OP_DROP
        script.write(senderPubKey.getBytes());
        script.write(0xAC); // OP_CHECKSIG
        
        script.write(0x68); // OP_ENDIF
        
        System.out.println("HTLCè„šæœ¬:");
        System.out.println("  æ¥æ”¶æ–¹: ç”¨preimageç«‹å³è§£é”");
        System.out.println("  å‘é€æ–¹: " + timeout + "ä¸ªåŒºå—åé€€æ¬¾");
        
        return script.toByteArray();
    }
    
    private static void writeSequence(ByteArrayOutputStream bos, int seq) {
        bos.write(seq & 0xFF);
        bos.write((seq >> 8) & 0xFF);
    }
}
```

## 5. å®æˆ˜åº”ç”¨

### 5.1 å®šæœŸå·¥èµ„å‘æ”¾

```java
public class SalaryPayment {
    
    public static List<Transaction> createMonthlySalary(
            String employer,
            String employee,
            double monthlyAmount,
            int months) {
        
        List<Transaction> txs = new ArrayList<>();
        long currentTime = System.currentTimeMillis() / 1000;
        long oneMonth = 30 * 24 * 3600; // 30å¤©
        
        System.out.println("åˆ›å»º" + months + "ä¸ªæœˆå·¥èµ„äº¤æ˜“:\n");
        
        for (int i = 0; i < months; i++) {
            long unlockTime = currentTime + (i + 1) * oneMonth;
            
            Transaction tx = new Transaction();
            tx.version = 2;
            tx.lockTime = (int)unlockTime;
            
            TxInput input = new TxInput();
            input.sequence = 0xFFFFFFFE;
            tx.inputs.add(input);
            
            TxOutput output = new TxOutput();
            output.amount = (long)(monthlyAmount * 100_000_000);
            output.scriptPubKey = new byte[25];
            tx.outputs.add(output);
            
            txs.add(tx);
            
            System.out.printf("ç¬¬%dæœˆ: %.2f BTC, è§£é”æ—¶é—´: %s%n",
                i + 1, monthlyAmount, 
                new java.util.Date(unlockTime * 1000));
        }
        
        return txs;
    }
}
```

### 5.2 é¢„ä»˜è´¹è®¢é˜…

```java
public class SubscriptionPayment {
    
    /**
     * åˆ›å»ºå¯å–æ¶ˆçš„è®¢é˜…
     */
    public static Transaction createCancellableSubscription(
            String subscriber,
            String service,
            double monthlyFee,
            int refundBlocks) {
        
        Transaction tx = new Transaction();
        
        // è¾“å‡ºåˆ°ç‰¹æ®Šè„šæœ¬
        TxOutput output = new TxOutput();
        output.amount = (long)(monthlyFee * 100_000_000);
        
        // è„šæœ¬: æœåŠ¡æ–¹24å°æ—¶åå¯å–èµ°, æˆ–ç”¨æˆ·æå‰å–æ¶ˆ
        ByteArrayOutputStream script = new ByteArrayOutputStream();
        
        // IF: ç”¨æˆ·å–æ¶ˆè®¢é˜…
        script.write(0x63); // OP_IF
        script.write(subscriber.getBytes());
        script.write(0xAC); // OP_CHECKSIG
        
        // ELSE: æœåŠ¡æ–¹144ä¸ªå—(~24å°æ—¶)åæ”¶æ¬¾
        script.write(0x67); // OP_ELSE
        writeSequence(script, refundBlocks);
        script.write(0xB2); // OP_CSV
        script.write(0x75); // OP_DROP
        script.write(service.getBytes());
        script.write(0xAC); // OP_CHECKSIG
        script.write(0x68); // OP_ENDIF
        
        output.scriptPubKey = script.toByteArray();
        tx.outputs.add(output);
        
        System.out.println("å¯å–æ¶ˆè®¢é˜…:");
        System.out.println("  ç”¨æˆ·: éšæ—¶å¯å–æ¶ˆé€€æ¬¾");
        System.out.println("  æœåŠ¡: " + refundBlocks + "ä¸ªå—åç¡®è®¤æ”¶æ¬¾");
        
        return tx;
    }
    
    private static void writeSequence(ByteArrayOutputStream bos, int seq) {
        bos.write(seq & 0xFF);
        bos.write((seq >> 8) & 0xFF);
    }
}
```

## 6. æœ€ä½³å®è·µ

### 6.1 æ—¶é—´é”é€‰æ‹©

```
åœºæ™¯                    | æ¨èæ–¹æ¡ˆ
-----------------------|----------
å»¶è¿Ÿå¹¿æ’­äº¤æ˜“            | nLockTime
ç»å¯¹æ—¶é—´è§£é”            | OP_CLTV  
ç›¸å¯¹æ—¶é—´è§£é”            | OP_CSV
é—ªç”µç½‘ç»œ               | OP_CSV
å¤šç­¾+æ—¶é—´é”            | CLTV/CSVç»„åˆ
```

### 6.2 å®‰å…¨æ³¨æ„äº‹é¡¹

- âš ï¸ nSequenceå¿…é¡»<0xFFFFFFFFæ‰èƒ½å¯ç”¨nLockTime
- âš ï¸ CSVéœ€è¦è®¾ç½®BIP68æ ‡å¿—ä½
- âš ï¸ æ—¶é—´é”äº¤æ˜“åœ¨è§£é”å‰å¯è¢«æ›¿æ¢(RBF)
- âš ï¸ ç»§æ‰¿è„šæœ¬å»ºè®®ä½¿ç”¨å¤šç­¾+æ—¶é—´é”ç»„åˆ

## 7. ç›¸å…³æ–‡æ¡£

- [09.æ¯”ç‰¹å¸è„šæœ¬è¯­è¨€è¯¦è§£](./09.æ¯”ç‰¹å¸è„šæœ¬è¯­è¨€è¯¦è§£.md)
- [08.é—ªç”µç½‘ç»œåŸç†è¯¦è§£](./08.é—ªç”µç½‘ç»œåŸç†è¯¦è§£.md)
- [21.æ¯”ç‰¹å¸æ™ºèƒ½åˆçº¦](./21.æ¯”ç‰¹å¸æ™ºèƒ½åˆçº¦.md)

## 8. å‚è€ƒèµ„æ–™

- [BIP 65: OP_CHECKLOCKTIMEVERIFY](https://github.com/bitcoin/bips/blob/master/bip-0065.mediawiki)
- [BIP 112: OP_CHECKSEQUENCEVERIFY](https://github.com/bitcoin/bips/blob/master/bip-0112.mediawiki)
- [BIP 68: Relative lock-time](https://github.com/bitcoin/bips/blob/master/bip-0068.mediawiki)
