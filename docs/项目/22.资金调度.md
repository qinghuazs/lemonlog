---
title: 资金调度
date: 2025/08/06
permalink: /project/fundtransfer.html
tags:
  - 项目
categories:
  - 项目
---

## 客户群体

资金调度主要面向大型的国企央企客户，这些企业通常具有组织结构复杂、分支机构众多、资金流动量大且频繁的特点。资金调度用于协调和管理集团内部不同法人实体之间的资金流动。该系统的主要功能包括资金归集、资金下拨和资金调拨。



客户特征：
- 组织结构复杂，层级较多
- 分支机构众多，地域分布广泛
- 资金流动量大且频繁
- 多法人实体并存
- 跨地域经营模式

资金调度服务能够解决集团内部资金分散、利用率低的痛点，通过集中管理母子公司之间的资金流动，实现集团整体资金效益最大化。特别是跨地域经营的企业集团，资金调度服务能有效协调不同地区、不同法人实体间的资金需求，降低整体财务成本。

## 解决的核心问题

资金分散问题
- 集团内部资金分布不均，部分子公司资金闲置，部分资金紧张
- 缺乏统一的资金管理视角
资金利用率低
- 无法实现集团层面的资金统筹配置
管理效率低下
- 手工操作多，调度决策缺乏数据支持
- 资金调度流程复杂，审批周期长
风险控制不足
- 缺乏实时的资金监控机制
- 资金安全管理存在漏洞


核心功能点：

- 资金归集 
- 资金下拨
- 资金调拨

## 重构 

S：为什么要重构：
1. 上下游数据一致性问题：各种try-catch导致异常被吃掉，导致分布式事务失效，触发异常时，无法回滚，导致数据不一致
2. 审批超时问题：从A单结算单-下拨付款单-内部账户预占-B单待结算数据，长事务，其中还有各种校验，如授信协议校验、余额校验、发送事项凭证等
3. 线程池问题：主子任务共用一个线程池，存在线程死锁风险
4. 重复代码多，下拨付款单四种来源，有很多的重复代码，整个service类3000多行代码，维护很麻烦
5. 事件中心采用的推模型，大数据量时，会把下游服务打崩，主要是数据库连接沾满
6. 工单量大：工单每个月大概70左右

T：重构的目标：
1. 代码质量提升：通过重构，提高代码的质量，减少重复代码，提高代码的可维护性
2. 性能优化：通过重构，优化代码的性能，提高系统的吞吐量
4. 每月工单量降低到个位数

重构的阻碍：
1. 业务不熟悉，重构之前需要对业务有一个全面的了解，才能知道哪些地方需要重构、如何重构
2. 写代码的人都离职了，很多逻辑看不懂，且感觉代码逻辑和业务逻辑明显不匹配
3. 时间上，随着项目量的增多，项目上每周都有工单过来，需要给用户修复数据，占用了开发时间

A：重构的动作：
1. 拉通测试、产品和用户，明确每个功能点的应用场景和业务流程，精确到每个字段都有什么作用
2. 针对业务流程，结合工单，进行代码逻辑梳理，形成文档和流程图
3. 基于文档和流程图，对模块进行二次设计，提取公共点、可优化点等，比如以前的下拨付款单预占是在推送结算成功后进行的 ，现在改为在下拨付款单创建时就进行预占，避免因为推送结算超时导致预占的回滚，降低业务的复杂度
4. 基于策略模式，针对各种来源、生单方式进行策略的编写，提取公共的逻辑，比如预占、授信校验、凭证发送、推送资金结算等，都是公共的，减少重复代码
5. 长事务拆分：A单-下拨付款单-预占一个事务，下拨付款单推送资金结算新事务，更新状态一个事务，状态更新后生成下拨收款单一个事务，下拨收款单推送资金结算新事务
6. 长事务拆分后，再针对分布式事务问题进行处理，去掉大量的try-catch，该抛异常抛异常，然后进行分布式事务回滚；回滚接口中，只回滚本地事务；同时用上下文来绑定正向接口中生成的下拨付款单id，进行精准删除
7. 主子任务使用不同的线程池
8. 推模型修改为拉取模型
9. 测试阶段拉通上下游配合，进行打桩测试，验证各种异常情况，测试分布式事务
10. 项目试点：基于河北建工项目进行项目试点，基于试点结果进行功能优化
11. 逐步推广


R：达成的结果
1. 每月的工单量降到5以内
2. 下拨付款单的service从原来的3000多行代码，减少到1000多行代码
3. 下拨付款单的四种来源，都抽取为策略模式，减少了重复代码，提高了可维护性